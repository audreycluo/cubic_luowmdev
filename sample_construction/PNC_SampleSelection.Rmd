---
title: "PNC Sample Selection"
author: "Audrey Luo"
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
---

 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(purrr)
library(stringr)
```

# Initial Participant List
```{r}
#list of RBC ids with processed, non-variant diffusion MRI data, N = 1368  
participants <- read.csv("/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/PNC_NonVariantDWI_participantlist.csv") # generated by /cbica/projects/luo_wm_dev/code/Generate_input/4_QC_scripts/PNC_identify_variants.ipynb

colnames(participants) <- c("sub") 

```

# Construct Final Sample
```{r}
demographics <- read.csv("/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/n1601_demographics_go1_20161212.csv") # copied over from network_replication
bblid_scanid <- read.csv("/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/bblid_scanid_sub.csv")
demographics <- merge(demographics, bblid_scanid, by ="scanid")
demographics <- demographics %>% relocate(bblid, rbcid)
demographics <- dplyr::rename(demographics, sub = rbcid) %>% mutate(age = ageAtScan1/12)
demographics$sub <- paste0("sub-", demographics$sub)
 
demographics <- demographics[demographics$sub %in% participants$sub,] #demographic, medical, and clinical information for just the N = 1368 participants with non-variant diffusion MRI data
```

## Health History Exclusion
```{r}
health_exclude_data <- read.csv("/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/n1601_health_20170421.csv")
healthexclude <- paste0("sub-", health_exclude_data$bblid[c(which(health_exclude_data$healthExcludev2==1))]) #fyi, bblid in health_exclude_data corresponds to sub in demographics 

participants.final <- demographics[-c(which(demographics$sub %in% healthexclude)),] #remove 118 health exclude participants from the initial sample of 1368 individuals with non-variant diffusion MRI data, remaining N = 1250
```

## Diffusion Acquisition Exclusion
```{r}
dwi.qc <- read.csv("/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/PNC_DWI_QCmetrics.csv") #diffusion scan acquisition parameters and quality metrics, generated by /cbica/projects/luo_wm_dev/code/Generate_input/4_QC_scripts/diffusion_qcmetrics.ipynb

dwi.qc <- dwi.qc[dwi.qc$subject_id %in% participants$sub,] # QC info for just the N=1368 participants with non-variant diffusion data
```

```{r}
acquisitionexclude <- dwi.qc %>% filter(raw_num_directions != 71) %>% select(subject_id) #participants to exclude from the final study sample for missing a diffusion MRI run, resulting in 35 diffusion directions instead of 71
 
participants.final <- participants.final[!participants.final$sub %in% acquisitionexclude$subject_id,] %>% as.data.frame() #remove 10 participants from the sample of 1250 health include individuals due to missing gradient directions, remaining N = 1240
```

## Diffusion Quality Exclusion
```{r}
#participants to exclude from the final study sample based on processed diffusion MRI neighborhood correlation
qualityexclude <- dwi.qc %>% filter(t1_neighbor_corr < 0.6) %>% select(subject_id) 

# participants to exclude based on manual QA
T1_QA <- read.csv("/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/n1601_t1QaData_20170306.csv")
T1_QA <- merge(T1_QA, bblid_scanid, by ="scanid")
T1_QA <- dplyr::select(T1_QA, -bblid.y)
T1_QA <- T1_QA %>% relocate(rbcid) 
T1_QA <- T1_QA %>% dplyr::rename(sub=rbcid)
T1_QA$sub <- paste0("sub-", T1_QA$sub)

qualityexclude <- rbind(qualityexclude, T1_QA %>% filter(t1Exclude==1) %>% select(sub) %>% rename(subject_id=sub))

participants.final <- participants.final[!participants.final$sub %in% qualityexclude$subject_id,] %>% as.data.frame() #remove an additional 26 participants from the sample of 1240 due to diffusion data quality, remaining N = 1214
```

## Diffusion Scan Head Motion Exclusion
```{r}
motionexclude <- dwi.qc %>% filter(mean_fd > 1) %>% select(subject_id) #participants to exclude from the final study sample based on high in-scanner head motion during the diffusion runs.  
 
participants.final <- participants.final[!participants.final$sub %in% motionexclude$subject_id,] %>% as.data.frame()  #remove additional 61 participants from the sample of 1214 due to in-scanner head motion, remaining N = 1153
```


## Age Range Exclusion 
```{r}
# not doing age range exclusion for PNC 
 
```




## Missing Data Exclusion - do after autotrack finishes

### Load autotrack .csv files
```{r}

# autotrack .csv files live in data/<dataset>/<dataset>_autotrack/<subject>/*.csv
subdirectories <- list.dirs(
  path = "/cbica/projects/luo_wm_dev/input/HCPD/HCPD_autotrack/",
  full.names = TRUE,
  recursive = TRUE
)

subdirectories <- subdirectories[grep("sub-", subdirectories)] # There should be 642 subject folders

# Initialize a list to store .csv files
csv_files <- c()

# Iterate through the subdirectories and find subject .csv files
for (subdir in subdirectories) {
  csv_files_in_subdir <- list.files(
    path = subdir,
    pattern = "\\.csv$",  # Match files with '.csv' extension
    full.names = TRUE     # Return full file paths
  )
  csv_files <- c(csv_files, csv_files_in_subdir)
}

 
# Remove excluded subjects
remove <- c()
i <- 1
for (file in csv_files) {
  sub <- str_extract(file, "sub-[0-9]*")
  if (! sub %in% participants.final$sub) {
    remove <- c(remove, i)
  }
  i <- i + 1
}

csv_files_final <- csv_files[-remove]

# Read in autotrack csvs
autotrack_csvs <- lapply(csv_files_final, read.csv)
```

### Look at example autotrack dataframe
```{r}
autotrack_csvs[[1]]

length(autotrack_csvs)
```


 
### Save all subjects' tract metrics to files
```{r}

# Read in tract list
tracts <- unlist(read.csv('/cbica/projects/luo_wm_dev/input/HCPD/tract_list/tract_list.csv', header=F)) # tract_list.csv is from Marc. It lists all the tracks that had autotrack completed (and formatted without underscores)

metrics_dir <- '/cbica/projects/luo_wm_dev/output/HCPD/autotrack'
if (!file.exists(metrics_dir)) {
  dir.create(metrics_dir)
}

measures <- colnames(autotrack_csvs[[1]])[2:40]
 

# Save out separate csv for each autotrack measure for all participants
for (measure in measures) {

  # Create matrix to hold tract metrics
  tractometry_mat <- matrix(nrow=length(autotrack_csvs), ncol=length(tracts))
  sub_mat <- matrix(nrow=length(autotrack_csvs), ncol=1)
  # Populate matrix
  for (csv in 1:length(autotrack_csvs)) {
    
    autotrack_csv <- autotrack_csvs[[csv]]
    
    # Alphabetize by bundle names
    autotrack_csv <- autotrack_csv[order(autotrack_csv$bundle_name),]
    
    tractometry_mat[csv,] <- autotrack_csv[,measure]
    sub_mat[csv,] <- autotrack_csv[,"subject_id"][[1]]
  }
  
  # Add in subject column
  sub_mat <- matrix(participants.final$sub)
  tractometry_mat <- cbind(sub_mat, tractometry_mat)
  
  colnames(tractometry_mat) <- c('sub', tracts)
  
  # Save
  write.csv(tractometry_mat, paste0(metrics_dir, '/', measure, '.csv'), row.names = FALSE)
   
}
 
 
```

### Check bundle completeness
```{r}

metrics_dir <- '/cbica/projects/luo_wm_dev/output/HCPD/autotrack'
num_tracts <- read.csv(paste0(metrics_dir, '/number_of_tracts.csv'), header=T)

sub_list <- c()
for (i in 2:ncol(num_tracts)) {
  
  tract_data <- num_tracts[,i]
  
  # Check for NAs
  if (sum(is.na(tract_data)) != 0) {
    print(colnames(num_tracts)[i])
    print(paste0('--Subjects with NAs: ', sum(is.na(tract_data))))
    print(paste0('----', num_tracts[which(is.na(tract_data)), 'sub']))
    sub_list <- c(sub_list, num_tracts[which(is.na(tract_data)), 'sub'])
  }
  
  # Check for 0s
  if (sum(ifelse(tract_data[! is.na(tract_data)] == 0, 1, 0)) != 0) {
    print(paste0('--Subjects have 0s: ', sum(ifelse(tract_data[! is.na(tract_data)] == 0, 1, 0))))
  }

}
print('')
print(paste0('Minimum number of tracts per bundle across HCP-D: ', min(unlist(num_tracts[! is.na(num_tracts)]))))
 
```
 
 
### Update tract metrics files to exclude subjects with NAs
```{r}
# For each csv, remove subjects with NAs (sub_list)
for(filename in list.files(metrics_dir, pattern="csv",  full.names=T)) {
  file <- read.csv(filename)
  file <- file[!file$sub %in% sub_list,] 
  write.csv(file, filename, row.names=F)
}
 
```


### Exclude subjects with NA's
```{r}
(participants.final <- data.frame(setdiff(participants.final$sub, sub_list)) %>% setNames("sub"))
```

# Save Final Sample: Subject List and Demographics
```{r}

# Make final sample demographics dataframe
demographics.final <- demographics[demographics$sub %in% participants.final$sub,] %>% select(sub, age, sex, race) # combine demographics data 

# Make final sample QC metrics dataframe 
dwi.qc.final <- dwi.qc[dwi.qc$subject_id %in% participants.final$sub,] %>% select(subject_id, mean_fd, t1_neighbor_corr) %>% rename(sub = subject_id)  
 

sub_id <- as.data.frame(participants.final$sub)  %>% setNames("sub_id")
write.table(sub_id, "/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/PNC_WMDev_FinalSample_N1153_age8to22.txt", col.names=T, row.names=F, quote = TRUE)
write.csv(demographics.final, "/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/PNC_WMDev_FinalSampleDemographics_N1153_age8to22.csv", quote = F, row.names = F)
write.csv(dwi.qc.final, "/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/PNC_WMDev_FinalSampleQCMetrics_N1153_age8to22.csv", quote = F, row.names = F)

```

 
