---
title: "tract to cortex development"
author: "Audrey Luo"
date: "2024-10-11"
output: html_document
---
```{r}
library(ciftiTools)
#ciftiTools.setOption('wb_path', '/Applications/workbench/')
library(cifti)
library(cowplot)
library(data.table)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(grid)
library(gridExtra)
library(gratia) 
library(ggseg)
library(ggsegGlasser)
library(knitr)
library(kableExtra)
library(mgcv)
library(RColorBrewer)
library(scales)
library(stringr)
library(rjson)
library(tidyr)

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, include = TRUE) 

font_size <- 20
theme_set(theme_classic(base_family = "sans",base_size = font_size))
line_size <- 1
point_size <- 2

proj_root <- "/cbica/projects/luo_wm_dev/"
input_root <- paste0(proj_root, "input")
output_root <- paste0(proj_root, "output")
png_dir <- "/Users/audluo/PennLINC/luowm_local/output/tract_profiles_testing/all_datasets/tract_to_region"
local_dir <- "/Users/audluo/Desktop/temp_code"
 

```

note:
- for IFO, need to use lower threshold - 10%


# brain surface plot of age effects of peripheral white matter for each tract
- first clip 3 nodes from each end of the tract
- for each tract, average the 5 nodes on each end and get a value (age maps are pretty much identical with 10 nodes)
- make a new column in the maps df and for every nonzero thresholded_probability, put that value in 

```{r load glasser maps}
# load glasser labels
glasser_labels <- read.csv("/cbica/projects/luo_wm_dev/atlases/glasser/HCP-MMP1_UniqueRegionList.csv")
glasser_labels$regionID <- c(1:360)
glasser_labels$region <- gsub("7Pl", "7PL", glasser_labels$region)   

# @param depth, A string
load_maps <- function(depth, dataset) {
  
  config_file <- sprintf("%1$s/code/tract_profiles/config/config_%2$s.json", proj_root, dataset)
  config <- fromJSON(paste(readLines(config_file), collapse=""))
  
  vol_to_surf_dir <- paste0(config$data_root, "/derivatives/vol_to_surf")
  group_dir <- paste0(vol_to_surf_dir, "/group")
  

  pattern <- paste0(depth, ".*\\.csv$")

  # load glasser maps for each tract... load for a specific depth?
  glasser_csvs <- list.files(path = group_dir, pattern = pattern, full.names = T)
  tract_names <- lapply(glasser_csvs, function(path) {
    filename <- basename(path)
    sub("_\\d+\\.\\d+_glasser\\.csv$", "", filename)
  })
  tract_names <- unlist(tract_names)
  
  glasser_maps <- lapply(glasser_csvs, read.csv)
  names(glasser_maps) <- tract_names
  
  # merge labels with my maps
  glasser_maps <- lapply(glasser_maps, merge, y = glasser_labels, by = "regionID")
  
  # separate lh and rh maps
  lh_idx <- grep("Left", names(glasser_maps))
  lh_maps <- glasser_maps[lh_idx]
  assign(paste0("lh_maps_", dataset), lh_maps, envir = .GlobalEnv)
  
  rh_idx <- grep("Right", names(glasser_maps))
  rh_maps <- glasser_maps[rh_idx]
  assign(paste0("rh_maps_", dataset), rh_maps, envir = .GlobalEnv)
}

depths = c("1.5")

lapply(depths, load_maps, "HCPD")
lapply(depths, load_maps, "HBN")
lapply(depths, load_maps, "PNC")
 
```

# age effects
```{r load dev effects files}
scalar = "dti_md"
HCPD_ageeffects <- read.csv(paste0(output_root, "/", "HCPD", "/tract_profiles/GAM/", scalar, "/HCPD_GAM_dev_measures.csv"))
HBN_ageeffects <- read.csv(paste0(output_root, "/", "HBN", "/tract_profiles/GAM/", scalar, "/HBN_GAM_dev_measures.csv"))
PNC_ageeffects <- read.csv(paste0(output_root, "/", "PNC", "/tract_profiles/GAM/", scalar, "/PNC_GAM_dev_measures.csv"))
```

```{r function for formatting age effects}
# make a list of the different df names: [dataset]_GAM_ageeffects_[scalar]
datasets <- c("HCPD", "HBN", "PNC")
ageeffect_df_names <- c()
for (dataset in datasets) {
  ageeffect_df_names <- append(ageeffect_df_names, paste0(dataset, "_ageeffects"))
}

 
# format age effect df's
format_ageeffect <- function(df) {
  df <- get(df)
  # add tractID, tract_label, and nodeID
  df <- df %>% mutate(hemi = ifelse(grepl("Left", tract_node), "Left", 
                                    ifelse(grepl("Right", tract_node), "Right", NA))) %>%
    mutate(tractID = gsub("_[0-9]+", "", tract_node)) %>%
    mutate(tract_label = gsub("Left |Right ", "", gsub("_", " ", gsub("Fronto.", "Fronto-", tractID)))) %>%
    mutate(nodeID = str_extract(tract_node, "[0-9]+")) 
  df$nodeID <- as.numeric(df$nodeID)
  
  # label main orientation
  df <- df %>% 
  mutate(main_orientation = case_when(
    tract_label %in% c("Inferior Fronto-occipital",
                   "Inferior Longitudinal", "Superior Longitudinal") ~ "AP",
    tract_label %in% c("Arcuate") ~ "AP_frontal_temporal",
    tract_label %in% c("Callosum Anterior Frontal", "Callosum Motor", "Callosum Occipital", "Callosum Orbital", 
                       "Callosum Posterior Parietal", "Callosum Superior Frontal", "Callosum Superior Parietal", "Callosum Temporal") ~ "RL",
    tract_label %in% c("Corticospinal", "Posterior Arcuate","Vertical Occipital") ~ "SI",
    TRUE ~ NA_character_
  ))
  df$main_orientation <- as.factor(df$main_orientation)
  df <- df %>% relocate(tract_label, tractID, nodeID, tract_node, hemi, main_orientation)
  return(df)
}

ageeffect_dfs <- lapply(ageeffect_df_names, format_ageeffect)
 
```

```{r fdr correction}
# Function for calculating number of significant nodes (FDR corrected)
# @param df A dataframe with GAM results
sig_nodes <- function(df) {

  df$Anova.age.pvalue.fdr <- p.adjust(df$Anova.smooth.pvalue, method=c("fdr"))
  cat(sprintf("There are %s/%s significant nodes\n", sum(df$Anova.age.pvalue.fdr < 0.05, na.rm=TRUE), nrow(df)))
  df$significant.fdr <- df$Anova.age.pvalue.fdr < 0.05
  df$significant.fdr[df$significant.fdr == TRUE] <- 1
  df$significant.fdr[df$significant.fdr == FALSE] <- 0
  return(df)
}

ageeffect.fdr_dfs <- lapply(ageeffect_dfs, sig_nodes)
names(ageeffect.fdr_dfs) <- ageeffect_df_names
  

```

```{r average tract age effects}
library(ggplot2)
library(dplyr)

bin_num_nodes = 5
clipEnds = 5

average_tract_deveffect <- function(df, ageeffect_measure, bin_num_nodes, clipEnds) {
  sqrt_n <- sqrt(bin_num_nodes) # n = number of nodes included in each bin (or level of node_position)
  df <- df %>% filter(nodeID > (clipEnds-1) & nodeID < (99-clipEnds+1))
  df_binned <- df %>%
        filter(
          nodeID < (bin_num_nodes + clipEnds) |  # Start of the tract
          nodeID > (99 - bin_num_nodes - clipEnds) # End of the tract
        ) %>%
        mutate(
        node_position = case_when(
            tract_label == "Corticospinal" & nodeID < (bin_num_nodes + clipEnds) ~ "end1",
            tract_label == "Corticospinal" & nodeID > (99 - bin_num_nodes - clipEnds) ~ "end2",
            tract_label != "Corticospinal" & nodeID < (bin_num_nodes + clipEnds) ~ "end1",
            tract_label != "Corticospinal" & nodeID > (99 - bin_num_nodes - clipEnds) ~ "end2", 
            TRUE ~ NA_character_
        )
    ) %>%
        #group_by(tract_label, node_position) %>%
        group_by(tractID, node_position) %>% # removed hemi
        summarise(
          mean_ageeffect = abs(mean(get(ageeffect_measure), na.rm = TRUE)),
          sd = abs(sd(get(ageeffect_measure), na.rm = TRUE)),
          ymin_sd = abs(mean(get(ageeffect_measure), na.rm = TRUE)) - sd,
          ymax_sd = abs(mean(get(ageeffect_measure), na.rm = TRUE)) + sd, 
          se = sd(get(ageeffect_measure), na.rm = TRUE) / sqrt_n,
          ymin_se = abs(mean(get(ageeffect_measure), na.rm = TRUE)) - se,
          ymax_se = abs(mean(get(ageeffect_measure), na.rm = TRUE)) + se
        )
  df_binned$node_position <- factor(df_binned$node_position, levels = c("end1", "end2"))
  
  return(df_binned)
}

# end 1 is always the side at node 0
# end 2 is always the side at node 99
# refer to the main_orientation variable in gam_df to know the orientation of the tract
# which goes from 0-99 (so SI means node 0 = superior, node 99 = inferior)
ageeffect_measure = "GAM.smooth.AdjRsq"

HCPD_deveffects_5 <- average_tract_deveffect(ageeffect.fdr_dfs$HCPD_ageeffects, ageeffect_measure, bin_num_nodes = 5, clipEnds = 5)  
HCPD_deveffects_10 <- average_tract_deveffect(ageeffect.fdr_dfs$HCPD_ageeffects, ageeffect_measure, bin_num_nodes = 10, clipEnds = 5)  

HBN_deveffects_5 <- average_tract_deveffect(ageeffect.fdr_dfs$HBN_ageeffects, ageeffect_measure, bin_num_nodes = 5, clipEnds = 5)  
HBN_deveffects_10 <- average_tract_deveffect(ageeffect.fdr_dfs$HBN_ageeffects, ageeffect_measure, bin_num_nodes = 10, clipEnds = 5)  

PNC_deveffects_5 <- average_tract_deveffect(ageeffect.fdr_dfs$PNC_ageeffects, ageeffect_measure, bin_num_nodes = 5, clipEnds = 5)  
PNC_deveffects_10 <- average_tract_deveffect(ageeffect.fdr_dfs$PNC_ageeffects, ageeffect_measure, bin_num_nodes = 10, clipEnds = 5)  

 
```
age of maturation vs. age effect
```{r}
cor.test(ageeffect.fdr_dfs$HCPD_ageeffects$smooth.decrease.offset, abs(ageeffect.fdr_dfs$HCPD_ageeffects$GAM.smooth.AdjRsq)) # r = 0.4304646 , p <<< 0
cor.test(ageeffect.fdr_dfs$PNC_ageeffects$smooth.decrease.offset, abs(ageeffect.fdr_dfs$PNC_ageeffects$GAM.smooth.AdjRsq)) # r = 0.6331242 , p <<< 0
cor.test(ageeffect.fdr_dfs$HBN_ageeffects$smooth.decrease.offset, abs(ageeffect.fdr_dfs$HBN_ageeffects$GAM.smooth.AdjRsq)) # r = 0.457981 , p <<< 0


```


assigning age effects to endpoints: need to do this manually for each tract (but code is applicable to all datasets)
```{r assign age effects to cortical endpoints}

threshold = 0.3

# have to do this manually T_T
make_maps <- function(dataset, bin_num_nodes) {
  
  lh_maps <- get(paste0("lh_maps_", dataset))
  rh_maps <- get(paste0("rh_maps_", dataset))
  deveffects <- get(paste0(dataset, "_deveffects_", bin_num_nodes))
  
  # for tracts with 1 endpoint (CST), extract the age effect for end1 (corresponds to cortical endpoint) 
  CSTL_deveffect <- lh_maps$LeftCorticospinal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Left_Corticospinal" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CSTR_deveffect <- rh_maps$RightCorticospinal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Right_Corticospinal" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
   
  # for tracts with 2 distinct cortical endpoints: ARC, ILF, IFO, SLF
  ARCL_deveffect <- lh_maps$LeftArcuate %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = case_when(
        !is.na(thresh_probability) & (str_detect(cortex, "(?i)frontal") | str_detect(cortex, "(?i)motor") | str_detect(cortex, "(?i)Posterior_Opercular")) ~ 
          deveffects %>% filter(tractID == "Left_Arcuate", node_position == "end1") %>% pull(mean_ageeffect),
        !is.na(thresh_probability) & (str_detect(cortex, "(?i)Temp") | str_detect(cortex, "(?i)Auditory")) ~ 
          deveffects %>% filter(tractID == "Left_Arcuate", node_position == "end2") %>% pull(mean_ageeffect),
        TRUE ~ NA_real_
      )
    ) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & (str_detect(cortex, "(?i)frontal") | str_detect(cortex, "motor") | str_detect(cortex, "Posterior_Opercular")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & (str_detect(cortex, "Temp") | str_detect(cortex, "Auditory") ), 
          "end2", 
          NA))
      ) %>%
    relocate(mean_age_effect)
  
  ARCR_deveffect <- rh_maps$RightArcuate %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = case_when(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") | str_detect(cortex, "(?i)motor") | str_detect(cortex, "(?i)Posterior_Opercular")) ~ 
            deveffects %>% filter(tractID == "Left_Arcuate", node_position == "end1") %>% pull(mean_ageeffect),
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)Temp") | str_detect(cortex, "(?i)MT") | str_detect(cortex, "(?i)Auditory")) ~ 
            deveffects %>% filter(tractID == "Left_Arcuate", node_position == "end2") %>% pull(mean_ageeffect),
        TRUE ~ NA_real_
      ),
      end = case_when(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") | str_detect(cortex, "(?i)motor") | str_detect(cortex, "(?i)Posterior_Opercular")) ~ "end1",
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)Temp") | str_detect(cortex, "(?i)MT") | str_detect(cortex, "(?i)Auditory")) ~ "end2",
        TRUE ~ NA_character_
      )
    ) %>%
    relocate(mean_age_effect)
   
  ILFL_deveffect <- lh_maps$LeftInferiorLongitudinal %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = case_when(
        !is.na(thresh_probability) & 
        !str_detect(cortex, "(?i)visual|Inferior_Parietal|Occipital") ~ 
          deveffects %>% filter(tractID == "Left_Inferior_Longitudinal", node_position == "end1") %>% pull(mean_ageeffect),
        !is.na(thresh_probability) & 
        str_detect(cortex, "(?i)visual|Inferior_Parietal|Occipital") ~ 
          deveffects %>% filter(tractID == "Left_Inferior_Longitudinal", node_position == "end2") %>% pull(mean_ageeffect),
        TRUE ~ NA_real_
      ),
      end = case_when(
        !is.na(thresh_probability) & 
        !str_detect(cortex, "(?i)visual|Inferior_Parietal|Occipital") ~ "end1",
        !is.na(thresh_probability) & 
        str_detect(cortex, "(?i)visual|Inferior_Parietal|Occipital") ~ "end2",
        TRUE ~ NA_character_
      )
    ) %>%
    relocate(mean_age_effect)
  
  
  ILFR_deveffect <- rh_maps$RightInferiorLongitudinal %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability) & (!str_detect(cortex, "(?i)visual")) & region != "PHA3", 
        deveffects %>%  filter(tractID == "Right_Inferior_Longitudinal", node_position == "end1") %>% pull(mean_ageeffect),
        ifelse(
          !is.na(thresh_probability) & (str_detect(cortex, "(?i)visual")) | region == "PHA3", 
        deveffects %>%  filter(tractID == "Right_Inferior_Longitudinal", node_position == "end2") %>% pull(mean_ageeffect),
          NA))
      ) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & (!str_detect(cortex, "(?i)visual")) & region != "PHA3", 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & (str_detect(cortex, "(?i)visual")) | region == "PHA3", 
          "end2", 
          NA))
      ) %>%
    relocate(mean_age_effect) %>% arrange(end)
  
  
  IFOL_deveffect <- lh_maps$LeftInferiorFrontooccipital %>%
    mutate(
      thresh_probability = ifelse(probability < 0.1, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(mean_age_effect = case_when(
      !is.na(thresh_probability) & 
      (str_detect(cortex, "(?i)frontal|Auditory")) ~ 
        deveffects %>% filter(tractID == "Left_Inferior_Fronto.occipital", node_position == "end1") %>% pull(mean_ageeffect),
      !is.na(thresh_probability) & 
      str_detect(cortex, "(?i)visual") ~ 
        deveffects %>% filter(tractID == "Left_Inferior_Fronto.occipital", node_position == "end2") %>% pull(mean_ageeffect),
      TRUE ~ NA_real_)) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal") | 
         str_detect(cortex, "Auditory")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)visual")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_age_effect)
   
  IFOR_deveffect <- rh_maps$RightInferiorFrontooccipital %>%
    mutate(
      thresh_probability = ifelse(probability < 0.1, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal")  |
         str_detect(cortex, "Auditory")), 
        deveffects %>% filter(tractID == "Right_Inferior_Fronto.occipital", node_position == "end1") %>% pull(mean_ageeffect),
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)visual")), 
         deveffects %>% filter(tractID == "Right_Inferior_Fronto.occipital", node_position == "end2") %>% pull(mean_ageeffect),
          NA
        )
      )
    ) %>%
     mutate(
      end = ifelse(
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal") | 
         str_detect(cortex, "Auditory")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)visual")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_age_effect)
  
  SLFL_deveffect <- lh_maps$LeftSuperiorLongitudinal %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal") |
           str_detect(cortex, "(?i)motor") | 
           str_detect(cortex, "(?i)Opercular")), 
        deveffects %>% filter(tractID == "Left_Superior_Longitudinal", node_position == "end1") %>% pull(mean_ageeffect),
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)pariet|(?i)auditory")), 
        deveffects %>% filter(tractID == "Left_Superior_Longitudinal", node_position == "end2") %>% pull(mean_ageeffect),
          NA))) %>%
    mutate(end = ifelse(
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal") |
           str_detect(cortex, "(?i)motor") | 
           str_detect(cortex, "(?i)Opercular")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)pariet|(?i)auditory")), 
          "end2", 
          NA))) %>%
    relocate(mean_age_effect)
  
  SLFR_deveffect <- rh_maps$RightSuperiorLongitudinal %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal") |
           str_detect(cortex, "(?i)motor") | 
           str_detect(cortex, "(?i)Opercular")), 
        deveffects %>% filter(tractID == "Right_Superior_Longitudinal", node_position == "end1") %>% pull(mean_ageeffect),
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)pariet")), 
        deveffects %>% filter(tractID == "Right_Superior_Longitudinal", node_position == "end2") %>% pull(mean_ageeffect),
        NA))) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal") |
           str_detect(cortex, "(?i)motor") | 
           str_detect(cortex, "(?i)Opercular")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)pariet")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_age_effect)
    
  # for tracts with 2 cortical endpoints that require some manual work: pARC, VOF 
  pARCL_deveffect <- lh_maps$LeftPosteriorArcuate %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = ifelse( 
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)parietal")),  # might exclude TPOJ1 since its between the two endpoints
        deveffects %>% filter(tractID == "Left_Posterior_Arcuate", node_position == "end1") %>% pull(mean_ageeffect),
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)temporal") |
             str_detect(cortex, "(?i)visual") |
             str_detect(cortex, "(?i)auditory")), 
         deveffects %>% filter(tractID == "Left_Posterior_Arcuate", node_position == "end2") %>% pull(mean_ageeffect), 
          NA))) %>%
    mutate(
      end = ifelse( 
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)parietal")),  # might exclude TPOJ1 since its between the two endpoints
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)temporal") |
             str_detect(cortex, "(?i)visual") |
             str_detect(cortex, "(?i)auditory")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_age_effect)
  
  pARCR_deveffect <- rh_maps$RightPosteriorArcuate %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = ifelse( 
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)parietal")),  # might exclude TPOJ1 since its between the two endpoints
        deveffects %>% filter(tractID == "Right_Posterior_Arcuate", node_position == "end1") %>% pull(mean_ageeffect), 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)temporal") |
             str_detect(cortex, "(?i)visual") |
             str_detect(cortex, "(?i)auditory")), 
          deveffects %>% filter(tractID == "Right_Posterior_Arcuate", node_position == "end2") %>% pull(mean_ageeffect), 
          NA
        )
      )
    ) %>%
     mutate(
      end = ifelse( 
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)parietal")),  # might exclude TPOJ1 since its between the two endpoints
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)temporal") |
             str_detect(cortex, "(?i)visual") |
             str_detect(cortex, "(?i)auditory")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_age_effect)
  
  VOFL_deveffect <- lh_maps$LeftVerticalOccipital %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = ifelse( 
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)dorsal") | 
         str_detect(cortex, "(?i)parietal") |
           region == "LO1" |
           region == "V3CD" |
           region == "V4" | # kind of arbitrarily placing V3 and V4 for now
           region == "MST" |
           region == "MT" | 
           region == "TPOJ3" |
           region == "LO3"),   
        deveffects %>% filter(tractID == "Left_Vertical_Occipital", node_position == "end1") %>% pull(mean_ageeffect), 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)ventral") | 
           region == "PH" |
           region == "LO2" |
             region == "V3"), 
          deveffects %>% filter(tractID == "Left_Vertical_Occipital", node_position == "end2") %>% pull(mean_ageeffect), 
          NA))) %>%
    mutate(
      end = ifelse( 
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)dorsal") | 
         str_detect(cortex, "(?i)parietal") |
         region == "LO1" |
         region == "V3CD" |
         region == "V4" | # kind of arbitrarily placing V3 and V4 for now
         region == "MST" |
         region == "MT" |
         region == "TPOJ3" |
         region == "LO3"),   
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)ventral") | 
           region == "PH" |
           region == "LO2" |
             region == "V3" ), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_age_effect)
  
  
  VOFR_deveffect <- rh_maps$RightVerticalOccipital %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_age_effect = ifelse( 
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)dorsal") | 
         str_detect(cortex, "(?i)parietal") |
         region == "LO1" |
         region == "V3CD" |
         region == "V4" | # kind of arbitrarily placing V3 and V4 for now
         region == "LO3" | 
         region == "TPOJ3"),   
         deveffects %>% filter(tractID == "Right_Vertical_Occipital", node_position == "end1") %>% pull(mean_ageeffect), 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)ventral") | 
           region == "PH" |
           region == "LO2" |
           region == "MST" |
           region == "V3"), 
           deveffects %>% filter(tractID == "Right_Vertical_Occipital", node_position == "end2") %>% pull(mean_ageeffect), NA
        )
      )
    ) %>%
    mutate(
      end = ifelse( 
        !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)dorsal") |
          str_detect(cortex, "(?i)parietal") |
          region == "LO1" |
          region == "V3CD" |
          region == "V4"| # kind of arbitrarily placing V3 and V4 for now
          region == "LO3" | 
          region == "TPOJ3"),   
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)ventral") | 
           region == "PH" |
           region == "LO2" |
           region == "V3" | 
           region == "MST" |
           region == "FST"), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_age_effect)
   
  
  # callosum bundles
  COrbL_deveffect <- lh_maps$LeftCallosumOrbital %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Orbital" & node_position == "end2") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_age_effect)
  
  COrbR_deveffect <- rh_maps$RightCallosumOrbital %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Orbital" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  
  CAntFrL_deveffect <- lh_maps$LeftCallosumAnteriorFrontal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Anterior_Frontal" & node_position == "end2") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CAntFrR_deveffect <- rh_maps$RightCallosumAnteriorFrontal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Anterior_Frontal" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CSupFrL_deveffect <- lh_maps$LeftCallosumSuperiorFrontal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Superior_Frontal" & node_position == "end2") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CSupFrR_deveffect <- rh_maps$RightCallosumSuperiorFrontal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Superior_Frontal" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CMotL_deveffect <- lh_maps$LeftCallosumMotor %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Motor" & node_position == "end2") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CMotR_deveffect <- rh_maps$RightCallosumMotor %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Motor" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CSupParL_deveffect <- lh_maps$LeftCallosumSuperiorParietal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Superior_Parietal" & node_position == "end2") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CSupParR_deveffect <- rh_maps$RightCallosumSuperiorParietal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Superior_Parietal" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CPostParL_deveffect <- lh_maps$LeftCallosumPosteriorParietal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Posterior_Parietal" & node_position == "end2") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CPostParR_deveffect <- rh_maps$RightCallosumPosteriorParietal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Posterior_Parietal" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CTempL_deveffect <- lh_maps$LeftCallosumTemporal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Temporal" & node_position == "end2") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_age_effect)
  
  CTempR_deveffect <- rh_maps$RightCallosumTemporal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Temporal" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  COccL_deveffect <- lh_maps$LeftCallosumOccipital %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Occipital" & node_position == "end2") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_age_effect)
  
  COccR_deveffect <- rh_maps$RightCallosumOccipital %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_age_effect = ifelse(
        !is.na(thresh_probability), 
        deveffects %>% filter(tractID == "Callosum_Occipital" & node_position == "end1") %>% pull(mean_ageeffect), NA)
      ) %>% 
     mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_age_effect)
  
  assign(paste0("CSTL_deveffect_", dataset), CSTL_deveffect, envir = .GlobalEnv)
  assign(paste0("CSTR_deveffect_", dataset), CSTR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("ARCL_deveffect_", dataset), ARCL_deveffect, envir = .GlobalEnv)
  assign(paste0("ARCR_deveffect_", dataset), ARCR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("IFOL_deveffect_", dataset), IFOL_deveffect, envir = .GlobalEnv)
  assign(paste0("IFOR_deveffect_", dataset), IFOR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("ILFL_deveffect_", dataset), ILFL_deveffect, envir = .GlobalEnv)
  assign(paste0("ILFR_deveffect_", dataset), ILFR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("pARCL_deveffect_", dataset), pARCL_deveffect, envir = .GlobalEnv)
  assign(paste0("pARCR_deveffect_", dataset), pARCR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("SLFL_deveffect_", dataset), SLFL_deveffect, envir = .GlobalEnv)
  assign(paste0("SLFR_deveffect_", dataset), SLFR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("VOFL_deveffect_", dataset), VOFL_deveffect, envir = .GlobalEnv)
  assign(paste0("VOFR_deveffect_", dataset), VOFR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("COrbL_deveffect_", dataset), COrbL_deveffect, envir = .GlobalEnv)
  assign(paste0("COrbR_deveffect_", dataset), COrbR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("CAntFrL_deveffect_", dataset), CAntFrL_deveffect, envir = .GlobalEnv)
  assign(paste0("CAntFrR_deveffect_", dataset), CAntFrR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("CSupFrL_deveffect_", dataset), CSupFrL_deveffect, envir = .GlobalEnv)
  assign(paste0("CSupFrR_deveffect_", dataset), CSupFrR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("CMotL_deveffect_", dataset), CMotL_deveffect, envir = .GlobalEnv)
  assign(paste0("CMotR_deveffect_", dataset), CMotR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("CSupParL_deveffect_", dataset), CSupParL_deveffect, envir = .GlobalEnv)
  assign(paste0("CSupParR_deveffect_", dataset), CSupParR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("CPostParL_deveffect_", dataset), CPostParL_deveffect, envir = .GlobalEnv)
  assign(paste0("CPostParR_deveffect_", dataset), CPostParR_deveffect, envir = .GlobalEnv)
  
  assign(paste0("CTempL_deveffect_", dataset), CTempL_deveffect, envir = .GlobalEnv)
  assign(paste0("CTempR_deveffect_", dataset), CTempR_deveffect, envir = .GlobalEnv)
  
  
  assign(paste0("COccL_deveffect_", dataset), COccL_deveffect, envir = .GlobalEnv)
  assign(paste0("COccR_deveffect_", dataset), COccR_deveffect, envir = .GlobalEnv)
}

 
``` 
 
```{r make maps}

threshold = 0.3
make_maps("HCPD", bin_num_nodes = 5)
make_maps("HBN", bin_num_nodes = 5)
make_maps("PNC", bin_num_nodes = 5)
```

 
```{r functions for plotting age effect, fig.height = 5, fig.width = 5}
#colormap <- c("#052632","#15CABE","#ABF590","#fffe76")
 
#colormap_file <- sprintf("%1$s/code/tract_profiles/colormaps/aquamarine.json", proj_root)
#colormap <- fromJSON(paste(readLines(colormap_file), collapse=""))
 
#aquamarine <- colorRampPalette(colormap)(15)
 

plot_ageeffects <- function(bundle_name, dataset, ylim1, ylim2) {
  df <- get(paste0(bundle_name, "_deveffect_", dataset))
  if(grepl("L$", bundle_name)) {
    hemi = "left"
    cortical_pos1 <- "left lateral" 
    cortical_pos2 <- "left medial"
  } else{
    hemi = "right"
    cortical_pos1 <- "right lateral" 
    cortical_pos2 <- "right medial"
  }
  plot_lateral <- ggplot() + 
      geom_brain(data = df, atlas= glasser, 
                 mapping=aes(fill=mean_age_effect), 
                 show.legend=TRUE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos1)) +
    paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1 , limits = c(ylim1, ylim2), oob = squish, na.value = "white") +
    #scale_fill_gradientn(colors = aquamarine, na.value = "white", limits = c(ylim1, ylim2), oob=squish) +
    theme_void() +
      theme(legend.position = "none",
                  legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.01, 0.1, 0.1), "cm"),
            plot.title = element_blank()) 
  
   plot_medial <- ggplot() + 
      geom_brain(data = df, atlas= glasser, 
                 mapping=aes(fill=mean_age_effect), 
                 show.legend=TRUE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos2)) +
    paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1 , limits = c(ylim1, ylim2), oob = squish, na.value = "white") +
    #scale_fill_gradientn(colors = aquamarine, na.value = "white", limits = c(ylim1, ylim2), oob=squish) +
    theme_void() +
      theme(legend.position = "none",
                  legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.1, 0.1, 0.01), "cm"),
            plot.title = element_blank())

 return( plot_grid(plot_lateral, plot_medial))
             
}
 
arrange_ageeffect_plots <- function(lh_plots, rh_plots) {
  # arrange maps together  
  ARC_plots <- ggarrange(lh_plots$ARCL, rh_plots$ARCR, ncol=1, nrow = 2)
  ARC_final <- annotate_figure(ARC_plots, top = text_grob("Arcuate Fasciculus", 
                 color = "black", face = "bold", size = 20))

  
  CST_plots <- ggarrange(lh_plots$CSTL, rh_plots$CSTR, ncol=1, nrow = 2)
  CST_final <- annotate_figure(CST_plots, top = text_grob("Corticospinal Tract", 
                 color = "black", face = "bold", size = 20))
  
  IFO_plots <- ggarrange(lh_plots$IFOL, rh_plots$IFOR, ncol=1, nrow = 2)
  IFO_final <- annotate_figure(IFO_plots, top = text_grob("Inferior Fronto-occipital Fasciculus", 
                 color = "black", face = "bold", size = 20))
  
  ILF_plots <- ggarrange(lh_plots$ILFL, rh_plots$ILFR, ncol=1, nrow = 2)
  ILF_final <- annotate_figure(ILF_plots, top = text_grob("Inferior Longitudinal Fasciculus", 
                 color = "black", face = "bold", size = 20))
  
  pARC_plots <- ggarrange(lh_plots$pARCL, rh_plots$pARCR, ncol=1, nrow = 2)
  pARC_final <- annotate_figure(pARC_plots, top = text_grob("Posterior Arcuate Fasciculus", 
                 color = "black", face = "bold", size = 20))
  
  SLF_plots <- ggarrange(lh_plots$SLFL, rh_plots$SLFR, ncol=1, nrow = 2)
  SLF_final <- annotate_figure(SLF_plots, top = text_grob("Superior Longitudinal Fasciculus", 
                 color = "black", face = "bold", size = 20))
  
  
  VOF_plots <- ggarrange(lh_plots$VOFL, rh_plots$VOFR, ncol=1, nrow = 2)
  VOF_final <- annotate_figure(VOF_plots, top = text_grob("Vertical Occipital Fasciculus", 
                 color = "black", face = "bold", size = 20))
  # stitch it all together
  legend <- get_legend(lh_plots$VOFL + theme(legend.position = "bottom",
                                            legend.key.height = unit(1.5, 'cm'),
                                            legend.key.width = unit(3.5, 'cm'),
                                            legend.margin=margin(100,300,0,0),
                                            legend.text = element_text(size=20),
                                            legend.title = element_blank()))
   legend_title <- textGrob(expression(paste("Age Effect (Delta Adj", " R"^2, ")")), 
                   gp=gpar(col="black", fontsize=20),  
    hjust = 1.3,  
    vjust = 0.05   
  )
  
  legend_with_title <- arrangeGrob(
    legend, legend_title,
    ncol = 1, nrow = 2  
  )
  
  # save out
  #ggsave(sprintf("/Users/audluo/PennLINC/luowm_local/output/tract_profiles_testing/HBN/tract_to_region_ageeffects.png"),
         #grid.arrange(ARC_final, ATR_final, CGC_final, CST_final, IFO_final, ILF_final, pARC_final, SLF_final, UNC_final, VOF_final, NULL, legend_with_title, 
  #ncol = 3, nrow = 4) , height = 14, width = 14, units = "in")
  return( grid.arrange(ARC_final, CST_final, IFO_final, ILF_final, pARC_final, SLF_final, VOF_final, NULL, legend_with_title, 
  ncol = 3, nrow = 3) )
}


arrange_ageeffect_callosum_plots <- function(lh_plots, rh_plots) {
  # arrange maps together  
  COrb_plots <- ggarrange(lh_plots$COrbL, rh_plots$COrbR, ncol=1, nrow = 2)
  COrb_final <- annotate_figure(COrb_plots, top = text_grob("Orbital", 
                 color = "black", face = "bold", size = 20))

  CAntFr_plots <- ggarrange(lh_plots$CAntFrL, rh_plots$CAntFrR, ncol=1, nrow = 2)
  CAntFr_final <- annotate_figure(CAntFr_plots, top = text_grob("Anterior Frontal", 
                 color = "black", face = "bold", size = 20))
  
  CSupFr_plots <- ggarrange(lh_plots$CSupFrL, rh_plots$CSupFrR, ncol=1, nrow = 2)
  CSupFr_final <- annotate_figure(CSupFr_plots, top = text_grob("Superior Frontal", 
                 color = "black", face = "bold", size = 20))
  
  CMot_plots <- ggarrange(lh_plots$CMotL, rh_plots$CMotR, ncol=1, nrow = 2)
  CMot_final <- annotate_figure(CMot_plots, top = text_grob("Motor", 
                 color = "black", face = "bold", size = 20))
  
  CSupPar_plots <- ggarrange(lh_plots$CSupParL, rh_plots$CSupParR, ncol=1, nrow = 2)
  CSupPar_final <- annotate_figure(CSupPar_plots, top = text_grob("Superior Parietal", 
                 color = "black", face = "bold", size = 20))
  
  CPostPar_plots <- ggarrange(lh_plots$CPostParL, rh_plots$CPostParR, ncol=1, nrow = 2)
  CPostPar_final <- annotate_figure(CPostPar_plots, top = text_grob("Posterior Parietal", 
                 color = "black", face = "bold", size = 20))
  
  CTemp_plots <- ggarrange(lh_plots$CTempL, rh_plots$CTempR, ncol=1, nrow = 2)
  CTemp_final <- annotate_figure(CTemp_plots, top = text_grob("Temporal", 
                 color = "black", face = "bold", size = 20))
  
  
  COcc_plots <- ggarrange(lh_plots$COccL, rh_plots$COccR, ncol=1, nrow = 2)
  COcc_final <- annotate_figure(COcc_plots, top = text_grob("Occipital", 
                 color = "black", face = "bold", size = 20))
 
  callosum_plots <- ggarrange(COrb_final, CAntFr_final, CSupFr_final, CMot_final, CSupPar_final, CPostPar_final, CTemp_final, COcc_final, ncol = 2, nrow = 4)

# Extract the legend from one of the plots  
  legend <- get_legend(
    lh_plots$CAntFrL + 
      theme(
        legend.position = "bottom",
        legend.key.height = unit(1.5, 'cm'),
        legend.key.width = unit(3.5, 'cm'),
        legend.margin = margin(0, 0, 0, 0),
        legend.text = element_text(size = 20),
        legend.title = element_blank()
      )
  )

# Create the legend title separately using cowplot
  legend_title <- ggdraw() + 
    draw_label(
      expression(paste("Age Effect (", Delta, " Adjusted ", R^2, ")")), 
      fontface = 'bold', 
      size = 20,
      x = 0.5,   
      hjust = 0.5
    )

  legend_with_title <- plot_grid(legend, legend_title, ncol = 1, rel_heights = c(0.8, 0.2))

  final_plot <- plot_grid(callosum_plots, legend_with_title, ncol = 1, rel_heights = c(1, 0.12))
  return(final_plot)
}
```


```{r get ylim}

# HCPD
# get the range of age effects   
get_ageeffect_range <- rbind(ARCL_deveffect_HCPD,
                            ARCR_deveffect_HCPD,
                            ILFL_deveffect_HCPD,
                            ILFR_deveffect_HCPD,
                            IFOL_deveffect_HCPD,
                            IFOR_deveffect_HCPD,
                            SLFL_deveffect_HCPD,
                            SLFR_deveffect_HCPD, 
                            pARCL_deveffect_HCPD,
                            pARCR_deveffect_HCPD,
                            VOFL_deveffect_HCPD,
                            VOFR_deveffect_HCPD)

range(get_ageeffect_range$mean_age_effect, na.rm=T) #0.1522728 0.4009296
hist(get_ageeffect_range$mean_age_effect)

get_ageeffect_range_call <- rbind(COrbL_deveffect_HCPD,
                            COrbR_deveffect_HCPD,
                            CAntFrL_deveffect_HCPD,
                            CAntFrR_deveffect_HCPD,
                            CSupFrL_deveffect_HCPD,
                            CSupFrR_deveffect_HCPD,
                            CMotL_deveffect_HCPD,
                            CMotR_deveffect_HCPD, 
                            CSupParL_deveffect_HCPD,
                            CSupParR_deveffect_HCPD,
                            CPostParL_deveffect_HCPD,
                            CPostParR_deveffect_HCPD,
                            CTempL_deveffect_HCPD,
                            CTempR_deveffect_HCPD,
                            COccL_deveffect_HCPD,
                            COccR_deveffect_HCPD)

range(get_ageeffect_range_call$mean_age_effect, na.rm=T) #0.1756291 0.4221247
hist(get_ageeffect_range_call$mean_age_effect)

# HBN
# get the range of age effects   
get_ageeffect_range <- rbind(ARCL_deveffect_HBN,
                            ARCR_deveffect_HBN,
                            ILFL_deveffect_HBN,
                            ILFR_deveffect_HBN,
                            IFOL_deveffect_HBN,
                            IFOR_deveffect_HBN,
                            SLFL_deveffect_HBN,
                            SLFR_deveffect_HBN, 
                            pARCL_deveffect_HBN,
                            pARCR_deveffect_HBN,
                            VOFL_deveffect_HBN,
                            VOFR_deveffect_HBN)

range(get_ageeffect_range$mean_age_effect, na.rm=T) #0.1007262 0.3233674
hist(get_ageeffect_range$mean_age_effect)

get_ageeffect_range_call <- rbind(COrbL_deveffect_HBN,
                            COrbR_deveffect_HBN,
                            CAntFrL_deveffect_HBN,
                            CAntFrR_deveffect_HBN,
                            CSupFrL_deveffect_HBN,
                            CSupFrR_deveffect_HBN,
                            CMotL_deveffect_HBN,
                            CMotR_deveffect_HBN, 
                            CSupParL_deveffect_HBN,
                            CSupParR_deveffect_HBN,
                            CPostParL_deveffect_HBN,
                            CPostParR_deveffect_HBN,
                            CTempL_deveffect_HBN,
                            CTempR_deveffect_HBN,
                            COccL_deveffect_HBN,
                            COccR_deveffect_HBN)

range(get_ageeffect_range_call$mean_age_effect, na.rm=T) # 0.1642751 0.3345251
hist(get_ageeffect_range_call$mean_age_effect)



# PNC
# get the range of age effects   
get_ageeffect_range <- rbind(ARCL_deveffect_PNC,
                            ARCR_deveffect_PNC,
                            ILFL_deveffect_PNC,
                            ILFR_deveffect_PNC,
                            IFOL_deveffect_PNC,
                            IFOR_deveffect_PNC,
                            SLFL_deveffect_PNC,
                            SLFR_deveffect_PNC, 
                            pARCL_deveffect_PNC,
                            pARCR_deveffect_PNC,
                            VOFL_deveffect_PNC,
                            VOFR_deveffect_PNC)

range(get_ageeffect_range$mean_age_effect, na.rm=T) # 0.07291809 0.35561986
hist(get_ageeffect_range$mean_age_effect)

get_ageeffect_range_call <- rbind(COrbL_deveffect_PNC,
                            COrbR_deveffect_PNC,
                            CAntFrL_deveffect_PNC,
                            CAntFrR_deveffect_PNC,
                            CSupFrL_deveffect_PNC,
                            CSupFrR_deveffect_PNC,
                            CMotL_deveffect_PNC,
                            CMotR_deveffect_PNC, 
                            CSupParL_deveffect_PNC,
                            CSupParR_deveffect_PNC,
                            CPostParL_deveffect_PNC,
                            CPostParR_deveffect_PNC,
                            CTempL_deveffect_PNC,
                            CTempR_deveffect_PNC,
                            COccL_deveffect_PNC,
                            COccR_deveffect_PNC)

range(get_ageeffect_range_call$mean_age_effect, na.rm=T) #0.06137466 0.36230223
hist(get_ageeffect_range_call$mean_age_effect)
```

```{r set tract names}
lh_assoc_names <- c("ARCL", "CSTL" ,"ILFL", "IFOL", "SLFL", "pARCL", "VOFL")
rh_assoc_names <- c("ARCR", "CSTR", "ILFR", "IFOR", "SLFR", "pARCR", "VOFR")
lh_callosum_names <- c("COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL")
rh_callosum_names <- c("COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR")
```

 
```{r plot age effects, fig.height = 14, fig.width = 14}

# the same cortical regions across different maps might have slightly different age effects, and that is okay. The age effects do tend to be in the same ballpark
# this occurs because the age effects are projected to all the cortical regions that have a 30% or higher or being a cortical endpoint of a given tract
# so for example, for IFO vs. VOF, the occipital lobe looks like there may be differences in age effect in the same brain region
# it's likely because the exact cortical regions that one tract terminates on are slightly different than the other, but the age effect from the tract gets projected onto all of the regions at each tract end.

# association bundles + CST
lh_plots_HCPD <- lapply(lh_assoc_names, plot_ageeffects, dataset="HCPD", ylim1 = 0.1, ylim2 = 0.40)
rh_plots_HCPD <- lapply(rh_assoc_names, plot_ageeffects, dataset="HCPD", ylim1 = 0.1, ylim2 = 0.40)
names(lh_plots_HCPD) <- lh_assoc_names
names(rh_plots_HCPD) <- rh_assoc_names

# arrange plots
age_effect_plots_HCPD <- arrange_ageeffect_plots(lh_plots_HCPD, rh_plots_HCPD)
grid.newpage()       
grid.draw(age_effect_plots_HCPD)
#ggsave(paste0(png_dir, "/", "HCPD", "/","dev.png"), age_effect_plots, height = 14, width = 14, units = "in")


lh_plots_HBN <- lapply(lh_assoc_names, plot_ageeffects, dataset="HBN", ylim1 = 0.1, ylim2 = 0.40)
rh_plots_HBN <- lapply(rh_assoc_names, plot_ageeffects, dataset="HBN", ylim1 = 0.1, ylim2 = 0.40)
names(lh_plots_HBN) <- lh_assoc_names
names(rh_plots_HBN) <- rh_assoc_names

# arrange plots
age_effect_plots_HBN <- arrange_ageeffect_plots(lh_plots_HBN, rh_plots_HBN)


lh_plots_PNC <- lapply(lh_assoc_names, plot_ageeffects, dataset="PNC", ylim1 = 0.1, ylim2 = 0.40)
rh_plots_PNC <- lapply(rh_assoc_names, plot_ageeffects, dataset="PNC", ylim1 = 0.1, ylim2 = 0.40)
names(lh_plots_PNC) <- lh_assoc_names
names(rh_plots_PNC) <- rh_assoc_names

# arrange plots
age_effect_plots_PNC <- arrange_ageeffect_plots(lh_plots_PNC, rh_plots_PNC)




grid.newpage()       
grid.draw(age_effect_plots_HCPD)

grid.newpage()       
grid.draw(age_effect_plots_HBN)

grid.newpage()       
grid.draw(age_effect_plots_PNC)
 
```

ted grant: ifo and sa ranks
```{r fig.height = 7, fig.width = 10}

glasser_SAaxis <- read.csv("/cbica/projects/luo_wm_dev/SAaxis/glasser_SAaxis.csv")
glasser_SAaxis <- glasser_SAaxis %>% select(SA.axis_rank, label)
glasser_SAaxis$regionName <- gsub("_ROI", "", glasser_SAaxis$label)
glasser_SAaxis$regionName <- gsub("^(.)_(.*)$", "\\2_\\1", glasser_SAaxis$region)
 
merged_IFOL <- merge(IFOL_deveffect_PNC, glasser_SAaxis,  by = "regionName") %>% select(-label)
merged_IFOL_all <- merged_IFOL %>% mutate(SA.axis_rank = ifelse(is.na(mean_age_effect), NA, SA.axis_rank))
merged_IFOR <- merge(IFOR_deveffect_PNC, glasser_SAaxis,  by = "regionName") %>% select(-label)
merged_IFOR_all <- merged_IFOR %>% mutate(SA.axis_rank = ifelse(is.na(mean_age_effect), NA, SA.axis_rank))

merged_IFOL_mean <- merged_IFOL %>% group_by(end) %>% 
  mutate(mean_SA = mean(SA.axis_rank, na.rm = TRUE)) %>% 
  ungroup() %>%
  mutate(SA.axis_rank = ifelse(is.na(mean_age_effect), NA, mean_SA)) %>%  # Replace SA.axis_rank where mean_age_effect is NA
  select(-mean_SA)

merged_IFOR_mean <- merged_IFOR %>% group_by(end) %>% 
  mutate(mean_SA = mean(SA.axis_rank, na.rm = TRUE)) %>% 
  ungroup() %>%
  mutate(SA.axis_rank = ifelse(is.na(mean_age_effect), NA, mean_SA)) %>%  # Replace SA.axis_rank where mean_age_effect is NA
  select(-mean_SA)
  
plot_SA_surface <- function(bundle_name, df) {
  if(grepl("L$", bundle_name)) {
    hemi = "left"
    cortical_pos1 <- "left lateral" 
    cortical_pos2 <- "left medial"
  } else{
    hemi = "right"
    cortical_pos1 <- "right lateral" 
    cortical_pos2 <- "right medial"
  }
  
 
 
  plot_lateral <- ggplot() + 
      geom_brain(data = df, atlas= glasser, 
                 mapping=aes(fill=SA.axis_rank), 
                 show.legend=TRUE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos1)) +
    scale_color_gradient2(low = "goldenrod1", mid = "#dfd3e8", high = "#6f1282", guide = "colorbar", aesthetics = "fill", 
                          midpoint =  180, na.value = "white", limits = c(0, 360), oob = squish) + 
    theme_void() +
      theme(legend.position = "none",
                  legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.01, 0.1, 0.1), "cm"),
            plot.title = element_blank()) 
  
   plot_medial <- ggplot() + 
      geom_brain(data = df, atlas= glasser, 
                 mapping=aes(fill=SA.axis_rank), 
                 show.legend=TRUE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos2)) +
    scale_color_gradient2(low = "goldenrod1", mid = "#dfd3e8", high = "#6f1282", guide = "colorbar", aesthetics = "fill", 
                          midpoint =  180, na.value = "white", limits = c(0, 360), oob = squish) + 
    theme_void() +
      theme(legend.position = "none",
                  legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.1, 0.1, 0.01), "cm"),
            plot.title = element_blank())

 return( plot_grid(plot_lateral, plot_medial))
             
}
 

plot_legend <- ggplot() + 
      geom_brain(data = merged_IFOL_all, atlas= glasser, 
                 mapping=aes(fill=SA.axis_rank), 
                 show.legend=TRUE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos1)) +
    scale_color_gradient2(low = "goldenrod1", mid = "#dfd3e8", high = "#6f1282", guide = "colorbar", aesthetics = "fill", 
                          midpoint =  180, na.value = "white", limits = c(0, 360), oob = squish) + 
    theme_void() +
      theme(legend.position = "bottom",
            legend.title = element_blank(),
            legend.text = element_text(size = 20),
            legend.key.width = unit(2, 'cm'), legend.key.height = unit(1, 'cm'),
            plot.margin = unit(c(0.1, 0.01, 0.1, 0.1), "cm"),
            
            plot.title = element_blank()) 
  
legend <- get_legend(plot_legend)
map_IFOL_all <- plot_SA_surface("IFOL", merged_IFOL_all)
map_IFOR_all <- plot_SA_surface("IFOR", merged_IFOR_all)

map_IFOL_mean <- plot_SA_surface("IFOL", merged_IFOL_mean)
map_IFOR_mean <- plot_SA_surface("IFOR", merged_IFOR_mean)


ggarrange(map_IFOL_all, map_IFOR_all, legend, nrow = 3, heights = c(1, 1, 0.4))
ggarrange(map_IFOL_mean, map_IFOR_mean, legend, nrow = 3, heights = c(1, 1, 0.4))
```



```{r arc and ifo}
IFOL_deveffect_HCPD # bin5, clip5: 0.25 and 0.15 (diff 0.1); bin5, clip3: 0.27 and 0.19 (diff 0.08)
# bin10, clip5: 0.23 and 0.11 (diff 0.12) ; bin10, clip3: 0.25 and 0.14 (diff 0.11)

IFOL_deveffect_HBN # bin5, clip5: 0.136 and 0.08 (diff 0.05-06); bin5, clip3: 0.16 and 0.12 (diff 0.04)
# bin10, clip5: 0.098 and 0.06 (diff 0.03 to 04); bin10, clip3:  0.12 and 0.09 (diff 0.03)

IFOL_deveffect_PNC # bin5, clip5: 0.11 and 0.20 (diff 0.09); bin5, clip3: 0.22 and 0.15 (diff 0.07)
# bin10, clip5: 0.18 and 0.076 (diff 0.1) ; bin10, clip3: 0.197 and 0.11 (diff 0.09)



IFOR_deveffect_HCPD # bin5, clip5: 0.25 and 0.13 (diff 0.12); bin5, clip3: 0.18 and 0.27 (diff 0.09)
# bin10, clip5: 0.23 and 0.08 (diff 0.15) ; bin10, clip3: 0.25 and 0.12 (diff 0.13)

IFOR_deveffect_HBN # bin5, clip5: 0.14 and 0.13 (diff 0.01); bin5, clip3: 0.16 and 0.21 (diff 0.05)
# bin10, clip5: 0.096 and 0.093 (diff 0.002); bin10, clip3: 0.12 and 0.14 (diff 0.02)

IFOR_deveffect_PNC # bin5, clip5: 0.23 and 0.13 (diff 0.1); bin5, clip3: 0.25 and 0.17 (diff 0.08)
# bin10, clip5: 0.09 and 0.2 (diff 0.11); bin10, clip3: 0.22 and 0.12 (diff 0.1)


# bin5, clip5: HCPD - 0.11; PNC - 0.095; HBN - 0.035
# bin5, clip3:  HCPD - 0.085; PNC - 0.075 -- NO
# bin10, clip5: HCPD - 0.135; PNC - 0.105; HBN - realy small but w/e
# bin10, clip3: HCPD - 0.12; PNC - 0.095; HBN eally small
# bin10, clip5 is probably best

ARCL_plot_HCPD <- plot_ageeffects("ARCL", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)  
ARCR_plot_HCPD <- plot_ageeffects("ARCR", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41) 
ARCL_plot_HBN <- plot_ageeffects("ARCL", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41) 
ARCR_plot_HBN <- plot_ageeffects("ARCR", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41) 
ARCL_plot_PNC <- plot_ageeffects("ARCL", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41) 
ARCR_plot_PNC <- plot_ageeffects("ARCR", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41) 

IFOL_plot_HCPD <- plot_ageeffects("IFOL", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41) 
IFOR_plot_HCPD <- plot_ageeffects("IFOR", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41) 
IFOL_plot_HBN <- plot_ageeffects("IFOL", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41) 
IFOR_plot_HBN <- plot_ageeffects("IFOR", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41) 
IFOL_plot_PNC <- plot_ageeffects("IFOL", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41) 
IFOR_plot_PNC <- plot_ageeffects("IFOR", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41) 
 

ARCL_plot_HCPD
ARCR_plot_HCPD
ARCL_plot_HBN
ARCR_plot_HBN
ARCL_plot_PNC
ARCR_plot_PNC

IFOL_plot_HCPD
IFOR_plot_HCPD
IFOL_plot_HBN
IFOR_plot_HBN
IFOL_plot_PNC
IFOR_plot_PNC
```

fitted smooths
```{r load smooths}
HCPD_GAM_smoothcentered <- read.csv("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/GAM/dti_md/HCPD_GAM_smoothcentered.csv")
HBN_GAM_smoothcentered <- read.csv("/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/GAM/dti_md/HBN_GAM_smoothcentered.csv")
PNC_GAM_smoothcentered <- read.csv("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/GAM/dti_md/PNC_GAM_smoothcentered.csv")
```

```{r format smooths}
# format age effect df's
format_smooths <- function(df) {
  # add tractID, tract_label, and nodeID
  df <- df %>% mutate(hemi = ifelse(grepl("Left", tract_node), "Left", 
                                    ifelse(grepl("Right", tract_node), "Right", NA))) %>%
    mutate(tractID = gsub("_[0-9]+", "", tract_node)) %>%
    mutate(tract_label = gsub("Left |Right ", "", gsub("_", " ", tractID))) %>%
    mutate(nodeID = str_extract(tract_node, "[0-9]+")) 
  df$nodeID <- as.numeric(df$nodeID)
  df$tract_label <- gsub("\\.", "-", df$tract_label) 
  # label main orientation
  df <- df %>% 
  mutate(main_orientation = case_when(
    tract_label %in% c("Anterior Thalamic", "Cingulum Cingulate", "Inferior Fronto-occipital",
                   "Inferior Longitudinal", "Superior Longitudinal") ~ "AP",
    tract_label %in% c("Arcuate", "Uncinate") ~ "AP_frontal_temporal",
    tract_label %in% c("Callosum Anterior Frontal", "Callosum Motor", "Callosum Occipital", "Callosum Orbital", 
                       "Callosum Posterior Parietal", "Callosum Superior Frontal", "Callosum Superior Parietal", "Callosum Temporal") ~ "RL",
    tract_label %in% c("Corticospinal", "Posterior Arcuate","Vertical Occipital") ~ "SI",
    TRUE ~ NA_character_
  ))
  df$main_orientation <- as.factor(df$main_orientation)
  df <- df %>% relocate(tract_label, tractID, nodeID, tract_node, hemi, main_orientation)
  return(df)
}

HCPD_smooths <- format_smooths(HCPD_GAM_smoothcentered)
HBN_smooths <- format_smooths(HBN_GAM_smoothcentered)
PNC_smooths <- format_smooths(PNC_GAM_smoothcentered)
```
 

```{r function for smooths binned}


color1 = "#C73000FF"
color2 = "#009DA8FF"
plot_smooths_binned <- function(tract, df, bin_num_nodes, clipEnds, end1, end2) {
  df$nodeID <- as.numeric(df$nodeID)
  df <- df %>% filter(tract_label == tract) %>% 
    filter(nodeID > (clipEnds-1) & nodeID < (99-clipEnds+1)) %>%
    group_by(tract_node)
  
 
  df_binned <- df %>%
        filter(
          nodeID < (bin_num_nodes + clipEnds) | 
          nodeID > (99 - bin_num_nodes - clipEnds))  %>%
        mutate(
          node_position = case_when(
            nodeID < bin_num_nodes + clipEnds ~ end1,
            nodeID > 99 - bin_num_nodes - clipEnds ~ end2,
            TRUE ~ NA_character_
          )
        ) %>%
        group_by(node_position, age) %>%  
        summarise(
          mean_est = mean(est, na.rm = TRUE)
        )
  
  if (str_detect(tract, "Callosum")) {
    plot <- ggplot(df_binned, aes(x = age, y = mean_est)) +
      geom_line(aes(colour = node_position), size = 3.5, alpha = 0.9) + 
      theme_classic() +                         
      theme(text=element_text(size=24),
            axis.text.x = element_text(size=24),
            axis.text.y = element_text(size=24),
            legend.position = "none",
            legend.box = "vertical",
            legend.key.width = unit(2, 'cm'), legend.key.height = unit(1, 'cm'),
            plot.title = element_text(hjust=0.5, size = 24)) +
      scale_colour_manual(values = setNames(c(color1, color2), c(end1, end2)), na.value = "grey50") + ylim(-0.00007, 0.00006) + 
      labs(x = "", y = "", colour = "")  
  } else {
    plot <- ggplot(df_binned, aes(x = age, y = mean_est)) +
      geom_line(aes(colour = node_position), size = 3.5, alpha = 0.9) + 
      theme_classic() +                         
      theme(text=element_text(size=24),
            axis.text.x = element_text(size=24),
            axis.text.y = element_text(size=24),
            legend.position = "none",
            legend.box = "vertical",
            legend.key.width = unit(2, 'cm'), legend.key.height = unit(1, 'cm'),
            plot.title = element_text(hjust=0.5, size = 24)) +
      scale_colour_manual(values = setNames(c(color1, color2), c(end1, end2)), na.value = "grey50") + ylim(-0.00007, 0.00006) + 
      labs(x = "", y = "", colour = "")  
  }
  
   return(plot)
}


#orbital => antfrontal => supfrontal => motor => sup parietal => postparietal => temporal => occipital, to better detect any anterior=>posterior progression

 
 
 
```



```{r plot binned smooths}
bin_num_nodes = 5
clipEnds = 3

association <- unique(HCPD_smooths$tract_label)[!str_detect(unique(HCPD_smooths$tract_label), "Callosum")]
callosum <- unique(HCPD_smooths$tract_label)[str_detect(unique(HCPD_smooths$tract_label), "Callosum")]

# plot association bundles (arc and ifo)
assoc_plots_HCPD <- lapply(association, plot_smooths_binned, df = HCPD_smooths, 
                              bin_num_nodes = bin_num_nodes, clipEnds = clipEnds, end1 = "Anterior", end2 = "Posterior")
names(assoc_plots_HCPD) <- association

assoc_plots_HBN <- lapply(association, plot_smooths_binned, df = HBN_smooths, 
                              bin_num_nodes = bin_num_nodes, clipEnds = clipEnds, end1 = "Anterior", end2 = "Posterior")
names(assoc_plots_HBN) <- association

assoc_plots_PNC <- lapply(association, plot_smooths_binned, df = PNC_smooths, 
                              bin_num_nodes = bin_num_nodes, clipEnds = clipEnds, end1 = "Anterior", end2 = "Posterior")
names(assoc_plots_PNC) <- association


# plot callosum bundles
callosum_plots_HCPD <- lapply(callosum, plot_smooths_binned, df = HCPD_smooths, 
                              bin_num_nodes = bin_num_nodes, clipEnds = clipEnds, end1 = "Right", end2 = "Left")
names(callosum_plots_HCPD) <- callosum

callosum_plots_HBN <- lapply(callosum, plot_smooths_binned, df = HBN_smooths, 
                              bin_num_nodes = bin_num_nodes, clipEnds = clipEnds, end1 = "Right", end2 = "Left")
names(callosum_plots_HBN) <- callosum

callosum_plots_PNC <- lapply(callosum, plot_smooths_binned, df = PNC_smooths, 
                              bin_num_nodes = bin_num_nodes, clipEnds = clipEnds, end1 = "Right", end2 = "Left")
names(callosum_plots_PNC) <- callosum
 
```


```{r load fitted values and tract profiles data and derivatives}

HCPD <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_viz.RData", output_root, "HCPD"))
HCPD_dem <- read.csv("/cbica/projects/luo_wm_dev/input/HCPD/sample_selection_files/final_sample/HCPD_WMDev_FinalSampleDemoQC.csv")
HCPD <- merge(HCPD, HCPD_dem, by = 'sub')
HCPD_fitted <- read.csv("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/GAM/dti_md/HCPD_GAM_smooth_fittedvalues.csv")
HCPD_derivs <- read.csv("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/GAM/dti_md/HCPD_GAM_derivatives.csv")
HCPD_derivs$significant.derivative[HCPD_derivs$significant.derivative == 0] <- NA

HBN <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_viz.RData", output_root, "HBN"))
HBN_dem <- read.csv("/cbica/projects/luo_wm_dev/input/HBN/sample_selection_files/final_sample/HBN_WMDev_FinalSampleDemoQC.csv")
HBN <- merge(HBN, HBN_dem, by = 'sub')
HBN_fitted <- read.csv("/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/GAM/dti_md/HBN_GAM_smooth_fittedvalues.csv")
HBN_derivs <- read.csv("/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/GAM/dti_md/HBN_GAM_derivatives.csv")
HBN_derivs$significant.derivative[HBN_derivs$significant.derivative == 0] <- NA


PNC <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_viz.RData", output_root, "PNC"))
PNC_dem <- read.csv("/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/final_sample/PNC_WMDev_FinalSampleDemoQC.csv")
PNC <- merge(PNC, PNC_dem, by = 'sub')
PNC_fitted <- read.csv("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/GAM/dti_md/PNC_GAM_smooth_fittedvalues.csv")
PNC_derivs <- read.csv("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/GAM/dti_md/PNC_GAM_derivatives.csv")
PNC_derivs$significant.derivative[PNC_derivs$significant.derivative == 0] <- NA

 

format_fitted <- function(df) {
  # add tractID, tract_label, and nodeID
  df <- df %>% mutate(tractID = gsub("_[0-9]+", "", tract)) %>%
    mutate(tract_label = gsub("Left |Right ", "", gsub("_", " ", tractID))) %>%
    mutate(nodeID = str_extract(tract, "[0-9]+")) %>% 
    mutate(hemi = ifelse(grepl("Left", tractID), "Left", 
                                    ifelse(grepl("Right", tractID), "Right", NA)))  
  df$nodeID <- as.numeric(df$nodeID)
  df$tract_label <- gsub("\\.", "-", df$tract_label) 
  # label main orientation
  df <- df %>% 
  mutate(main_orientation = case_when(
    tract_label %in% c("Anterior Thalamic", "Cingulum Cingulate", "Inferior Fronto-occipital",
                   "Inferior Longitudinal", "Superior Longitudinal") ~ "AP",
    tract_label %in% c("Arcuate", "Uncinate") ~ "AP_frontal_temporal",
    tract_label %in% c("Callosum Anterior Frontal", "Callosum Motor", "Callosum Occipital", "Callosum Orbital", 
                       "Callosum Posterior Parietal", "Callosum Superior Frontal", "Callosum Superior Parietal", "Callosum Temporal") ~ "RL",
    tract_label %in% c("Corticospinal", "Posterior Arcuate","Vertical Occipital") ~ "SI",
    TRUE ~ NA_character_
  ))
  df$main_orientation <- as.factor(df$main_orientation)
  df <- df %>% relocate(tract_label, tractID, nodeID, hemi, main_orientation)
  return(df)
}


HCPD_fitted <- format_fitted(HCPD_fitted)
HBN_fitted <- format_fitted(HBN_fitted)
PNC_fitted <- format_fitted(PNC_fitted)

HCPD_derivs <- format_smooths(HCPD_derivs)
HBN_derivs <- format_smooths(HBN_derivs)
PNC_derivs <- format_smooths(PNC_derivs)

```


```{r}



color1 = "#3FB8AFFF"
color2 = "#FF9E9DFF"
color3 = "#cc0468"


color1 = "#C73000FF"
color2 = "#009DA8FF"
 
dev_trajectory_plot <- function(dataset, tp_df, tract_name, fitted_df, derivs_df, end1, end2, clipEnds, bin_num_nodes) {
 
  df <- tp_df %>% dplyr::filter(tract_label == tract_name) %>% filter(nodeID > (clipEnds-1) & nodeID < (99-clipEnds+1))
  df_binned <- df %>%
        filter(
          nodeID < (bin_num_nodes + clipEnds) | 
          nodeID > (99 - bin_num_nodes - clipEnds))  %>%
        mutate(
          node_position = case_when(
            nodeID < bin_num_nodes + clipEnds ~ end1,
            nodeID > 99 - bin_num_nodes - clipEnds ~ end2,
            TRUE ~ NA_character_
          )
        )
  
  fitted_df <- fitted_df %>% dplyr::filter(tract_label == tract_name) %>% filter(nodeID > (clipEnds-1) & nodeID < (99-clipEnds+1))
  fitted_df_binned <- fitted_df %>%
        filter(
          nodeID < (bin_num_nodes + clipEnds) | 
          nodeID > (99 - bin_num_nodes - clipEnds))  %>%
        mutate(
          node_position = case_when(
            nodeID < bin_num_nodes + clipEnds ~ end1,
            nodeID > 99 - bin_num_nodes - clipEnds ~ end2,
            TRUE ~ NA_character_
          )
        ) %>%
        group_by(tract_label, node_position, age) %>%  
        summarise(
          mean_fitted = mean(fitted, na.rm = TRUE),
          n = sum(!is.na(fitted)),   
          lower = mean_fitted - (sd(fitted, na.rm = TRUE) / sqrt(n)),  
          upper = mean_fitted + (sd(fitted, na.rm = TRUE) / sqrt(n)) 
        )
 
 
  derivs_df <- derivs_df  %>% filter(tract_label == tract_name) %>% filter(nodeID > (clipEnds-1) & nodeID < (99-clipEnds+1))
  derivatives.df <- derivs_df %>%
        filter(
          nodeID < (bin_num_nodes + clipEnds) | 
          nodeID > (99 - bin_num_nodes - clipEnds))  %>%
        mutate(
          node_position = case_when(
            nodeID < bin_num_nodes + clipEnds ~ end1,
            nodeID > 99 - bin_num_nodes - clipEnds ~ end2,
            TRUE ~ NA_character_
          )
        )
  
  # trajectory plot
  title = gsub("PD", "P-D", dataset)
  trajectory.plot <- ggplot(data = df_binned, aes(x = age, y = dti_md, color = node_position)) +
    geom_point(aes(alpha = hemi), size = 0.1, alpha = 0.05) +
    geom_line(data = fitted_df_binned, aes(x = age, y = mean_fitted, color = node_position), linewidth = 1) +
    geom_ribbon(data = fitted_df_binned, aes(x = age, y = mean_fitted,  ymin = lower, ymax = upper, fill = node_position), alpha = 0.5, linetype = 0) +
    scale_colour_manual(values = setNames(c(color1, color2), c(end1, end2)), na.value = "grey50")  + 
    scale_fill_manual(values = setNames(c(color1, color2), c(end1, end2)), na.value = "grey50")  + 
    theme_classic()  + 
     scale_x_continuous(limits = c(5, 23), expand = c(0.025,.45))  + ylim(0.0006, 0.0011) + 
    theme(plot.title = element_text(size = 20, hjust = 0.5),
        legend.position = "none", 
        legend.text = element_text(size = 20),
        axis.text = element_text(size = 20),
        axis.title.x = element_blank(), 
        axis.title.y = element_blank()) + labs(color = "", fill = "", title = title) + guides(fill=guide_legend(ncol=1))
  
  # significant derivatives (rate of age-related change) plot 
  derivatives.df_end1 <- derivatives.df %>% filter(node_position == end1)
  derivatives.df_end2 <- derivatives.df %>% filter(node_position == end2)
  
  derivatives_end1.plot <- ggplot(data = derivatives.df_end1) + 
  geom_tile(aes(x = age, y = .1, fill = significant.derivative)) + 
  scale_fill_gradient2(low = alpha(color1, 0.2), high = color1, na.value = "white") + 
    scale_x_continuous(limits = c(5, 23), expand = c(0.025,.45)) + 
  theme_classic() + 
  theme(legend.position = "none",
    axis.title.y = element_blank(),
    axis.text = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    plot.margin = margin(-5, 0, -1, 0))

 
  derivatives_end2.plot <- ggplot(data = derivatives.df_end2) + 
    geom_tile(aes(x = age, y = .1, fill = significant.derivative)) + 
    scale_fill_gradient2(low = alpha(color2, 0.2), high = color2, na.value = "white") + 
    scale_x_continuous(limits = c(5, 23), expand = c(0.025,.45)) + 
    theme_classic() + 
    theme(legend.position = "none",
      axis.title.y = element_blank(),
      axis.text = element_blank(),
      axis.line = element_blank(),
      axis.ticks = element_blank(),
      axis.title = element_blank(),
      plot.margin = margin(-5, 0, -1, 0))
     allplots <- list(trajectory.plot, derivatives_end1.plot, derivatives_end2.plot)
    tract.plot <- plot_grid(rel_heights = c(16, 2, 2), plotlist = allplots, align = "v", axis = "tb", ncol = 1)
    
    tract.plot <- ggdraw() + draw_plot(tract.plot, 0, 0.1, 1, 0.9) + draw_label("Age (years)", x = 0.5, y = 0.05, size = 20, hjust = 0.5)
 
    return(tract.plot)
    
}

```


```{r fitted values and derivs ifo, fig.height = 15, fig.width = 15}

 
HCPD_ifo_devtraj <- dev_trajectory_plot("HCPD", tp_df = HCPD, tract_name = "Inferior Fronto-occipital", fitted_df = HCPD_fitted, derivs_df = HCPD_derivs, "Frontal", "Occipital", clipEnds = 5, bin_num_nodes = 5) 
HBN_ifo_devtraj <- dev_trajectory_plot("HBN", tp_df = HBN, tract_name = "Inferior Fronto-occipital", fitted_df = HBN_fitted, derivs_df = HBN_derivs, "Frontal", "Occipital", clipEnds = 5, bin_num_nodes = 5) 
PNC_ifo_devtraj <- dev_trajectory_plot("PNC", tp_df = PNC, tract_name = "Inferior Fronto-occipital", fitted_df = PNC_fitted, derivs_df = PNC_derivs, "Frontal", "Occipital", clipEnds = 5, bin_num_nodes = 5) 


ifo_devtraj <- ggarrange(HCPD_ifo_devtraj + theme(plot.margin = margin(0, 30, 0, 0)), HBN_ifo_devtraj+ theme(plot.margin = margin(0, 30, 0, 0)), PNC_ifo_devtraj+ theme(plot.margin = margin(0, 30, 0, 0)) , ncol = 3)

y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90, y = unit(0.7, "npc"))
 
ifo_devtraj_final <- grid.arrange(arrangeGrob(ifo_devtraj, left = y.grob))




plot_NEST_IFO <- function(dataset) {
  IFO_bilateral <- rbind(get(paste0("IFOL_deveffect_", dataset)) %>% filter(end == "end1" | end == "end2"), get(paste0("IFOR_deveffect_", dataset)) %>% filter(end == "end1" | end == "end2"))
 
  NEST_df <- IFO_bilateral %>% group_by(end) %>% summarise(bilat_mean_age_effect = mean(mean_age_effect, na.rm = TRUE),
                                                     n = sum(!is.na(mean_age_effect)),
                                                     se_age_effect = sd(mean_age_effect, na.rm = TRUE) / sqrt(n)) %>% 
    mutate(endpoint_labels = case_when(
      end == "end1" ~ "Frontal \n (High Average S-A Rank)",
      end == "end2" ~ "Occipital \n (Low Average S-A Rank)",
      TRUE ~ NA_character_))
  
  NEST_plot <- ggplot(NEST_df, aes(x = endpoint_labels, y = bilat_mean_age_effect, group = 1)) +
    geom_line(size = 1, color = "black", alpha = 0.7) +
    geom_point(aes(color = endpoint_labels, fill = end), size = 8) +
    geom_errorbar(aes(ymin = bilat_mean_age_effect - se_age_effect,
                      ymax = bilat_mean_age_effect + se_age_effect,
                      color = endpoint_labels),
                  width = 0.05, size = 1, alpha = 0.7) +
    scale_color_manual(values = setNames(c(color1, color2), c("Frontal \n (High Average S-A Rank)", 
                                                              "Occipital \n (Low Average S-A Rank)"))) + 
     theme(legend.position = "none",
           axis.title.x = element_blank(),
           axis.title.y = element_blank(),
           axis.text.x = element_text(size = 12),
           axis.text.y = element_text(size = 12),
           plot.margin = margin(40, 0, 0, 0)) + ylim(0.065, 0.4)
  
  return(NEST_plot)
}

  

NEST_HCPD_IFO <- plot_NEST_IFO("HCPD")
NEST_HBN_IFO <- plot_NEST_IFO("HBN")
NEST_PNC_IFO <- plot_NEST_IFO("PNC")

NEST_IFO <- ggarrange(NEST_HCPD_IFO, NEST_HBN_IFO, NEST_PNC_IFO, ncol = 3)



y.grob <- textGrob(expression(paste("Age Effect (Delta Adj", " R"^2, ")")), 
                   gp=gpar(col="black", fontsize=20), rot=90)
 

NEST_IFO <- grid.arrange(arrangeGrob(NEST_IFO, left = y.grob))

ifo_redblue_plots <- ggarrange(ifo_devtraj_final, NEST_IFO, nrow = 2, heights = c(4,2))


# legend 1
df <- data.frame(x = c(1, 2, 3, 4, 5, 6), y = c(4, 5, 6, 7, 8, 9), region = c("Frontal", "Frontal", "Frontal", "Occipital", "Occipital", "Occipital"))
p <- ggplot(df, aes(x = x, y = y, color = region)) +
  geom_point(size = 5) +  
  scale_color_manual(
    values = c("Frontal" = color1, "Occipital" = color2)) +
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 20)) + guides(fill=guide_legend(ncol=1)) + 
  labs(color = "")  # Set legend title
legend1 <- get_legend(p)

ifo_devtraj_legend <- ggarrange(ifo_redblue_plots, legend1, nrow = 2, heights = c(5, 1))
ifo_devtraj_legend
```

```{r ifo fitted and maps, fig.height = 12, fig.width = 15}

IFO_plots_HCPD <- plot_grid(IFOL_plot_HCPD + theme(plot.margin = margin(0, 20, -10, 70)), IFOR_plot_HCPD + theme(plot.margin = margin(0, 20, -10, 70)), nrow = 2)
IFO_plots_HBN <- plot_grid(IFOL_plot_HBN + theme(plot.margin = margin(0, 20, -10, 70)), IFOR_plot_HBN + theme(plot.margin = margin(0, 20, -10, 70)), nrow = 2)
IFO_plots_PNC <- plot_grid(IFOL_plot_PNC + theme(plot.margin = margin(0, 20, -10, 70)), IFOR_plot_PNC + theme(plot.margin = margin(0, 20, -10, 70)), nrow = 2)

IFO_plots <- plot_grid(IFO_plots_HCPD, IFO_plots_HBN, IFO_plots_PNC, ncol = 3)

 
# legend2
ifo_legend_plot <- ggplot() + geom_brain(data = IFOL_deveffect_HCPD, atlas= glasser, 
                 mapping=aes(fill=mean_age_effect), 
                 show.legend=TRUE, 
                 hemi = "left",
                 position = position_brain("left medial")) +
    paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1 , limits = c(0.08, 0.41), oob = squish, na.value = "white") +
    theme_void() +
      theme(legend.position = "bottom",
                  legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.01, 0.1, 0.1), "cm"),
            plot.title = element_blank()) 
  
legend2 <- get_legend(ifo_legend_plot + theme(legend.position = "bottom",
                                              legend.key.height = unit(1, 'cm'),
                                              legend.key.width = unit(2, 'cm'),
                                              legend.margin=margin(-50,0,0,0),
                                              legend.text = element_text(size=20),
                                              legend.title = element_blank()))
IFO_all <- ggarrange(ifo_devtraj_legend, IFO_plots, nrow = 2, heights = c(3, 1))
legend_title <- textGrob(expression(paste("Age Effect (Delta Adj", " R"^2, ")")), 
                     gp=gpar(col="black", fontsize=20), hjust = 0.5, vjust = 0, y = unit(-2, "npc"))
    
legend_with_title <- plot_grid(legend_title, legend2, ncol = 1, rel_heights = c(1, 2))
 
grid.arrange(IFO_all, legend_with_title, ncol = 1, nrow = 2, heights = c(6, 1))
    


```


```{r fitted values and derivs Mot, fig.height = 7, fig.width = 15}

 
HCPD_CMot_devtraj <- dev_trajectory_plot("HCPD", tp_df = HCPD, tract_name = "Callosum Motor", fitted_df = HCPD_fitted, derivs_df = HCPD_derivs, "Right", "Left", clipEnds = 5, bin_num_nodes = 5) 
HBN_CMot_devtraj <- dev_trajectory_plot("HBN", tp_df = HBN, tract_name = "Callosum Motor", fitted_df = HBN_fitted, derivs_df = HBN_derivs, "Right", "Left", clipEnds = 5, bin_num_nodes = 5) 
PNC_CMot_devtraj <- dev_trajectory_plot("PNC", tp_df = PNC, tract_name = "Callosum Motor", fitted_df = PNC_fitted, derivs_df = PNC_derivs, "Right", "Left", clipEnds = 5, bin_num_nodes = 5)

CMot_devtraj <- ggarrange(HCPD_CMot_devtraj + theme(plot.margin = margin(0, 30, 0, 0)), HBN_CMot_devtraj + theme(plot.margin = margin(0, 30, 0, 0)), PNC_CMot_devtraj + theme(plot.margin = margin(0, 30, 0, 0)), ncol = 3)


y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90, y = unit(0.7, "npc"))
 

CMot_devtraj_final <- grid.arrange(arrangeGrob(CMot_devtraj, left = y.grob))





plot_NEST_CMot <- function(dataset) {
  CMot_bilateral <- rbind(get(paste0("CMotL_deveffect_", dataset)) %>% filter(end == "end1" | end == "end2"), get(paste0("CMotR_deveffect_", dataset)) %>% filter(end == "end1" | end == "end2"))
 
  NEST_df <- CMot_bilateral %>% group_by(end) %>% summarise(bilat_mean_age_effect = mean(mean_age_effect, na.rm = TRUE),
                                                     n = sum(!is.na(mean_age_effect)),
                                                     se_age_effect = sd(mean_age_effect, na.rm = TRUE) / sqrt(n)) %>% 
    mutate(endpoint_labels = case_when(
      end == "end1" ~ "Right Hemisphere",
      end == "end2" ~ "Left Hemisphere",
      TRUE ~ NA_character_))
  
  NEST_plot <- ggplot(NEST_df, aes(x = endpoint_labels, y = bilat_mean_age_effect, group = 1)) +
    geom_line(size = 1, color = "black", alpha = 0.7) +
    geom_point(aes(color = endpoint_labels, fill = end), size = 8) +
    geom_errorbar(aes(ymin = bilat_mean_age_effect - se_age_effect,
                      ymax = bilat_mean_age_effect + se_age_effect,
                      color = endpoint_labels),
                  width = 0.05, size = 1, alpha = 0.7) +
    scale_color_manual(values = setNames(c(color1, color2), c("Right Hemisphere", 
                                                              "Left Hemisphere"))) + 
     theme(legend.position = "none",
           axis.title.x = element_blank(),
           axis.title.y = element_blank(),
           axis.text.x = element_text(size = 12),
           axis.text.y = element_text(size = 12),
           plot.margin = margin(40, 0, 0, 0)) + ylim(0.065, 0.4)
  
  return(NEST_plot)
}

  

NEST_HCPD_CMot <- plot_NEST_CMot("HCPD")
NEST_HBN_CMot <- plot_NEST_CMot("HBN")
NEST_PNC_CMot <- plot_NEST_CMot("PNC")

NEST_CMot <- ggarrange(NEST_HCPD_CMot, NEST_HBN_CMot, NEST_PNC_CMot, ncol = 3)



y.grob <- textGrob(expression(paste("Age Effect (Delta Adj", " R"^2, ")")), 
                   gp=gpar(col="black", fontsize=20), rot=90)
 

NEST_CMot <- grid.arrange(arrangeGrob(NEST_CMot, left = y.grob))

CMot_redblue_plots <- ggarrange(CMot_devtraj_final, NEST_CMot, nrow = 2, heights = c(4,2))


# legend 1
df <- data.frame(x = c(1, 2, 3, 4, 5, 6), y = c(4, 5, 6, 7, 8, 9), region = c("Right", "Right", "Right", "Left", "Left", "Left"))
p <- ggplot(df, aes(x = x, y = y, color = region)) +
  geom_point(size = 5) +  
  scale_color_manual(
    values = c("Right" = color1, "Left" = color2)) +
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 20)) + guides(fill=guide_legend(ncol=1)) + 
  labs(color = "")  # Set legend title
legend1 <- get_legend(p)

CMot_devtraj_legend <- ggarrange(CMot_redblue_plots, legend1, nrow = 2, heights = c(5, 1))
CMot_devtraj_legend
```


```{r cc}
CMotL_plot_HCPD <- plot_ageeffects("CMotL", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)  
CMotR_plot_HCPD <- plot_ageeffects("CMotR", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)
CMotL_plot_HBN <- plot_ageeffects("CMotL", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
CMotR_plot_HBN <- plot_ageeffects("CMotR", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
CMotL_plot_PNC <- plot_ageeffects("CMotL", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)
CMotR_plot_PNC <- plot_ageeffects("CMotR", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)



CSupParL_plot_HCPD <- plot_ageeffects("CSupParL", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)
CSupParR_plot_HCPD <- plot_ageeffects("CSupParR", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)
CSupParL_plot_HBN <- plot_ageeffects("CSupParL", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
CSupParR_plot_HBN <- plot_ageeffects("CSupParR", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
CSupParL_plot_PNC <- plot_ageeffects("CSupParL", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)
CSupParR_plot_PNC <- plot_ageeffects("CSupParR", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)
 
```

```{r Mot fitted and maps, fig.height = 12, fig.width = 15}

CMot_devtraj_final <- grid.arrange(arrangeGrob(CMot_devtraj, left = y.grob))

CMot_plots_HCPD <- plot_grid(CMotL_plot_HCPD + theme(plot.margin = margin(15, 20, -10, 70)), CMotR_plot_HCPD + theme(plot.margin = margin(15, 20, -10, 70)), nrow = 2)
CMot_plots_HBN <- plot_grid(CMotL_plot_HBN + theme(plot.margin = margin(15, 20, -10, 70)), CMotR_plot_HBN + theme(plot.margin = margin(15, 20, -10, 70)), nrow = 2)
CMot_plots_PNC <- plot_grid(CMotL_plot_PNC + theme(plot.margin = margin(15, 20, -10, 70)), CMotR_plot_PNC + theme(plot.margin = margin(15, 20, -10, 70)), nrow = 2)

CMot_plots <- plot_grid(CMot_plots_HCPD, CMot_plots_HBN, CMot_plots_PNC, ncol = 3)

 
CMot_all <- ggarrange(CMot_devtraj_final, CMot_plots, nrow = 2, heights = c(3, 3))



# legend2
CMot_legend_plot <- ggplot() + geom_brain(data = CMotL_deveffect_HCPD, atlas= glasser, 
                 mapping=aes(fill=mean_age_effect), 
                 show.legend=TRUE, 
                 hemi = "left",
                 position = position_brain("left medial")) +
    paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1 , limits = c(0.08, 0.41), oob = squish, na.value = "white") +
    theme_void() +
      theme(legend.position = "bottom",
                  legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.01, 0.1, 0.1), "cm"),
            plot.title = element_blank()) 
  
legend2 <- get_legend(CMot_legend_plot + theme(legend.position = "bottom",
                                              legend.key.height = unit(1, 'cm'),
                                              legend.key.width = unit(2, 'cm'),
                                              legend.margin=margin(-50,0,0,0),
                                              legend.text = element_text(size=20),
                                              legend.title = element_blank()))
CMot_all <- ggarrange(CMot_devtraj_legend, CMot_plots, nrow = 2, heights = c(3, 1))
legend_title <- textGrob(expression(paste("Age Effect (Delta Adj", " R"^2, ")")), 
                     gp=gpar(col="black", fontsize=20), hjust = 0.5, vjust = 0, y = unit(-2, "npc"))
    
legend_with_title <- plot_grid(legend_title, legend2, ncol = 1, rel_heights = c(1, 2))
 
grid.arrange(CMot_all, legend_with_title, ncol = 1, nrow = 2, heights = c(6, 1))
    

 
```


```{r fitted values and derivs CSupPar, fig.height = 7, fig.width = 15}

 
HCPD_CSupPar_devtraj <- dev_trajectory_plot("HCPD", tp_df = HCPD, tract_name = "Callosum Superior Parietal", fitted_df = HCPD_fitted, derivs_df = HCPD_derivs, "Right", "Left", clipEnds = 5, bin_num_nodes = 5) 
HBN_CSupPar_devtraj <- dev_trajectory_plot("HBN", tp_df = HBN, tract_name = "Callosum Superior Parietal", fitted_df = HBN_fitted, derivs_df = HBN_derivs, "Right", "Left", clipEnds = 5, bin_num_nodes = 5) 
PNC_CSupPar_devtraj <- dev_trajectory_plot("PNC", tp_df = PNC, tract_name = "Callosum Superior Parietal", fitted_df = PNC_fitted, derivs_df = PNC_derivs, "Right", "Left", clipEnds = 5, bin_num_nodes = 5)

CSupPar_devtraj <- ggarrange(HCPD_CSupPar_devtraj + theme(plot.margin = margin(0, 30, 0, 0)), HBN_CSupPar_devtraj + theme(plot.margin = margin(0, 30, 0, 0)), PNC_CSupPar_devtraj + theme(plot.margin = margin(0, 30, 0, 0)), ncol = 3)


y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90, y = unit(0.7, "npc"))
 

CSupPar_devtraj_final <- grid.arrange(arrangeGrob(CSupPar_devtraj, left = y.grob))





plot_NEST_CSupPar <- function(dataset) {
  CSupPar_bilateral <- rbind(get(paste0("CSupParL_deveffect_", dataset)) %>% filter(end == "end1" | end == "end2"), get(paste0("CSupParR_deveffect_", dataset)) %>% filter(end == "end1" | end == "end2"))
 
  NEST_df <- CSupPar_bilateral %>% group_by(end) %>% summarise(bilat_mean_age_effect = mean(mean_age_effect, na.rm = TRUE),
                                                     n = sum(!is.na(mean_age_effect)),
                                                     se_age_effect = sd(mean_age_effect, na.rm = TRUE) / sqrt(n)) %>% 
    mutate(endpoint_labels = case_when(
      end == "end1" ~ "Right Hemisphere",
      end == "end2" ~ "Left Hemisphere",
      TRUE ~ NA_character_))
  
  NEST_plot <- ggplot(NEST_df, aes(x = endpoint_labels, y = bilat_mean_age_effect, group = 1)) +
    geom_line(size = 1, color = "black", alpha = 0.7) +
    geom_point(aes(color = endpoint_labels, fill = end), size = 8) +
    geom_errorbar(aes(ymin = bilat_mean_age_effect - se_age_effect,
                      ymax = bilat_mean_age_effect + se_age_effect,
                      color = endpoint_labels),
                  width = 0.05, size = 1, alpha = 0.7) +
    scale_color_manual(values = setNames(c(color1, color2), c("Right Hemisphere", 
                                                              "Left Hemisphere"))) + 
     theme(legend.position = "none",
           axis.title.x = element_blank(),
           axis.title.y = element_blank(),
           axis.text.x = element_text(size = 12),
           axis.text.y = element_text(size = 12),
           plot.margin = margin(40, 0, 0, 0)) + ylim(0.065, 0.4)
  
  return(NEST_plot)
}

  

NEST_HCPD_CSupPar <- plot_NEST_CSupPar("HCPD")
NEST_HBN_CSupPar <- plot_NEST_CSupPar("HBN")
NEST_PNC_CSupPar <- plot_NEST_CSupPar("PNC")

NEST_CSupPar <- ggarrange(NEST_HCPD_CSupPar, NEST_HBN_CSupPar, NEST_PNC_CSupPar, ncol = 3)



y.grob <- textGrob(expression(paste("Age Effect (Delta Adj", " R"^2, ")")), 
                   gp=gpar(col="black", fontsize=20), rot=90)
 

NEST_CSupPar <- grid.arrange(arrangeGrob(NEST_CSupPar, left = y.grob))

CSupPar_redblue_plots <- ggarrange(CSupPar_devtraj_final, NEST_CSupPar, nrow = 2, heights = c(4,2))


# legend 1
df <- data.frame(x = c(1, 2, 3, 4, 5, 6), y = c(4, 5, 6, 7, 8, 9), region = c("Right", "Right", "Right", "Left", "Left", "Left"))
p <- ggplot(df, aes(x = x, y = y, color = region)) +
  geom_point(size = 5) +  
  scale_color_manual(
    values = c("Right" = color1, "Left" = color2)) +
  theme(legend.position = "bottom", 
        legend.text = element_text(size = 20)) + guides(fill=guide_legend(ncol=1)) + 
  labs(color = "")  # Set legend title
legend1 <- get_legend(p)

CSupPar_devtraj_legend <- ggarrange(CSupPar_redblue_plots, legend1, nrow = 2, heights = c(5, 1))
CSupPar_devtraj_legend
```
 
```{r CSupPar fitted and maps, fig.height = 12, fig.width = 15}

CSupPar_devtraj_final <- grid.arrange(arrangeGrob(CSupPar_devtraj, left = y.grob))

CSupPar_plots_HCPD <- plot_grid(CSupParL_plot_HCPD + theme(plot.margin = margin(15, 20, -10, 70)), CSupParR_plot_HCPD + theme(plot.margin = margin(15, 20, -10, 70)), nrow = 2)
CSupPar_plots_HBN <- plot_grid(CSupParL_plot_HBN + theme(plot.margin = margin(15, 20, -10, 70)), CSupParR_plot_HBN + theme(plot.margin = margin(15, 20, -10, 70)), nrow = 2)
CSupPar_plots_PNC <- plot_grid(CSupParL_plot_PNC + theme(plot.margin = margin(15, 20, -10, 70)), CSupParR_plot_PNC + theme(plot.margin = margin(15, 20, -10, 70)), nrow = 2)

CSupPar_plots <- plot_grid(CSupPar_plots_HCPD, CSupPar_plots_HBN, CSupPar_plots_PNC, ncol = 3)

 
CSupPar_all <- ggarrange(CSupPar_devtraj_final, CSupPar_plots, nrow = 2, heights = c(3, 3))



# legend2
CSupPar_legend_plot <- ggplot() + geom_brain(data = CSupParL_deveffect_HCPD, atlas= glasser, 
                 mapping=aes(fill=mean_age_effect), 
                 show.legend=TRUE, 
                 hemi = "left",
                 position = position_brain("left medial")) +
    paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", direction = -1 , limits = c(0.08, 0.41), oob = squish, na.value = "white") +
    theme_void() +
      theme(legend.position = "bottom",
                  legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.01, 0.1, 0.1), "cm"),
            plot.title = element_blank()) 
  
legend2 <- get_legend(CSupPar_legend_plot + theme(legend.position = "bottom",
                                              legend.key.height = unit(1, 'cm'),
                                              legend.key.width = unit(2, 'cm'),
                                              legend.margin=margin(-50,0,0,0),
                                              legend.text = element_text(size=20),
                                              legend.title = element_blank()))
CSupPar_all <- ggarrange(CSupPar_devtraj_legend, CSupPar_plots, nrow = 2, heights = c(3, 1))
legend_title <- textGrob(expression(paste("Age Effect (Delta Adj", " R"^2, ")")), 
                     gp=gpar(col="black", fontsize=20), hjust = 0.5, vjust = 0, y = unit(-2, "npc"))
    
legend_with_title <- plot_grid(legend_title, legend2, ncol = 1, rel_heights = c(1, 2))
 
grid.arrange(CSupPar_all, legend_with_title, ncol = 1, nrow = 2, heights = c(6, 1))
    

 
```


```{r cc}
CMotL_plot_HCPD <- plot_ageeffects("CMotL", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)  
CMotR_plot_HCPD <- plot_ageeffects("CMotR", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)
CMotL_plot_HBN <- plot_ageeffects("CMotL", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
CMotR_plot_HBN <- plot_ageeffects("CMotR", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
CMotL_plot_PNC <- plot_ageeffects("CMotL", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)
CMotR_plot_PNC <- plot_ageeffects("CMotR", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)



CSupParL_plot_HCPD <- plot_ageeffects("CSupParL", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)
CSupParR_plot_HCPD <- plot_ageeffects("CSupParR", dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)
CSupParL_plot_HBN <- plot_ageeffects("CSupParL", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
CSupParR_plot_HBN <- plot_ageeffects("CSupParR", dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
CSupParL_plot_PNC <- plot_ageeffects("CSupParL", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)
CSupParR_plot_PNC <- plot_ageeffects("CSupParR", dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)
 
```




```{r fig 4, fig.height = 15, fig.width = 15}
CMot_plots_smooths <- plot_grid(callosum_plots_HCPD$`Callosum Motor` + theme(plot.margin = margin(0, 15, -10, 0)), callosum_plots_HBN$`Callosum Motor`+ theme(plot.margin = margin(0, 15, -10, 0)), callosum_plots_PNC$`Callosum Motor`, ncol = 3)
CMot_plots_HCPD <- plot_grid(CMotL_plot_HCPD + theme(plot.margin = margin(0, 15, -10, 0)), CMotR_plot_HCPD + theme(plot.margin = margin(0, 15, -10, 0)), nrow = 2)
CMot_plots_HBN <- plot_grid(CMotL_plot_HBN + theme(plot.margin = margin(0, 15, -10, 0)), CMotR_plot_HBN + theme(plot.margin = margin(0, 15, -10, 0)), nrow = 2)
CMot_plots_PNC <- plot_grid(CMotL_plot_PNC + theme(plot.margin = margin(0, 15, -10, 0)), CMotR_plot_PNC + theme(plot.margin = margin(0, 15, -10, 0)), nrow = 2)

CMot_plots <- plot_grid(CMot_plots_HCPD, CMot_plots_HBN, CMot_plots_PNC, ncol = 3)



CSupPar_plots_smooths <- plot_grid(callosum_plots_HCPD$`Callosum Superior Parietal` + theme(plot.margin = margin(0, 15, -10, 0)), callosum_plots_HBN$`Callosum Superior Parietal` + theme(plot.margin = margin(0, 15, -10, 0)), callosum_plots_PNC$`Callosum Superior Parietal`, ncol = 3)
CSupPar_plots_HCPD <- plot_grid(CSupParL_plot_HCPD + theme(plot.margin = margin(0, 15, -10, 0)), CSupParR_plot_HCPD + theme(plot.margin = margin(0, 15, -10, 0)), nrow = 2)
CSupPar_plots_HBN <- plot_grid(CSupParL_plot_HBN + theme(plot.margin = margin(0, 15, -10, 0)), CSupParR_plot_HBN + theme(plot.margin = margin(0, 15, -10, 0)), nrow = 2)
CSupPar_plots_PNC <- plot_grid(CSupParL_plot_PNC + theme(plot.margin = margin(0, 15, -10, 0)), CSupParR_plot_PNC + theme(plot.margin = margin(0, 15, -10, 0)), nrow = 2)

CSupPar_plots <- plot_grid(CSupPar_plots_HCPD, CSupPar_plots_HBN, CSupPar_plots_PNC, ncol = 3)


CMot_all <- ggarrange(CMot_plots_smooths, CMot_plots, nrow = 2)
CSupPar_all <- ggarrange(CSupPar_plots_smooths, CSupPar_plots, nrow = 2)

ggarrange(CMot_all, CSupPar_all, nrow = 2)
```

```{r callosum HBN age effects, fig.height = 20, fig.width = 15}
# callosum bundles
# plot age effects for each tract
lh_ageeffect_callosum_plots <- lapply(c("COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL"), plot_ageeffects, dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)
rh_ageeffect_callosum_plots <- lapply(c("COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR"), plot_ageeffects, dataset="HCPD", ylim1 = 0.08, ylim2 = 0.41)
names(lh_ageeffect_callosum_plots) <- c("COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL")
names(rh_ageeffect_callosum_plots) <- c("COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR")
 
# arrange plots
age_effect_callosum_plots_HCPD <- arrange_ageeffect_callosum_plots(lh_ageeffect_callosum_plots, rh_ageeffect_callosum_plots)
age_effect_callosum_plots_HCPD


# callosum bundles
# plot age effects for each tract
lh_ageeffect_callosum_plots <- lapply(c("COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL"), plot_ageeffects, dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
rh_ageeffect_callosum_plots <- lapply(c("COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR"), plot_ageeffects, dataset="HBN", ylim1 = 0.08, ylim2 = 0.41)
names(lh_ageeffect_callosum_plots) <- c("COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL")
names(rh_ageeffect_callosum_plots) <- c("COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR")
 
# arrange plots
age_effect_callosum_plots_HBN <- arrange_ageeffect_callosum_plots(lh_ageeffect_callosum_plots, rh_ageeffect_callosum_plots)
age_effect_callosum_plots_HBN

#ggsave(paste0(png_dir, "/", "HBN", "/","dev_callosum.png"), age_effect_callosum_plots_HBN, height = 20, width = 15, units = "in")



# callosum bundles
# plot age effects for each tract
lh_ageeffect_callosum_plots <- lapply(c("COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL"), plot_ageeffects, dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)
rh_ageeffect_callosum_plots <- lapply(c("COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR"), plot_ageeffects, dataset="PNC", ylim1 = 0.08, ylim2 = 0.41)
names(lh_ageeffect_callosum_plots) <- c("COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL")
names(rh_ageeffect_callosum_plots) <- c("COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR")
 
# arrange plots
age_effect_callosum_plots_PNC <- arrange_ageeffect_callosum_plots(lh_ageeffect_callosum_plots, rh_ageeffect_callosum_plots)
age_effect_callosum_plots_PNC


```

 
# aggregated age maps
```{r aggregated age map} 
# lh callosum + tracts of interest only
lh_by_region <- rbind(COrbL_deveffect_HBN, CAntFrL_deveffect_HBN, 
                      CSupFrL_deveffect_HBN, CMotL_deveffect_HBN, 
                      CSupParL_deveffect_HBN, CPostParL_deveffect_HBN, 
                      CTempL_deveffect_HBN, COccL_deveffect_HBN, 
                      ARCL_deveffect_HBN, IFOL_deveffect_HBN, SLFL_deveffect_HBN) %>% group_by(region) %>% 
  summarise(regional_mean_ageeffect = mean(mean_age_effect, na.rm=T))

length(which(is.na(lh_by_region$regional_mean_ageeffect)))  

# lh all
lh_by_region_all <- rbind(COrbL_deveffect_HBN, CAntFrL_deveffect_HBN, 
                      CSupFrL_deveffect_HBN, CMotL_deveffect_HBN, 
                      CSupParL_deveffect_HBN, CPostParL_deveffect_HBN, 
                      CTempL_deveffect_HBN, COccL_deveffect_HBN, 
                      ARCL_deveffect_HBN, IFOL_deveffect_HBN, SLFL_deveffect_HBN,
                      CSTL_deveffect_HBN, ILFL_deveffect_HBN, pARCL_deveffect_HBN, VOFL_deveffect_HBN) %>% group_by(region) %>% 
  summarise(regional_mean_ageeffect = mean(mean_age_effect, na.rm=T))

length(which(is.na(lh_by_region_all$regional_mean_ageeffect)))  

# lh callosum + most tracts minus pARC and VOF
lh_by_region_subset <- rbind(COrbL_deveffect_HBN, CAntFrL_deveffect_HBN, 
                      CSupFrL_deveffect_HBN, CMotL_deveffect_HBN, 
                      CSupParL_deveffect_HBN, CPostParL_deveffect_HBN, 
                      CTempL_deveffect_HBN, COccL_deveffect_HBN, 
                      ARCL_deveffect_HBN, IFOL_deveffect_HBN, SLFL_deveffect_HBN,
                      CSTL_deveffect_HBN, ILFL_deveffect_HBN) %>% group_by(region) %>% 
  summarise(regional_mean_ageeffect = mean(mean_age_effect, na.rm=T))

length(which(is.na(lh_by_region_subset$regional_mean_ageeffect)))  

# callosum + tracts of interest only
rh_by_region <- rbind(COrbR_deveffect_HBN, CAntFrR_deveffect_HBN, 
                      CSupFrR_deveffect_HBN, CMotR_deveffect_HBN, 
                      CSupParR_deveffect_HBN, CPostParR_deveffect_HBN, 
                      CTempR_deveffect_HBN, COccR_deveffect_HBN, 
                      ARCR_deveffect_HBN, IFOR_deveffect_HBN, SLFR_deveffect_HBN) %>% group_by(region) %>% 
  summarise(regional_mean_ageeffect = mean(mean_age_effect, na.rm=T))

length(which(is.na(rh_by_region$regional_mean_ageeffect))) 


rh_by_region_all <- rbind(COrbR_deveffect_HBN, CAntFrR_deveffect_HBN, 
                      CSupFrR_deveffect_HBN, CMotR_deveffect_HBN, 
                      CSupParR_deveffect_HBN, CPostParR_deveffect_HBN, 
                      CTempR_deveffect_HBN, COccR_deveffect_HBN, 
                      ARCR_deveffect_HBN, IFOR_deveffect_HBN, SLFR_deveffect_HBN,
                      CSTR_deveffect_HBN, ILFR_deveffect_HBN, pARCR_deveffect_HBN, VOFR_deveffect_HBN) %>% group_by(region) %>% 
  summarise(regional_mean_ageeffect = mean(mean_age_effect, na.rm=T))

length(which(is.na(rh_by_region_all$regional_mean_ageeffect)))  
  
  
# rh callosum + most tracts minus pARC and VOF
rh_by_region_subset <- rbind(COrbL_deveffect_HBN, CAntFrL_deveffect_HBN, 
                      CSupFrL_deveffect_HBN, CMotL_deveffect_HBN, 
                      CSupParL_deveffect_HBN, CPostParL_deveffect_HBN, 
                      CTempL_deveffect_HBN, COccL_deveffect_HBN, 
                      ARCL_deveffect_HBN, IFOL_deveffect_HBN, SLFL_deveffect_HBN,
                      CSTL_deveffect_HBN, ILFL_deveffect_HBN) %>% group_by(region) %>% 
  summarise(regional_mean_ageeffect = mean(mean_age_effect, na.rm=T))

length(which(is.na(rh_by_region_subset$regional_mean_ageeffect)))  
 
lh_by_region <- lh_by_region %>% mutate(coverage = ifelse(is.na(regional_mean_ageeffect), "no", "yes"))
rh_by_region <- rh_by_region %>% mutate(coverage = ifelse(is.na(regional_mean_ageeffect), "no", "yes"))


lh_by_region_all <- lh_by_region_all %>% mutate(coverage = ifelse(is.na(regional_mean_ageeffect), "no", "yes"))
rh_by_region_all <- rh_by_region_all %>% mutate(coverage = ifelse(is.na(regional_mean_ageeffect), "no", "yes"))


lh_by_region_subset <- lh_by_region_subset %>% mutate(coverage = ifelse(is.na(regional_mean_ageeffect), "no", "yes"))
rh_by_region_subset <- rh_by_region_subset %>% mutate(coverage = ifelse(is.na(regional_mean_ageeffect), "no", "yes"))
 
#write.csv(lh_by_region, "/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/tract_to_cortex/HBN_lh_agg.csv", row.names=F)
#write.csv(rh_by_region, "/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/tract_to_cortex/HBN_rh_agg.csv", row.names=F)
```


```{r plot aggregated map, fig.height = 10, fig.width = 10}


plot_aggregated_maps <- function(lh_by_region_df, rh_by_region_df) {
  hemi = "left"
  cortical_pos <- c("left lateral", "left medial")
  lh_agg <- ggplot() + 
      geom_brain(data = lh_by_region_df, atlas = glasser, 
                 mapping=aes(fill = regional_mean_ageeffect, colour = coverage, size = I(0.4)), 
                 show.legend=TRUE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos)) + 
    
      paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", na.value = "grey100", limits = c(10, 23), oob=squish, direction = -1) +  
      scale_colour_manual(values = c(yes = "gray30", no = "grey84")) + # limits = c(0.16, 0.4)
      theme_void() +
      theme(legend.position = "none",
            legend.key.height = unit(1, 'cm'),
            legend.key.width = unit(2.3, 'cm'),
            legend.margin=margin(0,0,0,0),
            legend.text = element_text(size=24),
            legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
            plot.title = element_text(size=20, hjust = 0.5)) + guides(
    colour = "none",  # Remove legend for color
    size = "none"     # Remove legend for size if not needed
  )


  hemi = "right"
  cortical_pos <- c("right lateral", "right medial")



  rh_agg <- ggplot() + 
        geom_brain(data = rh_by_region_df, atlas = glasser, 
                   mapping=aes(fill = regional_mean_ageeffect, colour = coverage, size = I(0.4)), 
                   show.legend=TRUE, 
                   hemi = hemi,
                   position = position_brain(cortical_pos)) + 
      
        paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", na.value = "grey100", limits = c(10, 23), oob=squish, direction = -1) +  
        scale_colour_manual(values = c(yes = "gray30", no = "grey84")) + 
        theme_void() +
        theme(legend.position = "none",
              legend.key.height = unit(1, 'cm'),
              legend.key.width = unit(2.3, 'cm'),
              legend.margin=margin(0,0,0,0),
              legend.text = element_text(size=24),
              legend.title = element_blank(),
              plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
              plot.title = element_text(size=20, hjust = 0.5))  + guides(
      colour = "none",  # Remove legend for color
      size = "none"     # Remove legend for size if not needed
    )
  
  
  agg_plots <- ggarrange(lh_agg, rh_agg, ncol=1, nrow = 2)
  agg_final <- annotate_figure(agg_plots, top = text_grob("Aggregated Age Effect Map Across Tracts", 
                 color = "black", face = "bold", size = 20, vjust = -0.75)) + theme(plot.margin = unit(c(1, 0, 0, 0), "cm")) 
  
  
  legend <- get_legend(lh_agg + theme(legend.position = "bottom",
                                              legend.key.height = unit(1, 'cm'),
                                              legend.key.width = unit(2, 'cm'),
                                              legend.margin=margin(-90,0,0,0),
                                              legend.text = element_text(size=20),
                                              legend.title = element_blank()))
  legend_title <- textGrob(expression(paste("Age Effect (Delta Adj", " R"^2, ")")), 
                     gp=gpar(col="black", fontsize=20),  
      hjust = 0.5,  
      vjust = -6
    )
    
    legend_with_title <- arrangeGrob(
      legend, legend_title,
      ncol = 1, nrow = 2  
    )
  
  return(grid.arrange(agg_final, legend_with_title, ncol = 1, nrow = 2))
  
}


agg_tracts_interest <- plot_aggregated_maps(lh_by_region, rh_by_region)
grid.newpage()
grid.draw(agg_tracts_interest)
#ggsave(paste0(png_dir, "/", "HBN", "/","dev_aggregated.png"), agg_tracts_interest , height = 10, width = 10, units = "in")

agg_all <- plot_aggregated_maps(lh_by_region_all, rh_by_region_all)
grid.newpage()
grid.draw(agg_all)
#ggsave(paste0(png_dir, "/", "HBN", "/","dev_all.png"), agg_all , height = 10, width = 10, units = "in")

agg_subset <- plot_aggregated_maps(lh_by_region_subset, rh_by_region_subset)
grid.newpage()
grid.draw(agg_subset)
#ggsave(paste0(png_dir, "/", "HBN", "/","dev_aggregated_subset.png"), agg_subset, height = 10, width = 10, units = "in")
 
```


# Avg difference in S-A axis rank between tract ends vs. Difference in age effect between tract ends (delta-delta)
```{r load SA axis}
# i'm bringing SA back (yeah)
glasser_SAaxis <- read.csv("/cbica/projects/luo_wm_dev/SAaxis/glasser_SAaxis.csv")
glasser_SAaxis <- glasser_SAaxis %>% select(SA.axis_rank, label)
glasser_SAaxis$regionName <- gsub("_ROI", "", glasser_SAaxis$label)
glasser_SAaxis$regionName <- gsub("^(.)_(.*)$", "\\2_\\1", glasser_SAaxis$region)
```


```{r functions for computing SA rank}

# for each tract's endpoint, compute the mean S-A axis rank
merge_SAaxis <- function(bundle_name, df_to_return = "endpoints_only", dataset) {
  df <- get(paste0(bundle_name, "_deveffect_", dataset))
  merged_df <- merge(df, glasser_SAaxis,  by = "regionName")
  merged_df <- merged_df %>% arrange(thresh_probability)
  
  mean_df <- merged_df %>% group_by(end) %>% summarise(mean_SA = mean(SA.axis_rank, na.rm = T),
                                                       median_SA = median(SA.axis_rank, na.rm = T),
                                                      # sd_SA = sd(SA.axis_rank, na.rm = T),
                                                       age_effect = mean(mean_age_effect)) %>% mutate(bundle_name = bundle_name)
  
  if(df_to_return == "all_regions") {
    return(merged_df)
  } else {
    return(mean_df)
  }
}


compute_endpoint_diffs <- function(bundle_name, diff_calculation = "abs_diff") {
  callosum <- c("COrb", "CAntFr", "CSupFr", "CMot", "CSupPar", "CPostPar", "CTemp", "COcc")

  if (any(sapply(callosum, function(x) grepl(x, bundle_name)))) {
    bundle_type = "callosum"
  } else {
    bundle_type = "assoc"
  }
  
  if(bundle_type == "assoc") {
    if(grepl("L$", bundle_name)) {
      SAranks_endpoints <- lh_SAranks_endpoints[[bundle_name]]
    } else{
      SAranks_endpoints <- rh_SAranks_endpoints[[bundle_name]]
    }
    
    if(diff_calculation == "abs_diff") {
      endpoints_diffs <- SAranks_endpoints %>% filter(if_all(everything(), ~ !is.na(.))) %>%
        summarise(mean_SA_diff = abs(mean_SA[end == "end1"] - mean_SA[end == "end2"]),
          age_effect_diff = abs(age_effect[end == "end1"] - age_effect[end == "end2"])) %>% 
      mutate(bundle_name = bundle_name)
    } else if (diff_calculation == "diff") {
      endpoints_diffs <- SAranks_endpoints %>% filter(if_all(everything(), ~ !is.na(.))) %>%
        summarise(mean_SA_diff = mean_SA[end == "end1"] - mean_SA[end == "end2"],
          age_effect_diff = age_effect[end == "end1"] - age_effect[end == "end2"]) %>% 
      mutate(bundle_name = bundle_name)
    }
    
  } else if (bundle_type == "callosum") {
    bundle_name_lh =  paste0(substr(bundle_name, 1, nchar(bundle_name) - 1), "L")
    bundle_name_rh =  paste0(substr(bundle_name, 1, nchar(bundle_name) - 1), "R")
    
    SAranks_endpoints1 <- lh_SAranks_endpoints[[bundle_name_lh]]
    SAranks_endpoints2 <- rh_SAranks_endpoints[[bundle_name_rh]]
    SAranks_endpoints <- rbind(SAranks_endpoints1, SAranks_endpoints2)
    
    if(diff_calculation == "abs_diff") {
      endpoints_diffs <- SAranks_endpoints %>% filter(if_all(everything(), ~ !is.na(.))) %>%
        summarise(mean_SA_diff = abs(mean_SA[end == "end1"] - mean_SA[end == "end2"]),
          age_effect_diff = abs(age_effect[end == "end1"] - age_effect[end == "end2"])) %>% 
      mutate(bundle_name = bundle_name)
    } else if (diff_calculation == "diff") {
      endpoints_diffs <- SAranks_endpoints %>% filter(if_all(everything(), ~ !is.na(.))) %>%
        summarise(mean_SA_diff = mean_SA[end == "end1"] - mean_SA[end == "end2"],
          age_effect_diff = age_effect[end == "end1"] - age_effect[end == "end2"]) %>% 
      mutate(bundle_name = bundle_name)
    }
  }
  
 return(endpoints_diffs)
}

  
```

THE MONEY IS WITH AGE OF MATURATION YALLLLLL
also this rmd file is absolute chaos!!!
```{r compute SA rank}
# compute mean SA rank for cortical endpoints of each tract
lh_names <- c("ARCL", "CSTL" ,"ILFL", "IFOL", "SLFL", "pARCL", "VOFL", "COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL")
lh_SAranks <- lapply(lh_names, merge_SAaxis, "all_regions", dataset="HBN")
lh_SAranks_endpoints <- lapply(lh_names, merge_SAaxis, "endpoints_only", dataset="HBN")
lh_SAranks_endpoints <- lapply(lh_SAranks_endpoints, function(df) na.omit(df))
 
rh_names <- c("ARCR", "CSTR" ,"ILFR", "IFOR", "SLFR", "pARCR", "VOFR", "COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR")
rh_SAranks <- lapply(rh_names, merge_SAaxis, "all_regions", dataset="HBN")
rh_SAranks_endpoints <- lapply(rh_names, merge_SAaxis, "endpoints_only", dataset="HBN")
rh_SAranks_endpoints <- lapply(rh_SAranks_endpoints, function(df) na.omit(df))


names(lh_SAranks) <- lh_names
names(rh_SAranks) <- rh_names

names(lh_SAranks_endpoints) <- lh_names
names(rh_SAranks_endpoints) <- rh_names
 
lh_all_endpoints <- bind_rows(lh_SAranks_endpoints) %>% filter(!is.na(end))
rh_all_endpoints <- bind_rows(rh_SAranks_endpoints) %>% filter(!is.na(end))

all_endpoints <- rbind(lh_all_endpoints, rh_all_endpoints) %>% arrange(bundle_name)
# plot/correlation between the age effect of cortical endpoint and its mean SA axis - lol nope nothing
cor.test(lh_all_endpoints$median_SA, lh_all_endpoints$age_effect) # lol average age effect and SA rank are def not correlated. but age of mat is!??!?!!? wtf. 
cor.test(rh_all_endpoints$median_SA, rh_all_endpoints$age_effect)
cor.test(all_endpoints$mean_SA, all_endpoints$age_effect) # r = 0.82?! # HCPD and PNC holy shit. but NOT significant at all in HCPD.

 
all_endpoints_subset <- all_endpoints %>% filter(!str_detect(bundle_name, "pARC") & !str_detect(bundle_name, "VOF"))
cor.test(all_endpoints_subset$mean_SA, all_endpoints_subset$age_effect)
 
SA_ageeffect_plot <- ggplot(all_endpoints, aes(x = mean_SA, y = age_effect, label = bundle_name)) +
  geom_point(size = 3, aes(color = bundle_name, fill = bundle_name), shape = 21, alpha = 0.7) +  # Plot points
  #geom_text(aes(label = bundle_name), vjust = -1, hjust = 0.5, size = 4) + 
  ggrepel::geom_text_repel(position = position_jitter(seed = 1)) + # Add labels
  theme_minimal() +
  labs(
    title = "Cortical Endpoints: \nMean SA Rank vs. Age of Maturation",
    x = "Mean SA Rank of Endpoint",
    y = "Age of Maturation"
  ) + theme_classic() +
  theme(legend.position = "none",
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold"),
    axis.title = element_text(size = 12)
  ) 

SA_ageeffect_plot
# i dont think i can do a spin test on this very easily though - this is just the mean SA rank of each endpoint correlated with the age of maturation at that endpoint
```


 
 
 
 
 ## need to check bin5, clip5
```{r}
 

ifo_hcpd_2sided <- readRDS("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/NEST/Inferior_Fronto_occipital_bin5_clip5_2sided_end_compare.RData")
ifo_hcpd_1sided <- readRDS("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/NEST/Inferior_Fronto_occipital_bin5_clip5_1sided_end_compare.RData")

ifo_hcpd_1sided$pval
ifo_hcpd_2sided$pval


ifo_hcpd_2sided <- readRDS("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/NEST/Inferior_Fronto_occipital_bin10_clip3_2sided_end_compare.RData")
ifo_hcpd_1sided <- readRDS("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/NEST/Inferior_Fronto_occipital_bin10_clip3_1sided_end_compare.RData")

ifo_hcpd_1sided$pval
ifo_hcpd_2sided$pval

ifo_pnc_2sided <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Inferior_Fronto_occipital_bin10_clip5_2sided_end_compare.RData")
ifo_pnc_1sided <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Inferior_Fronto_occipital_bin10_clip5_1sided_end_compare.RData")

ifo_pnc_1sided$pval
ifo_pnc_2sided$pval

ifo_hbn_2sided <- readRDS("/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/NEST/Inferior_Fronto_occipital_bin10_clip5_2sided_end_compare.RData")
ifo_hbn_1sided <- readRDS("/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/NEST/Inferior_Fronto_occipital_bin10_clip5_1sided_end_compare.RData")

ifo_hbn_2sided$pval
ifo_hbn_1sided$pval

list.files("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/")
# clip5 ok for PNC actually
ifo_PNC_2sided <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Inferior_Fronto_occipital_bin5_clip5_2sided_end_compare.RData") # good
ifo_PNC_2sided$pval
# bin 5 clip 5



cmot_hcpd_2sided <- readRDS("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/NEST/Callosum_Motor_bin5_clip5_2sided_end_compare.RData")
cmot_hcpd_1sided <- readRDS("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/NEST/Callosum_Motor_bin5_clip5_1sided_end_compare.RData")

list.files("/cbica/projects/luo_wm_dev/output/HCPD/tract_profiles/NEST/")
cmot_hcpd_1sided$pval
cmot_hcpd_2sided$pval

cmot_hbn_2sided <- readRDS("/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/NEST/Callosum_Motor_bin5_clip5_2sided_end_compare.RData")
cmot_hbn_1sided <- readRDS("/cbica/projects/luo_wm_dev/output/HBN/tract_profiles/NEST/Callosum_Motor_bin5_clip5_1sided_end_compare.RData")

cmot_hbn_2sided$pval
cmot_hbn_1sided$pval

list.files("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/")
# clip5 ok for PNC actually
cmot_PNC_2sided <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Motor_bin5_clip5_2sided_end_compare.RData") # good
cmot_PNC_2sided$pval
# bin 5 clip 5

 
```
 
 
 nest check for deep peripheral
```{r check outputs}
arc <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Arcuate_bin5_clip5_2sided.RData")
cst <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Corticospinal_bin5_clip5_2sided.RData")
ifo <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Inferior_Fronto_occipital_bin5_clip5_2sided.RData")
ilf <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Inferior_Longitudinal_bin5_clip5_2sided.RData")
slf <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Superior_Longitudinal_bin5_clip5_2sided.RData")
parc <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Posterior_Arcuate_bin5_clip5_2sided.RData")
vof <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Vertical_Occipital_bin5_clip5_2sided.RData")

cc_af <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Anterior_Frontal_bin5_clip5_2sided.RData")
cc_mot <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Motor_bin5_clip5_2sided.RData")
cc_occ <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Occipital_bin5_clip5_2sided.RData")
cc_orb <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Orbital_bin5_clip5_2sided.RData")
cc_pp <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Posterior_Parietal_bin5_clip5_2sided.RData")
cc_sf <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Superior_Frontal_bin5_clip5_2sided.RData")
cc_sp <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Superior_Parietal_bin5_clip5_2sided.RData")
cc_tm <- readRDS("/cbica/projects/luo_wm_dev/output/PNC/tract_profiles/NEST/Callosum_Temporal_bin5_clip5_2sided.RData")
 
 
p.adjust(unlist(c(arc$pval, cst$pval, ifo$pval, ilf$pval, slf$pval, parc$pval, vof$pval, cc_af$pval, cc_mot$pval, cc_occ$pval, cc_orb$pval, cc_pp$pval, cc_sf$pval, cc_sp$pval, cc_tm$pval)), method=c("fdr"))
 
 
# bin5, clip5:  # i think this is the winner for deep-peripheral 
# - hcpd: ifo barely sig, ilf trend, parc NS
# - hbn: ilf NS, parc trend, VOF NS, 
# - pnc: ilf NS

# bin5, clip3:
# - hcpd: ilf NS, parc NS
# - hbn: ilf trend, parc NS
# - pnc: ilf NS

 
# bin10, clip5: so def not this one
# - hcpd: ilf NS, parc trend, COcc NS  
# - hbn: ifo NS, ilf NS, slf trend, parc NS, 
# - pnc:


# i think bin5, clip5 for deep-peripheral and bin10 clip5 for tract ends is justifiable (total 10 nodes from each end. comparing 20 nodes at a time in both analyses)
# probably want consistent clipping though 
```
 
 