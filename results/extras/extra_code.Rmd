---
title: "Extra code"
author: "Audrey Luo"
date: "2024-12-05"
output: html_document
---



# load tract profiles
```{r load tract profiles}
PNC <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_NEST.RData", output_root, "PNC"))
HCPD <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_NEST.RData", output_root, "HCPD"))
HBN <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_NEST.RData", output_root, "HBN"))
```

# tract profiles coefficient of variance
```{r make summary dfs}
datasets <- list(HCPD = HCPD, HBN = HBN, PNC = PNC)

# create summary dfs
for (dataset_name in names(datasets)) {
  dataset <- datasets[[dataset_name]]
  make_summary_dfs("dti_md", dataset_name, dataset) # this creates summary_[dataset]_[scalar] dataframes that include mean, sd, se  
}
```

```{r set colors}
color1 = "#3FB8AFFF"
color2 = "#FF9E9DFF"
color3 = "#cc0468"
```

# plot baseline mean diffusivity
```{r run dti md sd plotting}
variance_measure = "sd"
dti_md_sd_plots <- lapply(unique(HCPD$tract_label), plot_mean_var, scalar = "dti_md", variance_measure = variance_measure, 
                                color1 = color1, color2 = color2, color3 = color3, ylim1 = 0.00058, ylim2 = 0.001, ylim3 = 0.0005, ylim4 = 0.0013, clipEnds = 5)
names(dti_md_sd_plots) <- unique(HCPD$tract_label)
```

```{r dti md tracts sd callosum, fig.height = 10, fig.width = 20}
dti_md_callosum_final <- arrange_callosum_var_plots(dti_md_sd_plots)
title.grob <- textGrob("Mean Diffusivity Along Tracts (+/- 1SD)", 
                   gp=gpar(col="black", fontsize=20, face = "italic"), hjust = 0.5)
y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(dti_md_callosum_final, left = y.grob, top = title.grob))
ggsave(paste0(png_dir, "supp_callosum_sd.png"), grid.arrange(arrangeGrob(dti_md_callosum_final, left = y.grob, top = title.grob)), height = 10, width = 20, units = "in")
```
 
```{r dti md tracts sd association, fig.height = 10, fig.width = 20}
dti_md_association_final <- arrange_all_association_var_plots(dti_md_sd_plots)
title.grob <- textGrob("Mean Diffusivity Along Tracts (+/- 1SD)", 
                   gp=gpar(col="black", fontsize=20, face = "italic"), hjust = 0.5)
y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(dti_md_association_final, left = y.grob, top = title.grob))
ggsave(paste0(png_dir, "supp_association_sd.png"), grid.arrange(arrangeGrob(dti_md_association_final, left = y.grob, top = title.grob)), height = 10, width = 20, units = "in")
```

```{r functions for saving average tp across datasets for glass brain}
# compute average tract profiles across datasets for glass brain

##############
# functions
##############
compute_avg_tp <- function(tract, scalar, clipEnds) {
  
  summary_HCPD <- get(paste0("summary_HCPD_", scalar))
  summary_HBN <- get(paste0("summary_HBN_", scalar))
  summary_PNC <- get(paste0("summary_PNC_", scalar))
  
  HCPD_tp <- summary_HCPD %>% filter(tractID == tract) %>% mutate(HCPD_tp = get(paste0("mean_", scalar))) %>% select(HCPD_tp, nodeID) 
  HBN_tp <- summary_HBN %>% filter(tractID == tract) %>% mutate(HBN_tp = get(paste0("mean_", scalar))) %>% select(HBN_tp, nodeID) 
  PNC_tp <- summary_PNC %>% filter(tractID == tract) %>% mutate(PNC_tp = get(paste0("mean_", scalar))) %>% select(PNC_tp, nodeID) 
  
  avg_tp <- HCPD_tp %>%
    inner_join(HBN_tp, by = "nodeID") %>%
    inner_join(PNC_tp, by = "nodeID")
  
  mean_tp <- avg_tp %>% group_by(nodeID) %>% summarise(mean_scalar = (HCPD_tp + HBN_tp + PNC_tp) /3)
  mean_tp <- mean_tp %>%
    mutate(mean_scalar = case_when(
    nodeID < clipEnds | nodeID > (99-clipEnds) ~ NA_real_,  # set NA in mean_scalar for clipped nodes 
    TRUE ~ mean_scalar  
  ))
  #mean_tp <- mean_tp %>% filter(nodeID >= clipEnds & nodeID < (100 - clipEnds))
  return(mean_tp)

}

normalize_tp <- function(avgs_df, min_val, max_val) {
  for(i in 1:length(avgs_df)) {
   avgs_df[[i]] <- avgs_df[[i]] %>% mutate(normalized_values = (mean_scalar - min_val) / (max_val - min_val))
  }
  return(avgs_df)
}
```

```{r save average tp across datasets for glass brain}

callosum_bundles <- unique(summary_HCPD_dti_md$tractID[str_detect(summary_HCPD_dti_md$tractID, "Callosum")])
association_bundles <- unique(summary_HCPD_dti_md$tractID[!str_detect(summary_HCPD_dti_md$tractID, "Callosum") & !str_detect(summary_HCPD_dti_md$tractID,"Corticospinal")])
cst_bundle <- unique(summary_HCPD_dti_md$tractID[str_detect(summary_HCPD_dti_md$tractID, "Corticospinal")])

callosum_avgs <- lapply(callosum_bundles, compute_avg_tp, scalar = "dti_md", clipEnds = 5)
names(callosum_avgs) <- callosum_bundles

association_avgs <- lapply(association_bundles, compute_avg_tp, scalar = "dti_md", clipEnds = 5)
names(association_avgs) <- association_bundles

cst_avgs <- lapply(cst_bundle, compute_avg_tp, scalar = "dti_md", clipEnds = 5)
names(cst_avgs) <- cst_bundle

# normalize across callosum + association bundles separately for glass brain plotting/coloring purposes
cc_min <- bind_rows(callosum_avgs) %>% select(mean_scalar) %>% min(., na.rm=TRUE)
cc_max <- bind_rows(callosum_avgs) %>% select(mean_scalar) %>% max(., na.rm=TRUE)
callosum_norm_avgs <- normalize_tp(callosum_avgs, cc_min, cc_max)
range(bind_rows(callosum_norm_avgs)$mean_scalar, na.rm=T) # 0.0006929900 0.0009773952

assoc_cst <- c(association_avgs, cst_avgs)
assoc_cst_min <- bind_rows(assoc_cst) %>% select(mean_scalar) %>% min(., na.rm=TRUE)
assoc_cst_max <- bind_rows(assoc_cst) %>% select(mean_scalar) %>% max(., na.rm=TRUE)
assoc_cst_avgs <- normalize_tp(assoc_cst, assoc_cst_min, assoc_cst_max)
range(bind_rows(assoc_cst_avgs)$mean_scalar, na.rm=T) # 0.0006954155 0.0008502865

# save out
glass_brain_dir <- "/Users/audluo/PennLINC/luowm_local/tract_profiles/qsirecon/sub-1000393599/average_tract_profiles/"
for (df_name in names(callosum_norm_avgs)) {
  write.csv(callosum_norm_avgs[[df_name]], paste0(glass_brain_dir, "/", df_name, "_avg_tp.csv"), row.names = FALSE)
}

for (df_name in names(assoc_cst_avgs)) {
  write.csv(assoc_cst_avgs[[df_name]], paste0(glass_brain_dir, "/", df_name, "_avg_tp.csv"), row.names = FALSE)
}
```

# plot CV
```{r run dti md cv plotting}
variance_measure = "cv"
dti_md_cv_plots <- lapply(unique(HCPD$tract_label), plot_cv, scalar = "dti_md", variance_measure = variance_measure, 
                                color1 = color1, color2 = color2, color3 = color3, ylim1 = 2, ylim2 = 23, ylim3 = 2, ylim4 = 23, clipEnds = 5)
names(dti_md_cv_plots) <- unique(HCPD$tract_label)
```

```{r dti md tracts cv callosum, fig.height = 10, fig.width = 20}
dti_md_callosum_final <- arrange_callosum_var_plots(dti_md_cv_plots)
title.grob <- textGrob("Coefficient of Variance for Mean Diffusivity Along Tracts", 
                   gp=gpar(col="black", fontsize=20, face = "italic"), hjust = 0.5)
y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(dti_md_callosum_final, left = y.grob, top = title.grob))
ggsave(paste0(png_dir, "supp_callosum_cv.png"), grid.arrange(arrangeGrob(dti_md_callosum_final, left = y.grob, top = title.grob)), height = 10, width = 20, units = "in")
```
 
```{r dti md tracts cv association, fig.height = 10, fig.width = 20}
dti_md_association_final <- arrange_all_association_var_plots(dti_md_cv_plots)
title.grob <- textGrob("Coefficient of Variance for Mean Diffusivity Along Tracts", 
                   gp=gpar(col="black", fontsize=20, face = "italic"), hjust = 0.5)
y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(dti_md_association_final, left = y.grob, top = title.grob))
ggsave(paste0(png_dir, "supp_association_cv.png"), grid.arrange(arrangeGrob(dti_md_association_final, left = y.grob, top = title.grob)), height = 10, width = 20, units = "in")
```
 
# tract profiles correlations
```{r tract profiles cross-dataset correlation, fig.height = 7, fig.width = 22}
cor_HCPD_HBN <- round(cor.test(summary_HCPD_dti_md$mean_dti_md, summary_HBN_dti_md$mean_dti_md)$estimate, 2)
cor_HCPD_PNC <- round(cor.test(summary_HCPD_dti_md$mean_dti_md, summary_PNC_dti_md$mean_dti_md)$estimate, 2)
cor_HBN_PNC <- round(cor.test(summary_PNC_dti_md$mean_dti_md, summary_HBN_dti_md$mean_dti_md)$estimate, 2)

# permute for p-values
HCPD_HBN_perm <- perm_cor_test(summary_HCPD_dti_md$mean_dti_md, summary_HBN_dti_md$mean_dti_md)
HCPD_PNC_perm <- perm_cor_test(summary_HCPD_dti_md$mean_dti_md, summary_PNC_dti_md$mean_dti_md)
PNC_HBN_perm <- perm_cor_test(summary_PNC_dti_md$mean_dti_md, summary_HBN_dti_md$mean_dti_md)

HCPD_to_corr <- summary_HCPD_dti_md %>% mutate(HCPD = mean_dti_md) %>% mutate(tract_node = paste0(tractID, "_", nodeID)) %>% select(tract_node, HCPD)
HBN_to_corr <- summary_HBN_dti_md %>% mutate(HBN = mean_dti_md) %>% mutate(tract_node = paste0(tractID, "_", nodeID)) %>% select(tract_node, HBN)
PNC_to_corr <- summary_PNC_dti_md %>% mutate(PNC = mean_dti_md) %>% mutate(tract_node = paste0(tractID, "_", nodeID)) %>% select(tract_node, PNC)

HCPD_HBN_baseline <- merge(HCPD_to_corr, HBN_to_corr, by = "tract_node")
HCPD_PNC_baseline <- merge(HCPD_to_corr, PNC_to_corr, by = "tract_node")
HBN_PNC_baseline <- merge(HBN_to_corr, PNC_to_corr, by = "tract_node")

text_HCPD_HBN <- bquote(italic(r) == .(cor_HCPD_HBN) * "," ~ italic(p[perm]) < .(format(round(HCPD_HBN_perm$p_value, 4), scientific = FALSE)))
HCPD_HBN_baseline_plot <- hex_plot(HCPD_HBN_baseline, "HCPD", "HBN", text_HCPD_HBN, ylim1 = 0.00061, ylim2 = 0.0012, xlim1 = 0.00060, xlim2 = 0.0011, x_text = 0.0006, y_text = 0.0012)
 
text_HCPD_PNC <- bquote(italic(r) == .(cor_HCPD_PNC) * "," ~ italic(p[perm]) < .(format(round(HCPD_PNC_perm$p_value, 4), scientific = FALSE)))
HCPD_PNC_baseline_plot <- hex_plot(HCPD_PNC_baseline, "HCPD", "PNC", text_HCPD_PNC, ylim1 = 0.00061, ylim2 = 0.0012, xlim1 = 0.00060, xlim2 = 0.0011, x_text = 0.0006, y_text = 0.0012)

text_HBN_PNC <- bquote(italic(r) == .(cor_HBN_PNC) * "," ~ italic(p[perm]) < .(format(round(PNC_HBN_perm$p_value, 4), scientific = FALSE)))
HBN_PNC_baseline_plot <- hex_plot(HBN_PNC_baseline, "HBN", "PNC", text_HBN_PNC, ylim1 = 0.00061, ylim2 = 0.0012, xlim1 = 0.00060, xlim2 = 0.0011, x_text = 0.0006, y_text = 0.0012)


# make bin colors the same across plots
# get the maximum bin counts from all datasets
max_count_HCPD_HBN <- max(ggplot_build(HCPD_HBN_baseline_plot)$data[[1]]$count, na.rm = TRUE)
max_count_HCPD_PNC <- max(ggplot_build(HCPD_PNC_baseline_plot)$data[[1]]$count, na.rm = TRUE)
max_count_HBN_PNC  <- max(ggplot_build(HBN_PNC_baseline_plot)$data[[1]]$count, na.rm = TRUE)
global_max_count <- max(max_count_HCPD_HBN, max_count_HCPD_PNC, max_count_HBN_PNC)
scale_limits <- c(0, global_max_count)
HCPD_HBN_baseline_plot <- HCPD_HBN_baseline_plot +
  paletteer::scale_fill_paletteer_c("ggthemes::Blue-Green Sequential", 
                                    direction = -1, 
                                    limits = scale_limits, 
                                    oob = scales::squish)
HCPD_PNC_baseline_plot <- HCPD_PNC_baseline_plot +
  paletteer::scale_fill_paletteer_c("ggthemes::Blue-Green Sequential", 
                                    direction = -1, 
                                    limits = scale_limits, 
                                    oob = scales::squish)

HBN_PNC_baseline_plot <- HBN_PNC_baseline_plot +
  paletteer::scale_fill_paletteer_c("ggthemes::Blue-Green Sequential", 
                                    direction = -1, 
                                    limits = scale_limits, 
                                    oob = scales::squish)

baseline_plots <- ggarrange(HCPD_PNC_baseline_plot, HBN_PNC_baseline_plot, HCPD_HBN_baseline_plot, nrow = 1, common.legend=T, legend = c("bottom"))

title.grob <- textGrob("Age Effect Magnitude of Mean Diffusivity Across Datasets", 
                   gp=gpar(col="black", fontsize = 20, face = "bold"), hjust = 0.5)
 
grid.arrange(arrangeGrob(baseline_plots, top = title.grob))
ggsave(paste0(png_dir, "supp_baseline_hexplots.png"), grid.arrange(arrangeGrob(baseline_plots, top = title.grob)), height = 7, width = 22, units = "in")
```


extra delta delta code:
```{r}
# a version without HBN
diffs_plot_PNC <- plot_diffs("PNC", p_label = expression(italic(p[spin]) == "0.003"), legend_position = "none") + theme(plot.margin = margin(5, 50, 5, 5))
diffs_plot_HCPD <- plot_diffs("HCPD", p_label = expression(italic(p[spin]) < "0.0001"), legend_position = "none") + theme(plot.margin = margin(5, 5, 5, 10))
diffs_plot_PNC_legend <- plot_diffs("PNC", p_label = expression(italic(p[spin]) == "N.S."), legend_position = "right") # just need the legend


diffs_plot_final <- plot_grid(diffs_plot_PNC, diffs_plot_HCPD, ncol = 2)
x.grob <- textGrob("Difference in Mean Sensorimotor-Association Rank Between Endpoints", 
                   gp=gpar(col="black", fontsize=20))
y.grob <- textGrob("Difference in Age of Maturation \n Between Endpoints (Years)", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(diffs_plot_final, left = y.grob, bottom = x.grob))

#ggsave(paste0(png_dir, "fig6_delta_delta_labels.png"), grid.arrange(arrangeGrob(diffs_plot_final, left = y.grob, bottom = x.grob)), height = 5, width = 12, units = "in")

ggsave(paste0(png_dir, "fig6_delta_delta_noHBN.png"), grid.arrange(arrangeGrob(diffs_plot_final, left = y.grob, bottom = x.grob)), height = 6, width = 12, units = "in")
```




move to supp
```{r, compute mean diffs absolute value, fig.height = 5, fig.width = 15}

# compute the difference in mean S-A rank between cortical endpoints
compute_endpoint_absdiffs <- function(bundle_name, lh_all_endpoints, rh_all_endpoints) {
  
  callosum <- c("COrb", "CAntFr", "CSupFr", "CMot", "CSupPar", "CPostPar", "CTemp", "COcc")
  
  if (any(sapply(callosum, function(x) grepl(x, bundle_name)))) {
    bundle_type = "callosum"
  } else {
    bundle_type = "assoc"
  }
  
  # for assocation bundles, get the difference in age of maturation and diff in mean SA
  if(bundle_type == "assoc") {
    bundle_name_string <- paste0(bundle_name) # ugh R idiosyncracies. 
    if(grepl("L$", bundle_name)) {
      SAranks_endpoints <- lh_all_endpoints %>% filter(bundle_name == bundle_name_string) # can't have bundle_name == bundle_name bc it confuses dplyr
    } else{
      SAranks_endpoints <- rh_all_endpoints  %>% filter(bundle_name == bundle_name_string)
    }
    
    endpoints_diffs <- SAranks_endpoints %>% filter(if_all(everything(), ~ !is.na(.))) %>%
      reframe(mean_SA_diff = mean_SA[end == "end1"] - mean_SA[end == "end2"],
              age_effect_diff = abs(age_effect[end == "end1"] - age_effect[end == "end2"])) %>% 
      mutate(bundle_name = bundle_name)
    
    # for callosum bundles, get the difference in age of maturation and diff in mean SA
  } else if (bundle_type == "callosum") {
    bundle_name_lh =  paste0(substr(bundle_name, 1, nchar(bundle_name) - 1), "L")
    bundle_name_rh =  paste0(substr(bundle_name, 1, nchar(bundle_name) - 1), "R")
    
    SAranks_endpoints1 <- lh_all_endpoints %>% filter(bundle_name == bundle_name_lh)  
    SAranks_endpoints2 <- rh_all_endpoints %>% filter(bundle_name == bundle_name_rh) 
    SAranks_endpoints <- rbind(SAranks_endpoints1, SAranks_endpoints2)
    
    endpoints_diffs <- SAranks_endpoints %>% filter(if_all(everything(), ~ !is.na(.))) %>%
      reframe(mean_SA_diff = mean_SA[end == "end1"] - mean_SA[end == "end2"],
              age_effect_diff = abs(age_effect[end == "end1"] - age_effect[end == "end2"])) %>% 
      mutate(bundle_name = bundle_name)
  }
  
  return(endpoints_diffs)
}

# compute delta_delta df's (difference between S-A rank and difference between age of maturationn of 2 cortical endpoints)
compute_absdiffs_wrapper <- function(lh_all_endpoints, rh_all_endpoints) {
  # difference in age of maturation
  lh_diffs <- lapply(lh_names, compute_endpoint_absdiffs, lh_all_endpoints, rh_all_endpoints)
  rh_diffs <- lapply(rh_names, compute_endpoint_absdiffs, lh_all_endpoints, rh_all_endpoints)
  names(lh_diffs) <- lh_names
  names(rh_diffs) <- rh_names
  lh_diffs_all <- bind_rows(lh_diffs) %>%
    filter(if_all(everything(), ~ !is.na(.)))
  rh_diffs_all <- bind_rows(rh_diffs) %>%
    filter(if_all(everything(), ~ !is.na(.)))
  diffs_all <- rbind(lh_diffs_all, rh_diffs_all)
  diffs_all <- diffs_all %>% filter(!grepl("^C.*R$", bundle_name)) # remove redundant callosum bundles (keep just left hemi callosum bundles to show difference between rh and lh endpoints)
  diffs_all$bundle_name <- gsub("^(C.*)L$", "\\1", diffs_all$bundle_name) # rename callosum bundles to NOT have hemisphere
  # make a column to label IFO and ILF, and label Callosum Bundles and Association Bundles - for plotting
  diffs_all <- diffs_all %>% mutate(ifo_ilf_label = case_when(str_detect(bundle_name, "^C") ~ "Callosum",
                                                             TRUE ~ "Association")) 
  diffs_all$ifo_ilf_label <- factor(diffs_all$ifo_ilf_label, levels = c("Association", "Callosum"))
  return(diffs_all)
}

 
# spin test for delta-delta: spin the S-A axis then recompute average S-A rank for each end. Then calculate difference in rank for delta-delta analysis. Then compute t.test and spun p-value for t-test
## @param SAaxis, vector of S-A axis ranks
perm.sphere.SAaxis_delta_absdiff <- function(SAaxis, perm.id, dataset, alternative = "less", var.equal = FALSE) {
  
  nroi = dim(perm.id)[1]  # number of regions
  nperm = dim(perm.id)[2] # number of permutations
  
  # spin SA axis: permutation of measures
  SAaxis.perm = array(NA,dim=c(nroi,nperm))
  for (r in 1:nperm) {
    for (i in 1:nroi) {
      SAaxis.perm[i,r] = SAaxis[perm.id[i,r]]
    }
  }
  
  # if want to compute spun p-value for the delta-delta plot: 
  # empirical t value
  diffs_emp <- get(paste0("diffs_", dataset))
  diffs_emp <- diffs_emp %>% mutate(group = case_when(age_effect_diff < 3 ~ "Small Differences in Age of Maturation",
                                                      age_effect_diff > 3 ~ "Large Differences Age of Maturation",
                                                      TRUE ~ NA_character_))
  t.emp <- t.test(diffs_emp$mean_SA_diff[which(diffs_emp$group == "Small Differences in Age of Maturation")], # compare differences in sa rank
                  diffs_emp$mean_SA_diff[which(diffs_emp$group == "Large Differences Age of Maturation")], 
                  alternative = alternative, var.equal = var.equal)$statistic 
  
  # t-test between permuted S-A axis differences and age of maturation differences between endpoints
  t.null.SAaxis = vector(length=nperm)
  for (r in 1:nperm) {
    print(r)
    # merging of permuted S-A axis to age of maturation df
    perm_mean_SAaxis <- compute_mean_SA(dataset, SAaxis.perm[,r]) # merge permuted S-A rank with age of maturation AND compute mean permuted S-A ranks
    lh_perm_mean_SAaxis <- perm_mean_SAaxis[[1]]
    rh_perm_mean_SAaxis <- perm_mean_SAaxis[[2]]
    
    # calculate difference in rank
    perm_diffs <- compute_absdiffs_wrapper(lh_perm_mean_SAaxis, rh_perm_mean_SAaxis)
    perm_diffs <- perm_diffs %>% mutate(group = case_when(age_effect_diff < 3 ~ "Small Differences in Age of Maturation",
                                                          age_effect_diff > 3 ~ "Large Differences Age of Maturation",
                                                          TRUE ~ NA_character_))
    
    # calculate t-test and permuted t-test: do tracts with very diff ages of maturation between endpoints actually have different s-a ranks?? 
    t.null.SAaxis[r] <- t.test(perm_diffs$mean_SA_diff[which(perm_diffs$group == "Small Differences in Age of Maturation")], 
                               perm_diffs$mean_SA_diff[which(perm_diffs$group == "Large Differences Age of Maturation")], 
                               alternative = alternative, var.equal = var.equal )$statistic
  }
  
  # p-value definition  
  if (t.emp>0) {
    p.perm = sum(t.null.SAaxis>t.emp)/nperm
  } else { 
    p.perm = sum(t.null.SAaxis<t.emp)/nperm
  } 
  
  return(list(p.perm = p.perm, t.emp = t.emp))
  # return p-value for the t-test to see if tracts with very diff ages of maturation between endpoints actually have different s-a rank
  
}

# compute mean absolute difference in S-A rank between the 2 cortical endpoints by the difference in age effect
# regular difference
lh_names <- c("ARCL", "CSTL" ,"ILFL", "IFOL", "SLFL", "pARCL", "VOFL", "COrbL", "CAntFrL" ,"CSupFrL", "CMotL", "CSupParL", "CPostParL", "CTempL", "COccL")
rh_names <- c("ARCR", "CSTR" ,"ILFR", "IFOR", "SLFR", "pARCR", "VOFR", "COrbR", "CAntFrR" ,"CSupFrR", "CMotR", "CSupParR", "CPostParR", "CTempR", "COccR")

diffs_PNC <- compute_absdiffs_wrapper(lh_all_endpoints_PNC, rh_all_endpoints_PNC)  
diffs_PNC <- diffs_PNC %>% mutate(group = ifelse(str_detect(bundle_name, "IFO") | str_detect(bundle_name, "ILF"), 
                        "Large Difference\n in S-A Rank", 
                        "Small Difference\n in S-A Rank"))
diffs_PNC$group <- factor(diffs_PNC$group, levels = c("Small Difference\n in S-A Rank", "Large Difference\n in S-A Rank"))
 
diffs_HCPD <- compute_absdiffs_wrapper(lh_all_endpoints_HCPD, rh_all_endpoints_HCPD)  
diffs_HCPD <- diffs_HCPD %>% mutate(group = ifelse(str_detect(bundle_name, "IFO") | str_detect(bundle_name, "ILF"), 
                        "Large Difference\n in S-A Rank", 
                        "Small Difference\n in S-A Rank"))
diffs_HCPD$group <- factor(diffs_HCPD$group, levels = c("Small Difference\n in S-A Rank", "Large Difference\n in S-A Rank"))

diffs_HBN <- compute_absdiffs_wrapper(lh_all_endpoints_HBN, rh_all_endpoints_HBN)   
diffs_HBN <- diffs_HBN %>% mutate(group = ifelse(str_detect(bundle_name, "IFO") | str_detect(bundle_name, "ILF"), 
                        "Large Difference\n in S-A Rank", 
                        "Small Difference\n in S-A Rank"))
diffs_HBN$group <- factor(diffs_HBN$group, levels = c("Small Difference\n in S-A Rank", "Large Difference\n in S-A Rank"))
 
# hcpd abs diff delta
#perm.sphere.SAaxis_delta_absdiff(glasser_SAaxis$SA.axis_rank, perm.id.full, "HCPD") # pspin = 0, t = -16.41279  
#perm.sphere.SAaxis_delta(glasser_SAaxis$SA.axis_rank, perm.id.full, "HBN") # pspin = NS

# PNC abs diff delta
perm.sphere.SAaxis_delta(glasser_SAaxis$SA.axis_rank, perm.id.full, "PNC") # pspin = 0.0401, t = -2.685804 
 
  
diffs_plot_PNC <- plot_diffs("PNC", p_label = expression(italic(p[spin]) == "0.04"), legend_position = "none") + ylim(-1, 10)
diffs_plot_HCPD <- plot_diffs("HCPD", p_label = expression(italic(p[spin]) < "0.0001"), legend_position = "none") + ylim(-1, 10)
diffs_plot_HBN <- plot_diffs("HBN", p_label = expression(italic(p[spin]) == "N.S."), legend_position = "none") + ylim(-1, 10)
diffs_plot_PNC_legend <- plot_diffs("PNC", p_label = expression(italic(p[spin]) == "N.S."), legend_position = "right") # just need the legend

diffs_plot_final <- plot_grid(diffs_plot_PNC, diffs_plot_HCPD, diffs_plot_HBN, ncol = 3)
x.grob <- textGrob("Difference in Mean Sensorimotor-Association Rank Between Endpoints", 
                   gp=gpar(col="black", fontsize=20))
y.grob <- textGrob("Difference in Age of Maturation \n Between Endpoints (Years)", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(diffs_plot_final, left = y.grob, bottom = x.grob))

#ggsave(paste0(png_dir, "fig6_delta_delta_absdiff_label.png"), grid.arrange(arrangeGrob(diffs_plot_final, left = y.grob, bottom = x.grob)), height = 5, width = 12, units = "in")

ggsave(paste0(png_dir, "fig6_delta_delta_absdiff.png"), grid.arrange(arrangeGrob(diffs_plot_final, left = y.grob, bottom = x.grob)), height = 5, width = 12, units = "in")
#ggsave(paste0(png_dir, "fig6_legend.png"), diffs_plot_PNC_legend, height = 5, width = 5, units = "in")

# IFOL = 213
# IFOR = 241
# callosum motor = 52
```


move to supp
```{r abs diffs average across datasetes}

# absolute difference average across datasets
diffs_PNC <- compute_absdiffs_wrapper(lh_averaged_df, rh_averaged_df)   # calling this "PNC" for now because of the spin test (eve though its actually across dtaset)
diffs_PNC <- diffs_PNC %>% mutate(group = ifelse(str_detect(bundle_name, "IFO") | str_detect(bundle_name, "ILF"), 
                        "Large Difference\n in S-A Rank", 
                        "Small Difference\n in S-A Rank"))
diffs_PNC$group <- factor(diffs_PNC$group, levels = c("Small Difference\n in S-A Rank", "Large Difference\n in S-A Rank"))
 
 
# diffs, average, abs
perm.sphere.SAaxis_delta_absdiff(glasser_SAaxis$SA.axis_rank, perm.id.full, "PNC") # pspin =   
 
 
diffs_plot_avg <- plot_diffs("PNC", p_label = expression(italic(p[spin]) == "TBD"), legend_position = "none") + labs(title = "Average Across Datasets") + ylim(-1, 10)
 
diffs_plot_PNC_legend <- plot_diffs("PNC", p_label = expression(italic(p[spin]) == "N.S."), legend_position = "right") # just need the legend

x.grob <- textGrob("Difference in Mean Sensorimotor-Association Rank Between Endpoints", 
                   gp=gpar(col="black", fontsize=20))
y.grob <- textGrob("Difference in Age of Maturation \n Between Endpoints (Years)", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(diffs_plot_avg, left = y.grob, bottom = x.grob))

#ggsave(paste0(png_dir, "fig6_delta_delta_labels.png"), grid.arrange(arrangeGrob(diffs_plot_final, left = y.grob, bottom = x.grob)), height = 5, width = 12, units = "in")

ggsave(paste0(png_dir, "fig6_delta_delta_avgdatasets_absdiff.png"), grid.arrange(arrangeGrob(diffs_plot_avg, left = y.grob, bottom = x.grob)), height = 5, width = 5, units = "in")

```



checking out derivatives and their CI (may move to supp)
```{r}
HBN_ageeffects %>% filter(str_detect(tract_node, "Left_Cortico"))
df <- HBN_derivs %>% filter(str_detect(tract_node, "Left_Cortico")) %>% mutate(node = str_extract(tract_node, "[0-9]+"))
df$node <- as.numeric(df$node)
df <- df %>% filter(node < 10)
length(which(df$significant == FALSE))
ggplot(df, aes(x = age, y = derivative, ymin = lower, ymax = upper, group = node)) + 
    geom_line(size = .5, color="#9a1ca3") +
    geom_ribbon(alpha = .1, fill = c("grey60")) + 
    theme_classic(base_size=12) + geom_hline(yintercept = 0, linetype = "dashed")


df <- HCPD_derivs %>% filter(str_detect(tract_node, "Left_Cortico")) %>% mutate(node = str_extract(tract_node, "[0-9]+"))
ggplot(df, aes(x = age, y = derivative, ymin = lower, ymax = upper, group = node)) + 
    geom_line(size = .5, color="#9a1ca3") +
    geom_ribbon(alpha = .1, fill = c("grey60")) + 
    theme_classic(base_size=12) + geom_hline(yintercept = 0, linetype = "dashed")


HBN_derivs <- HBN_derivs %>% mutate(ci = abs(lower - upper))
PNC_derivs <- PNC_derivs %>% mutate(ci = abs(lower - upper))
HCPD_derivs <- HCPD_derivs %>% mutate(ci = abs(lower - upper))

HBN_derivs <- HBN_derivs %>% mutate(Dataset="HBN")
PNC_derivs <- PNC_derivs %>% mutate(Dataset="PNC")
HCPD_derivs <- HCPD_derivs %>% mutate(Dataset="HCPD")

df <- rbind(HBN_derivs, PNC_derivs, HCPD_derivs)
 
means <- df %>%
  group_by(Dataset) %>%
  summarize(mean_ci = mean(ci, na.rm = TRUE))


ggplot(data=df, aes(x=ci, fill=Dataset)) +
    geom_histogram( color="#e9ecef", alpha=0.8, position = 'identity') +
  geom_vline(data = means, aes(xintercept = mean_ci, color = Dataset), size = 1) +
    labs(fill="")



HBN_ageeffects <- HBN_ageeffects %>% mutate(Dataset = "HBN")
PNC_ageeffects <- PNC_ageeffects %>% mutate(Dataset = "PNC")
HCPD_ageeffects <- HCPD_ageeffects %>% mutate(Dataset = "HCPD")
df <- rbind(HBN_ageeffects, PNC_ageeffects, HCPD_ageeffects)
means <- df %>%
  group_by(Dataset) %>%
  summarize(mean_age = mean(smooth.decrease.offset, na.rm = TRUE))


ggplot(data=df, aes(x=smooth.decrease.offset, fill=Dataset)) +
    geom_histogram( color="#e9ecef", alpha=0.8, position = 'identity') +
  geom_vline(data = means, aes(xintercept = mean_age, color = Dataset), size = 1) +
    labs(fill="")

```



# Figure 7: Peripheral white matter development is associated with the cortical hierarchy
average age of maturation map across tracts, across datasets
```{r avg age of mat across all dataset, fig.height = 3, fig.width = 8}
lh_PNC_merge <- lh_by_region_PNC %>% rename(PNC_mean_ageeffect = regional_mean_ageeffect)
lh_HCPD_merge <- lh_by_region_HCPD %>% rename(HCPD_mean_ageeffect = regional_mean_ageeffect)
lh_HBN_merge <- lh_by_region_HBN %>% rename(HBN_mean_ageeffect = regional_mean_ageeffect)

merge_temp <- merge(lh_HCPD_merge, lh_HBN_merge, by = "region")
lh_all_datasets_ageMat <- merge(merge_temp, lh_PNC_merge, by = "region")
lh_all_datasets_ageMat <- lh_all_datasets_ageMat %>% # left hemi age of maturation maps
  mutate(regional_mean_ageeffect = rowMeans(select(., HCPD_mean_ageeffect, HBN_mean_ageeffect, PNC_mean_ageeffect), na.rm = TRUE))

rh_PNC_merge <- rh_by_region_PNC %>% rename(PNC_mean_ageeffect = regional_mean_ageeffect)
rh_HCPD_merge <- rh_by_region_HCPD %>% rename(HCPD_mean_ageeffect = regional_mean_ageeffect)
rh_HBN_merge <- rh_by_region_HBN %>% rename(HBN_mean_ageeffect = regional_mean_ageeffect)

merge_temp <- merge(rh_HCPD_merge, rh_HBN_merge, by = "region")
rh_all_datasets_ageMat <- merge(merge_temp, rh_PNC_merge, by = "region")
rh_all_datasets_ageMat <- rh_all_datasets_ageMat %>% # right hemi age of maturation maps
  mutate(regional_mean_ageeffect = rowMeans(select(., HCPD_mean_ageeffect, HBN_mean_ageeffect, PNC_mean_ageeffect), na.rm = TRUE))

aggregated_age_mat_plot <- plot_aggregated_maps(lh_all_datasets_ageMat, rh_all_datasets_ageMat, ylim1 = 15, ylim2 = 23.5, dataset = "Aggregated Age of Maturation Map Across Datasets")
aggregated_age_mat_plot
ggsave(paste0(png_dir, "fig7_aggregated_age_mat_noACT.png"), aggregated_age_mat_plot, height = 3, width = 8, units = "in")
```


```{r SA by age of mat plot all parcels, fig.height = 5, fig.width = 15}
aggregated_axis_PNC <- merge_SA_parcel("PNC")   # 360 glasser parcels with mean age maturation and SA rank
aggregated_axis_HCPD <- merge_SA_parcel("HCPD") 
aggregated_axis_HBN <- merge_SA_parcel("HBN")  


#perm.sphere.p(x = aggregated_axis_PNC$SA.axis_rank, y = aggregated_axis_PNC$regional_mean_ageeffect, perm.id = perm.id.full, corr.type = "pearson") 
#perm.sphere.p(x = aggregated_axis_HCPD$SA.axis_rank, y = aggregated_axis_HCPD$regional_mean_ageeffect, perm.id = perm.id.full, corr.type = "pearson") 
#perm.sphere.p(x = aggregated_axis_HBN$SA.axis_rank, y = aggregated_axis_HBN$regional_mean_ageeffect, perm.id = perm.id.full, corr.type = "pearson") 

cor.test(aggregated_axis_PNC$SA.axis_rank, aggregated_axis_PNC$regional_mean_ageeffect, method = "pearson", use = "complete.obs") # r = 0.72, pspin < 0.0001

cor(aggregated_axis_HCPD$SA.axis_rank, aggregated_axis_HCPD$regional_mean_ageeffect, method = "pearson", use = "complete.obs") # r = 0.77, pspin <  0.0001; 

cor.test(aggregated_axis_HBN$SA.axis_rank, aggregated_axis_HBN$regional_mean_ageeffect, method = "pearson", use = "complete.obs") # r = 0.18, pspin = 0.0348; r = 0.06, pspin = NS if noACT


# remember, this data is using bin = 5 (5 nodes at each end, after clipping 5 nodes already)
annot_text_PNC <- expression(paste(italic("r"), " = 0.72, ",  , italic(p[spin]), "< 0.0001"))
annot_text_HCPD <- expression(paste(italic("r"), " = 0.77, ",  , italic(p[spin]), "< 0.0001"))
annot_text_HBN <- expression(paste(italic("r"), " = 0.06, ",  , italic(p[spin]), "= N.S."))

agg_SA_parcel_HCPD <- plot_agg_SA_parcel("HCPD", annot_text_HCPD, all_parcels = TRUE)
agg_SA_parcel_HBN <- plot_agg_SA_parcel("HBN", annot_text_HBN, all_parcels = TRUE)
agg_SA_parcel_PNC <- plot_agg_SA_parcel("PNC", annot_text_PNC, all_parcels = TRUE)

agg_SA_parcel_plot_final <- ggarrange(agg_SA_parcel_PNC, agg_SA_parcel_HCPD, agg_SA_parcel_HBN, ncol = 3)
x.grob <- textGrob("S-A Axis Rank", gp=gpar(col="black", fontsize=20))
y.grob <- textGrob("Age of Maturation (Years)", gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(agg_SA_parcel_plot_final, left = y.grob, bottom = x.grob))

ggsave(paste0(png_dir, "fig7_SA_bin5_allparcels_noACT.png"), grid.arrange(arrangeGrob(agg_SA_parcel_plot_final, left = y.grob, bottom = x.grob)), height = 5, width = 15, units = "in")
```





#Mean diffusivity maps of peripheral white matter
```{r load baseline tract profiles}
PNC <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_viz.RData", output_root, "PNC"))
HCPD <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_viz.RData", output_root, "HCPD"))
#HBN <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_viz.RData", output_root, "HBN"))
HBN <- readRDS(sprintf("%1$s/%2$s/tract_profiles/all_subjects/tract_profiles_for_viz_noACT.RData", output_root, "HBN"))

```


```{r compute mean}
# make summary df's: this creates summary_[dataset]_[scalar] dataframes that include mean, sd, se for each scalar/dataset
make_summary_dfs <- function(scalar, dataset_name, df) {
  # set variables
  mean_scalar <- paste0("mean_", scalar)
  # Process the given dataset df
  scalar_data <- df %>% select(sub, tractID, tract_label, nodeID, hemi, all_of(scalar))
  sqrt_n <- sqrt(length(unique(scalar_data$sub)))
  setDT(scalar_data)
  summary_data <- scalar_data[, .(
    mean_scalar = mean(.SD[[1]], na.rm = TRUE),
    sd = sd(.SD[[1]], na.rm = TRUE),
    se = sd(.SD[[1]], na.rm = TRUE) / sqrt_n,
    ymin_sd = mean(.SD[[1]], na.rm = TRUE) - sd(.SD[[1]], na.rm = TRUE),
    ymax_sd = mean(.SD[[1]], na.rm = TRUE) + sd(.SD[[1]], na.rm = TRUE),
    ymin_se = mean(.SD[[1]], na.rm = TRUE) - (sd(.SD[[1]], na.rm = TRUE) / sqrt_n),
    ymax_se = mean(.SD[[1]], na.rm = TRUE) + (sd(.SD[[1]], na.rm = TRUE) / sqrt_n),
    cv = (sd(.SD[[1]], na.rm = TRUE) / (mean(.SD[[1]], na.rm = TRUE))) * 100
  ), by = .(tract_label, tractID, nodeID, hemi), .SDcols = scalar]

  setnames(summary_data, "mean_scalar", paste0("mean_", scalar))
  summary_data[, Dataset := dataset_name]
  summary_dataset_scalar <- paste0("summary_", dataset_name, "_", scalar)
  assign(summary_dataset_scalar, summary_data, envir = .GlobalEnv)
}

datasets <- list(HCPD = HCPD, HBN = HBN, PNC = PNC)

# create summary dfs
# get the average MD for each node for each dataset

for (dataset_name in names(datasets)) {
  dataset <- datasets[[dataset_name]]
  make_summary_dfs("dti_md", dataset_name, dataset) # this creates summary_[dataset]_[scalar] dataframes that include mean, sd, se  
}
```

```{r load glasser tract to region maps, results = hide}
# load glasser labels
glasser_labels <- read.csv("/cbica/projects/luo_wm_dev/atlases/glasser/HCP-MMP1_UniqueRegionList.csv")
glasser_labels$regionID <- c(1:360)
glasser_labels$region <- gsub("7Pl", "7PL", glasser_labels$region)   

# load maps for depth = 1.5mm
lapply("1.5", load_maps, "HCPD") # makes lh_maps_HCPD, rh_maps_HCPD 
lapply("1.5", load_maps, "HBN") # makes lh_maps_HBN, rh_maps_HBN
lapply("1.5", load_maps, "PNC") # makes lh_maps_PNC, rh_maps_PNC
```

```{r make cortical endpoint maps for average MD}
threshold=0.3

PNC_avgMD_5 <- summary_PNC_dti_md %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_dti_md) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_dti_md, na.rm = T))

HCPD_avgMD_5 <- summary_HCPD_dti_md %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_dti_md) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_dti_md, na.rm = T))

HBN_avgMD_5 <- summary_HBN_dti_md %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_dti_md) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_dti_md, na.rm = T))

make_maps_MD("PNC", "5") # makes [bundle_name]_avgMD_[dataset] for each dataset and bundle. e.g. IFOL_avgMD_PNC
make_maps_MD("HCPD", "5") 
make_maps_MD("HBN", "5")
```

```{r aggregate MD maps}
region_all_PNC <- aggregate_avgMD_maps("PNC")  
lh_by_region_PNC <- region_all_PNC[[1]]
rh_by_region_PNC <- region_all_PNC[[2]]

region_all_HCPD <- aggregate_avgMD_maps("HCPD")  
lh_by_region_HCPD <- region_all_HCPD[[1]]
rh_by_region_HCPD <- region_all_HCPD[[2]]

region_all_HBN <- aggregate_avgMD_maps("HBN")  
lh_by_region_HBN <- region_all_HBN[[1]]
rh_by_region_HBN <- region_all_HBN[[2]]
```

```{r plot mean peripheral MD, fig.height = 5, fig.width = 10}
plot_aggregated_avgMD_maps <- function(lh_by_region_df, rh_by_region_df, title, ylim1, ylim2) {
  hemi = "left"
  cortical_pos <- c("left lateral", "left medial")
  lh_agg <- ggplot() + 
      geom_brain(data = lh_by_region_df, atlas = glasser, 
                 mapping=aes(fill = regional_mean_MD, colour = coverage, size = I(0.4)), 
                 show.legend=TRUE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos)) + 
    
      paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", na.value = "grey100", limits = c(ylim1, ylim2), oob=squish, direction = -1) +  
      scale_colour_manual(values = c(yes = "gray30", no = "grey84")) +  
      theme_void() +
      theme(legend.position = "none",
            legend.key.height = unit(1, 'cm'),
            legend.key.width = unit(2.3, 'cm'),
            legend.margin=margin(0,0,0,0),
            legend.text = element_text(size=24),
            legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
            plot.title = element_text(size=20, hjust = 0.5)) + guides(
    colour = "none",  # Remove legend for color
    size = "none"     # Remove legend for size if not needed
  )


  hemi = "right"
  cortical_pos <- c("right lateral", "right medial")



  rh_agg <- ggplot() + 
        geom_brain(data = rh_by_region_df, atlas = glasser, 
                   mapping=aes(fill = regional_mean_MD, colour = coverage, size = I(0.4)), 
                   show.legend=TRUE, 
                   hemi = hemi,
                   position = position_brain(cortical_pos)) + 
      
        paletteer::scale_fill_paletteer_c("grDevices::RdYlBu", na.value = "grey100", limits = c(ylim1, ylim2), oob=squish, direction = -1) +  
        scale_colour_manual(values = c(yes = "gray30", no = "grey84")) + 
        theme_void() +
        theme(legend.position = "none",
              legend.key.height = unit(1, 'cm'),
              legend.key.width = unit(2.3, 'cm'),
              legend.margin=margin(0,0,0,0),
              legend.text = element_text(size=24),
              legend.title = element_blank(),
              plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
              plot.title = element_text(size=20, hjust = 0.5))  + guides(
      colour = "none",  # Remove legend for color
      size = "none"     # Remove legend for size if not needed
    )
  
  
  agg_plots <- ggarrange(lh_agg, rh_agg, ncol=1, nrow = 2)
  agg_final <- annotate_figure(agg_plots, top = text_grob(title, 
                 color = "black", face = "bold", size = 20, vjust = -0.75)) + theme(plot.margin = unit(c(1, 0, 0, 0), "cm")) 
  
  
  legend <- get_legend(lh_agg + theme(legend.position = "right",
                                              legend.key.height = unit(1.5, 'cm'),
                                              legend.key.width = unit(0.5, 'cm'),
                                              legend.margin=margin(0,0,0,-50),
                                              legend.text = element_text(size=20),
                                              legend.title = element_blank()))

  
  return(ggarrange(agg_final, legend, ncol = 2, nrow = 1, widths = c(1, 0.5)))
  
}


plot_aggregated_avgMD_maps(lh_by_region_PNC, rh_by_region_PNC, "PNC", 0.00065, 0.00089) 
plot_aggregated_avgMD_maps(lh_by_region_HCPD, rh_by_region_HCPD, "HCP-D", 0.00065, 0.00089) 
plot_aggregated_avgMD_maps(lh_by_region_HBN, rh_by_region_HBN, "HBN", 0.00065, 0.00089) 
```


Mean diffusivity maps of peripheral white matter for ages 8-12 and 18-23
```{r functions for making mean maps}
make_maps_MD <- function(dataset, bin_num_nodes) {
  
  lh_maps <- get(paste0("lh_maps_", dataset))
  rh_maps <- get(paste0("rh_maps_", dataset))
  avgMD <- get(paste0(dataset, "_avgMD_", bin_num_nodes))
  
  # for tracts with 1 endpoint (CST), extract the age effect for end1 (corresponds to cortical endpoint) 
  CSTL_avgMD <- lh_maps$LeftCorticospinal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Left_Corticospinal" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CSTR_avgMD <- rh_maps$RightCorticospinal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Right_Corticospinal" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  # for tracts with 2 distinct cortical endpoints: ARC, ILF, IFO, SLF
  ARCL_avgMD <- lh_maps$LeftArcuate %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = case_when(
        !is.na(thresh_probability) & (str_detect(cortex, "(?i)frontal") | str_detect(cortex, "(?i)motor") | str_detect(cortex, "(?i)Posterior_Opercular")) ~ 
          avgMD %>% filter(tractID == "Left_Arcuate", node_position == "end1") %>% pull(mean_peripheral_MD),
        !is.na(thresh_probability) & (str_detect(cortex, "(?i)Temp") | str_detect(cortex, "(?i)Auditory")) ~ 
          avgMD %>% filter(tractID == "Left_Arcuate", node_position == "end2") %>% pull(mean_peripheral_MD),
        TRUE ~ NA_real_
      )
    ) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & (str_detect(cortex, "(?i)frontal") | str_detect(cortex, "motor") | str_detect(cortex, "Posterior_Opercular")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & (str_detect(cortex, "Temp") | str_detect(cortex, "Auditory") ), 
          "end2", 
          NA))
    ) %>%
    relocate(mean_peripheral_MD)
  
  ARCR_avgMD <- rh_maps$RightArcuate %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = case_when(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") | str_detect(cortex, "(?i)motor") | str_detect(cortex, "(?i)Posterior_Opercular")) ~ 
          avgMD %>% filter(tractID == "Left_Arcuate", node_position == "end1") %>% pull(mean_peripheral_MD),
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)Temp") | str_detect(cortex, "(?i)MT") | str_detect(cortex, "(?i)Auditory")) ~ 
          avgMD %>% filter(tractID == "Left_Arcuate", node_position == "end2") %>% pull(mean_peripheral_MD),
        TRUE ~ NA_real_
      ),
      end = case_when(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") | str_detect(cortex, "(?i)motor") | str_detect(cortex, "(?i)Posterior_Opercular")) ~ "end1",
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)Temp") | str_detect(cortex, "(?i)MT") | str_detect(cortex, "(?i)Auditory")) ~ "end2",
        TRUE ~ NA_character_
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  ILFL_avgMD <- lh_maps$LeftInferiorLongitudinal %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = case_when(
        !is.na(thresh_probability) & 
          !str_detect(cortex, "(?i)visual|Inferior_Parietal|Occipital") ~ 
          avgMD %>% filter(tractID == "Left_Inferior_Longitudinal", node_position == "end1") %>% pull(mean_peripheral_MD),
        !is.na(thresh_probability) & 
          str_detect(cortex, "(?i)visual|Inferior_Parietal|Occipital") ~ 
          avgMD %>% filter(tractID == "Left_Inferior_Longitudinal", node_position == "end2") %>% pull(mean_peripheral_MD),
        TRUE ~ NA_real_
      ),
      end = case_when(
        !is.na(thresh_probability) & 
          !str_detect(cortex, "(?i)visual|Inferior_Parietal|Occipital") ~ "end1",
        !is.na(thresh_probability) & 
          str_detect(cortex, "(?i)visual|Inferior_Parietal|Occipital") ~ "end2",
        TRUE ~ NA_character_
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  
  ILFR_avgMD <- rh_maps$RightInferiorLongitudinal %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability) & (!str_detect(cortex, "(?i)visual")) & region != "PHA3", 
        avgMD %>%  filter(tractID == "Right_Inferior_Longitudinal", node_position == "end1") %>% pull(mean_peripheral_MD),
        ifelse(
          !is.na(thresh_probability) & (str_detect(cortex, "(?i)visual")) | region == "PHA3", 
          avgMD %>%  filter(tractID == "Right_Inferior_Longitudinal", node_position == "end2") %>% pull(mean_peripheral_MD),
          NA))
    ) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & (!str_detect(cortex, "(?i)visual")) & region != "PHA3", 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & (str_detect(cortex, "(?i)visual")) | region == "PHA3", 
          "end2", 
          NA))
    ) %>%
    relocate(mean_peripheral_MD) %>% arrange(end)
  
  
  IFOL_avgMD <- lh_maps$LeftInferiorFrontooccipital %>%
    mutate(
      thresh_probability = ifelse(probability < 0.1, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(mean_peripheral_MD = case_when(
      !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal|Auditory")) ~ 
        avgMD %>% filter(tractID == "Left_Inferior_Fronto.occipital", node_position == "end1") %>% pull(mean_peripheral_MD),
      !is.na(thresh_probability) & 
        str_detect(cortex, "(?i)visual") ~ 
        avgMD %>% filter(tractID == "Left_Inferior_Fronto.occipital", node_position == "end2") %>% pull(mean_peripheral_MD),
      TRUE ~ NA_real_)) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") | 
             str_detect(cortex, "Auditory")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)visual")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  IFOR_avgMD <- rh_maps$RightInferiorFrontooccipital %>%
    mutate(
      thresh_probability = ifelse(probability < 0.1, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal")  |
             str_detect(cortex, "Auditory")), 
        avgMD %>% filter(tractID == "Right_Inferior_Fronto.occipital", node_position == "end1") %>% pull(mean_peripheral_MD),
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)visual")), 
          avgMD %>% filter(tractID == "Right_Inferior_Fronto.occipital", node_position == "end2") %>% pull(mean_peripheral_MD),
          NA
        )
      )
    ) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") | 
             str_detect(cortex, "Auditory")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)visual")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  SLFL_avgMD <- lh_maps$LeftSuperiorLongitudinal %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") |
             str_detect(cortex, "(?i)motor") | 
             str_detect(cortex, "(?i)Opercular")), 
        avgMD %>% filter(tractID == "Left_Superior_Longitudinal", node_position == "end1") %>% pull(mean_peripheral_MD),
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)pariet|(?i)auditory")), 
          avgMD %>% filter(tractID == "Left_Superior_Longitudinal", node_position == "end2") %>% pull(mean_peripheral_MD),
          NA))) %>%
    mutate(end = ifelse(
      !is.na(thresh_probability) & 
        (str_detect(cortex, "(?i)frontal") |
           str_detect(cortex, "(?i)motor") | 
           str_detect(cortex, "(?i)Opercular")), 
      "end1", 
      ifelse(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)pariet|(?i)auditory")), 
        "end2", 
        NA))) %>%
    relocate(mean_peripheral_MD)
  
  SLFR_avgMD <- rh_maps$RightSuperiorLongitudinal %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") |
             str_detect(cortex, "(?i)motor") | 
             str_detect(cortex, "(?i)Opercular")), 
        avgMD %>% filter(tractID == "Right_Superior_Longitudinal", node_position == "end1") %>% pull(mean_peripheral_MD),
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)pariet")), 
          avgMD %>% filter(tractID == "Right_Superior_Longitudinal", node_position == "end2") %>% pull(mean_peripheral_MD),
          NA))) %>%
    mutate(
      end = ifelse(
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)frontal") |
             str_detect(cortex, "(?i)motor") | 
             str_detect(cortex, "(?i)Opercular")), 
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)pariet")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  # for tracts with 2 cortical endpoints that require some manual work: pARC, VOF 
  pARCL_avgMD <- lh_maps$LeftPosteriorArcuate %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = ifelse( 
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)parietal")),  # might exclude TPOJ1 since its between the two endpoints
        avgMD %>% filter(tractID == "Left_Posterior_Arcuate", node_position == "end1") %>% pull(mean_peripheral_MD),
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)temporal") |
               str_detect(cortex, "(?i)visual") |
               str_detect(cortex, "(?i)auditory")), 
          avgMD %>% filter(tractID == "Left_Posterior_Arcuate", node_position == "end2") %>% pull(mean_peripheral_MD), 
          NA))) %>%
    mutate(
      end = ifelse( 
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)parietal")),  # might exclude TPOJ1 since its between the two endpoints
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)temporal") |
               str_detect(cortex, "(?i)visual") |
               str_detect(cortex, "(?i)auditory")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  pARCR_avgMD <- rh_maps$RightPosteriorArcuate %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = ifelse( 
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)parietal")),  # might exclude TPOJ1 since its between the two endpoints
        avgMD %>% filter(tractID == "Right_Posterior_Arcuate", node_position == "end1") %>% pull(mean_peripheral_MD), 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)temporal") |
               str_detect(cortex, "(?i)visual") |
               str_detect(cortex, "(?i)auditory")), 
          avgMD %>% filter(tractID == "Right_Posterior_Arcuate", node_position == "end2") %>% pull(mean_peripheral_MD), 
          NA
        )
      )
    ) %>%
    mutate(
      end = ifelse( 
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)parietal")),  # might exclude TPOJ1 since its between the two endpoints
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)temporal") |
               str_detect(cortex, "(?i)visual") |
               str_detect(cortex, "(?i)auditory")), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  VOFL_avgMD <- lh_maps$LeftVerticalOccipital %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = ifelse( 
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)dorsal") | 
             str_detect(cortex, "(?i)parietal") |
             region == "LO1" |
             region == "V3CD" |
             region == "V4" | # kind of arbitrarily placing V3 and V4  
             region == "MST" |
             region == "MT" | 
             region == "TPOJ3" |
             region == "LO3"),   
        avgMD %>% filter(tractID == "Left_Vertical_Occipital", node_position == "end1") %>% pull(mean_peripheral_MD), 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)ventral") | 
               region == "PH" |
               region == "LO2" |
               region == "V3"), 
          avgMD %>% filter(tractID == "Left_Vertical_Occipital", node_position == "end2") %>% pull(mean_peripheral_MD), 
          NA))) %>%
    mutate(
      end = ifelse( 
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)dorsal") | 
             str_detect(cortex, "(?i)parietal") |
             region == "LO1" |
             region == "V3CD" |
             region == "V4" | # kind of arbitrarily placing V3 and V4  
             region == "MST" |
             region == "MT" |
             region == "TPOJ3" |
             region == "LO3"),   
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)ventral") | 
               region == "PH" |
               region == "LO2" |
               region == "V3" ), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  
  VOFR_avgMD <- rh_maps$RightVerticalOccipital %>%
    mutate(
      thresh_probability = ifelse(probability < threshold, NA, probability)
    ) %>%
    select(thresh_probability, regionName, region,  cortex) %>%
    arrange(thresh_probability) %>%
    mutate(
      mean_peripheral_MD = ifelse( 
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)dorsal") | 
             str_detect(cortex, "(?i)parietal") |
             region == "LO1" |
             region == "V3CD" |
             region == "V4" | # kind of arbitrarily placing V3 and V4  
             region == "LO3" | 
             region == "TPOJ3"),   
        avgMD %>% filter(tractID == "Right_Vertical_Occipital", node_position == "end1") %>% pull(mean_peripheral_MD), 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)ventral") | 
               region == "PH" |
               region == "LO2" |
               region == "MST" |
               region == "V3"), 
          avgMD %>% filter(tractID == "Right_Vertical_Occipital", node_position == "end2") %>% pull(mean_peripheral_MD), NA
        )
      )
    ) %>%
    mutate(
      end = ifelse( 
        !is.na(thresh_probability) & 
          (str_detect(cortex, "(?i)dorsal") |
             str_detect(cortex, "(?i)parietal") |
             region == "LO1" |
             region == "V3CD" |
             region == "V4"| # kind of arbitrarily placing V3 and V4  
             region == "LO3" | 
             region == "TPOJ3"),   
        "end1", 
        ifelse(
          !is.na(thresh_probability) & 
            (str_detect(cortex, "(?i)ventral") | 
               region == "PH" |
               region == "LO2" |
               region == "V3" | 
               region == "MST" |
               region == "FST"), 
          "end2", 
          NA
        )
      )
    ) %>%
    relocate(mean_peripheral_MD)
  
  
  # callosum bundles
  COrbL_avgMD <- lh_maps$LeftCallosumOrbital %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Orbital" & node_position == "end2") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  COrbR_avgMD <- rh_maps$RightCallosumOrbital %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Orbital" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  
  CAntFrL_avgMD <- lh_maps$LeftCallosumAnteriorFrontal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Anterior_Frontal" & node_position == "end2") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CAntFrR_avgMD <- rh_maps$RightCallosumAnteriorFrontal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Anterior_Frontal" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CSupFrL_avgMD <- lh_maps$LeftCallosumSuperiorFrontal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Superior_Frontal" & node_position == "end2") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CSupFrR_avgMD <- rh_maps$RightCallosumSuperiorFrontal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Superior_Frontal" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CMotL_avgMD <- lh_maps$LeftCallosumMotor %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Motor" & node_position == "end2") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CMotR_avgMD <- rh_maps$RightCallosumMotor %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Motor" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CSupParL_avgMD <- lh_maps$LeftCallosumSuperiorParietal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Superior_Parietal" & node_position == "end2") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CSupParR_avgMD <- rh_maps$RightCallosumSuperiorParietal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Superior_Parietal" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CPostParL_avgMD <- lh_maps$LeftCallosumPosteriorParietal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Posterior_Parietal" & node_position == "end2") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CPostParR_avgMD <- rh_maps$RightCallosumPosteriorParietal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Posterior_Parietal" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CTempL_avgMD <- lh_maps$LeftCallosumTemporal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Temporal" & node_position == "end2") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  CTempR_avgMD <- rh_maps$RightCallosumTemporal %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Temporal" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  COccL_avgMD <- lh_maps$LeftCallosumOccipital %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Occipital" & node_position == "end2") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end2", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  COccR_avgMD <- rh_maps$RightCallosumOccipital %>% mutate(
    thresh_probability = ifelse(probability < threshold, NA, probability)
  ) %>% 
    select(thresh_probability, regionName, region, cortex) %>%
    arrange(thresh_probability) %>% 
    mutate(
      mean_peripheral_MD = ifelse(
        !is.na(thresh_probability), 
        avgMD %>% filter(tractID == "Callosum_Occipital" & node_position == "end1") %>% pull(mean_peripheral_MD), NA)
    ) %>% 
    mutate(
      end = ifelse(
        !is.na(thresh_probability), 
        "end1", NA)
    ) %>%
    relocate(mean_peripheral_MD)
  
  assign(paste0("CSTL_avgMD_", dataset), CSTL_avgMD, envir = .GlobalEnv)
  assign(paste0("CSTR_avgMD_", dataset), CSTR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("ARCL_avgMD_", dataset), ARCL_avgMD, envir = .GlobalEnv)
  assign(paste0("ARCR_avgMD_", dataset), ARCR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("IFOL_avgMD_", dataset), IFOL_avgMD, envir = .GlobalEnv)
  assign(paste0("IFOR_avgMD_", dataset), IFOR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("ILFL_avgMD_", dataset), ILFL_avgMD, envir = .GlobalEnv)
  assign(paste0("ILFR_avgMD_", dataset), ILFR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("pARCL_avgMD_", dataset), pARCL_avgMD, envir = .GlobalEnv)
  assign(paste0("pARCR_avgMD_", dataset), pARCR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("SLFL_avgMD_", dataset), SLFL_avgMD, envir = .GlobalEnv)
  assign(paste0("SLFR_avgMD_", dataset), SLFR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("VOFL_avgMD_", dataset), VOFL_avgMD, envir = .GlobalEnv)
  assign(paste0("VOFR_avgMD_", dataset), VOFR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("COrbL_avgMD_", dataset), COrbL_avgMD, envir = .GlobalEnv)
  assign(paste0("COrbR_avgMD_", dataset), COrbR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("CAntFrL_avgMD_", dataset), CAntFrL_avgMD, envir = .GlobalEnv)
  assign(paste0("CAntFrR_avgMD_", dataset), CAntFrR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("CSupFrL_avgMD_", dataset), CSupFrL_avgMD, envir = .GlobalEnv)
  assign(paste0("CSupFrR_avgMD_", dataset), CSupFrR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("CMotL_avgMD_", dataset), CMotL_avgMD, envir = .GlobalEnv)
  assign(paste0("CMotR_avgMD_", dataset), CMotR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("CSupParL_avgMD_", dataset), CSupParL_avgMD, envir = .GlobalEnv)
  assign(paste0("CSupParR_avgMD_", dataset), CSupParR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("CPostParL_avgMD_", dataset), CPostParL_avgMD, envir = .GlobalEnv)
  assign(paste0("CPostParR_avgMD_", dataset), CPostParR_avgMD, envir = .GlobalEnv)
  
  assign(paste0("CTempL_avgMD_", dataset), CTempL_avgMD, envir = .GlobalEnv)
  assign(paste0("CTempR_avgMD_", dataset), CTempR_avgMD, envir = .GlobalEnv)
  
  
  assign(paste0("COccL_avgMD_", dataset), COccL_avgMD, envir = .GlobalEnv)
  assign(paste0("COccR_avgMD_", dataset), COccR_avgMD, envir = .GlobalEnv)
}


## This is done for each dataset.
aggregate_avgMD_maps <- function(dataset) {
  # left hemi
  lh_base_names <- c("COrbL_avgMD_", "CAntFrL_avgMD_", "CSupFrL_avgMD_", 
                     "CMotL_avgMD_", "CSupParL_avgMD_", "CPostParL_avgMD_", 
                     "CTempL_avgMD_", "COccL_avgMD_", "ARCL_avgMD_", 
                     "IFOL_avgMD_", "SLFL_avgMD_", "CSTL_avgMD_", 
                     "ILFL_avgMD_", "pARCL_avgMD_", "VOFL_avgMD_")
  lh_dfs <- lapply(lh_base_names, function(name) get(paste0(name, dataset))) # tract_avgMD_dataset (age of maturation maps for each tract from make_maps)
  lh_by_region_all <- do.call(rbind, lh_dfs) %>% group_by(region) %>% 
    summarise(regional_mean_MD = mean(mean_peripheral_MD, na.rm=T))
  lh_by_region_all <- lh_by_region_all %>% mutate(coverage = ifelse(is.na(regional_mean_MD), "no", "yes"))
  
  # right hemi
  rh_base_names <- c("COrbR_avgMD_", "CAntFrR_avgMD_", "CSupFrR_avgMD_", 
                     "CMotR_avgMD_", "CSupParR_avgMD_", "CPostParR_avgMD_", 
                     "CTempR_avgMD_", "COccR_avgMD_", "ARCR_avgMD_", 
                     "IFOR_avgMD_", "SLFR_avgMD_", "CSTR_avgMD_", 
                     "ILFR_avgMD_", "pARCR_avgMD_", "VOFR_avgMD_")
  
  rh_dfs <- lapply(rh_base_names, function(name) get(paste0(name, dataset)))
  rh_by_region_all <- do.call(rbind, rh_dfs) %>% group_by(region) %>% 
    summarise(regional_mean_MD = mean(mean_peripheral_MD, na.rm=T))
  rh_by_region_all <- rh_by_region_all %>% mutate(coverage = ifelse(is.na(regional_mean_MD), "no", "yes"))

  return(list(lh_by_region_all, rh_by_region_all))
}
```

```{r compute mean for age quartiles}
PNC_dem <- read.csv("/cbica/projects/luo_wm_dev/input/PNC/sample_selection_files/final_sample/PNC_WMDev_FinalSampleDemoQC.csv", header=T)
HCPD_dem <- read.csv("/cbica/projects/luo_wm_dev/input/HCPD/sample_selection_files/final_sample/HCPD_WMDev_FinalSampleDemoQC.csv", header=T)
#HBN_dem <- read.csv("/cbica/projects/luo_wm_dev/input/HBN/sample_selection_files/final_sample/HBN_WMDev_FinalSampleDemoQC.csv", header=T)
HBN_dem <- read.csv("/cbica/projects/luo_wm_dev/input/HBN/sample_selection_files/HBN_WMDev_FinalSampleDemoQC_noACT.csv")


PNC <- merge(PNC_dem, PNC)
HCPD <- merge(HCPD_dem, HCPD)
HBN <- merge(HBN_dem, HBN)
 
# make summary df's: this creates summary_[dataset]_[scalar] dataframes that include mean, sd, se for each scalar/dataset
make_summary_dfs_age <- function(scalar, df, age_lower, age_upper) {
  # set variables
  mean_scalar <- paste0("mean_", scalar)
  # Process the given dataset df
  df <- df %>% filter(age > age_lower & age <= age_upper)
 
  scalar_data <- df %>% select(sub, tractID, tract_label, nodeID, hemi, all_of(scalar))
  sqrt_n <- sqrt(length(unique(scalar_data$sub)))
  setDT(scalar_data)
  summary_data <- scalar_data[, .(
    mean_scalar = mean(.SD[[1]], na.rm = TRUE),
    sd = sd(.SD[[1]], na.rm = TRUE),
    se = sd(.SD[[1]], na.rm = TRUE) / sqrt_n,
    ymin_sd = mean(.SD[[1]], na.rm = TRUE) - sd(.SD[[1]], na.rm = TRUE),
    ymax_sd = mean(.SD[[1]], na.rm = TRUE) + sd(.SD[[1]], na.rm = TRUE),
    ymin_se = mean(.SD[[1]], na.rm = TRUE) - (sd(.SD[[1]], na.rm = TRUE) / sqrt_n),
    ymax_se = mean(.SD[[1]], na.rm = TRUE) + (sd(.SD[[1]], na.rm = TRUE) / sqrt_n),
    cv = (sd(.SD[[1]], na.rm = TRUE) / (mean(.SD[[1]], na.rm = TRUE))) * 100
  ), by = .(tract_label, tractID, nodeID, hemi), .SDcols = scalar]

  return(summary_data)
}

# create summary dfs
# get the average MD for each node for each dataset
PNC_youngest_summary <- make_summary_dfs_age('dti_md', PNC, 8, 12)
PNC_oldest_summary <- make_summary_dfs_age('dti_md', PNC, 18, 22)

HCPD_youngest_summary <- make_summary_dfs_age('dti_md', HCPD, 8, 12)
HCPD_oldest_summary <- make_summary_dfs_age('dti_md', HCPD, 18, 22)

HBN_youngest_summary <- make_summary_dfs_age('dti_md', HBN, 8, 12)
HBN_oldest_summary <- make_summary_dfs_age('dti_md', HBN, 18, 22)
```

 

```{r make cortical endpoint maps for average MD for oldest and youngest}
threshold=0.3

PNC_avgMD_5_youngest <- PNC_youngest_summary %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_scalar) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_scalar, na.rm = T))

PNC_avgMD_5_oldest <- PNC_oldest_summary %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_scalar) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_scalar, na.rm = T))

HCPD_avgMD_5_youngest <- HCPD_youngest_summary %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_scalar) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_scalar, na.rm = T))

HCPD_avgMD_5_oldest <- HCPD_oldest_summary %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_scalar) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_scalar, na.rm = T))

HBN_avgMD_5_youngest <- HBN_youngest_summary %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_scalar) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_scalar, na.rm = T))

HBN_avgMD_5_oldest <- HBN_oldest_summary %>% filter((nodeID < 10 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% 
  mutate(node_position = case_when((nodeID < 10 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, mean_scalar) %>%
  group_by(tractID, node_position, hemi) %>% 
  summarise(mean_peripheral_MD = mean(mean_scalar, na.rm = T))

make_maps_MD("PNC", "5_youngest") # makes [bundle_name]_avgMD_[dataset] for each dataset and bundle. e.g. IFOL_avgMD_PNC
region_all_PNC_youngest <- aggregate_avgMD_maps("PNC")  
lh_by_region_PNC_youngest <- region_all_PNC_youngest[[1]]
rh_by_region_PNC_youngest <- region_all_PNC_youngest[[2]]

make_maps_MD("PNC", "5_oldest") 
region_all_PNC_oldest <- aggregate_avgMD_maps("PNC")  
lh_by_region_PNC_oldest <- region_all_PNC_oldest[[1]]
rh_by_region_PNC_oldest <- region_all_PNC_oldest[[2]]

make_maps_MD("HCPD", "5_youngest")  
region_all_HCPD_youngest <- aggregate_avgMD_maps("HCPD")  
lh_by_region_HCPD_youngest <- region_all_HCPD_youngest[[1]]
rh_by_region_HCPD_youngest <- region_all_HCPD_youngest[[2]]

make_maps_MD("HCPD", "5_oldest") 
region_all_HCPD_oldest <- aggregate_avgMD_maps("HCPD")  
lh_by_region_HCPD_oldest <- region_all_HCPD_oldest[[1]]
rh_by_region_HCPD_oldest <- region_all_HCPD_oldest[[2]]

make_maps_MD("HBN", "5_youngest")  
region_all_HBN_youngest <- aggregate_avgMD_maps("HBN")  
lh_by_region_HBN_youngest <- region_all_HBN_youngest[[1]]
rh_by_region_HBN_youngest <- region_all_HBN_youngest[[2]]

make_maps_MD("HBN", "5_oldest") 
region_all_HBN_oldest <- aggregate_avgMD_maps("HBN")  
lh_by_region_HBN_oldest <- region_all_HBN_oldest[[1]]
rh_by_region_HBN_oldest <- region_all_HBN_oldest[[2]]

 
```

```{r youngest and oldest peripheral MD, fig.height = 5, fig.width = 10}

PNC_youngest_plot <- plot_aggregated_avgMD_maps(lh_by_region_PNC_youngest, rh_by_region_PNC_youngest, "PNC (Ages 8-12)", 0.00069, 0.00084) 
PNC_oldest_plot <- plot_aggregated_avgMD_maps(lh_by_region_PNC_oldest, rh_by_region_PNC_oldest, "PNC (Ages 18-22)", 0.00069, 0.00084) 
 
HCPD_youngest_plot <- plot_aggregated_avgMD_maps(lh_by_region_HCPD_youngest, rh_by_region_HCPD_youngest, "HCP-D (Ages 8-12)", 0.00065, 0.00081) 
HCPD_oldest_plot <- plot_aggregated_avgMD_maps(lh_by_region_HCPD_oldest, rh_by_region_HCPD_oldest, "HCP-D (Ages 18-22)", 0.00065, 0.00081) 

HBN_youngest_plot <- plot_aggregated_avgMD_maps(lh_by_region_HBN_youngest, rh_by_region_HBN_youngest, "HBN (Ages 8-12)", 0.00074, 0.00093) 
HBN_oldest_plot <- plot_aggregated_avgMD_maps(lh_by_region_HBN_oldest, rh_by_region_HBN_oldest, "HBN (Ages 18-22)", 0.00074, 0.00093) 
 
ggsave(paste0(png_dir, "supp_PNC_youngest_peripheralMD.png"), PNC_youngest_plot, height = 5, width = 10, units = "in")
ggsave(paste0(png_dir, "supp_PNC_oldest_peripheralMD.png"), PNC_oldest_plot, height = 5, width = 10, units = "in")

ggsave(paste0(png_dir, "supp_HCPD_youngest_peripheralMD.png"), HCPD_youngest_plot, height = 5, width = 10, units = "in")
ggsave(paste0(png_dir, "supp_HCPD_oldest_peripheralMD.png"), HCPD_oldest_plot, height = 5, width = 10, units = "in")

ggsave(paste0(png_dir, "supp_HBN_youngest_peripheralMD_noACT.png"), HBN_youngest_plot, height = 5, width = 10, units = "in")
ggsave(paste0(png_dir, "supp_HBN_oldest_peripheralMD_noACT.png"), HBN_oldest_plot, height = 5, width = 10, units = "in")
```


Age of maturation: assigning 0 versus maximum age

```{r load dev effects files}
scalar = "dti_md"
HCPD_ageeffects <- read.csv(paste0(output_root, "/", "HCPD", "/tract_profiles/GAM/", scalar, "/HCPD_GAM_dev_measures.csv"))
HBN_ageeffects <- read.csv(paste0(output_root, "/", "HBN", "/tract_profiles/GAM/", scalar, "/HBN_GAM_dev_measures.csv"))
PNC_ageeffects <- read.csv(paste0(output_root, "/", "PNC", "/tract_profiles/GAM/", scalar, "/PNC_GAM_dev_measures.csv"))


 
HCPD_ageeffects_ageMat0 <- read.csv(paste0(output_root, "/", "HCPD", "/tract_profiles/GAM/", scalar, "/HCPD_GAM_dev_measures_ageMat0.csv"))
HBN_ageeffects_ageMat0 <- read.csv(paste0(output_root, "/", "HBN", "/tract_profiles/GAM/", scalar, "/HBN_GAM_dev_measures_ageMat0.csv"))
PNC_ageeffects_ageMat0 <- read.csv(paste0(output_root, "/", "PNC", "/tract_profiles/GAM/", scalar, "/PNC_GAM_dev_measures_ageMat0.csv"))


HCPD_ageeffects_ageMat0.5 <- read.csv(paste0(output_root, "/", "HCPD", "/tract_profiles/GAM/", scalar, "/HCPD_GAM_dev_measures_ageMat0.5.csv"))
HBN_ageeffects_ageMat0.5 <- read.csv(paste0(output_root, "/", "HBN", "/tract_profiles/GAM/", scalar, "/HBN_GAM_dev_measures_ageMat0.5.csv"))
PNC_ageeffects_ageMat0.5 <- read.csv(paste0(output_root, "/", "PNC", "/tract_profiles/GAM/", scalar, "/PNC_GAM_dev_measures_ageMat0.5.csv"))
```


```{r format age effects dfs}
# original
# make a list of the different df names: [dataset]_GAM_ageeffects_[scalar]
datasets <- c("HCPD", "HBN", "PNC")
ageeffect_df_names <- c()
for (dataset in datasets) {
  ageeffect_df_names <- append(ageeffect_df_names, paste0(dataset, "_ageeffects"))
}

# format age effect df's
ageeffect_dfs <- lapply(ageeffect_df_names, format_ageeffect)
names(ageeffect_dfs) <-  ageeffect_df_names

# age mat 0
ageeffect_df_names <- c()
for (dataset in datasets) {
  ageeffect_df_names <- append(ageeffect_df_names, paste0(dataset, "_ageeffects_ageMat0"))
}

# format age effect df's
ageeffect_dfs_ageMat0 <- lapply(ageeffect_df_names, format_ageeffect)
names(ageeffect_dfs_ageMat0) <-  ageeffect_df_names 

# age mat 0.5
ageeffect_df_names <- c()
for (dataset in datasets) {
  ageeffect_df_names <- append(ageeffect_df_names, paste0(dataset, "_ageeffects_ageMat0.5"))
}

# format age effect df's
ageeffect_dfs_ageMat0.5 <- lapply(ageeffect_df_names, format_ageeffect)
names(ageeffect_dfs_ageMat0.5) <-  ageeffect_df_names 

length(which(ageeffect_dfs$HCPD_ageeffects == 0))

ageeffect_dfs$HCPD_ageeffects[which(ageeffect_dfs$HCPD_ageeffects$smooth.decrease.offset == 0),]

length(which(ageeffect_dfs$PNC_ageeffects$smooth.decrease.offset == max(ageeffect_dfs$PNC_ageeffects$smooth.decrease.offset, na.rm=T))) # considered 1000 immature. probably aliasing nodes that are maturing at the maximum age.

length(which(ageeffect_dfs_ageMat0.5$PNC_ageeffects$smooth.decrease.offset == max(ageeffect_dfs_ageMat0.5$PNC_ageeffects$smooth.decrease.offset, na.rm=T)))  # 996


HBN_0.5_immature <- ageeffect_dfs_ageMat0.5$HBN_ageeffects[which(ageeffect_dfs_ageMat0.5$HBN_ageeffects$smooth.decrease.offset == max(ageeffect_dfs_ageMat0.5$HBN_ageeffects$smooth.decrease.offset, na.rm=T)),]
HBN_0_immature <- ageeffect_dfs_ageMat0$HBN_ageeffects_ageMat0[which(ageeffect_dfs_ageMat0$HBN_ageeffects$smooth.decrease.offset == 0),]

setdiff(HBN_0.5_immature$tract_node, HBN_0_immature$tract_node)
setdiff(HBN_0_immature$tract_node, HBN_0.5_immature$tract_node)

ageeffect_dfs_ageMat0.5$HCPD_ageeffects %>% filter(tract_node %in% c("Left_Superior_Longitudinal_85",  "Left_Vertical_Occipital_84",     "Right_Superior_Longitudinal_32", "Left_Corticospinal_55", "Left_Corticospinal_80"))

ageeffect_dfs_ageMat0$HCPD_ageeffects %>% filter(tract_node %in% c("Left_Superior_Longitudinal_85",  "Left_Vertical_Occipital_84",     "Right_Superior_Longitudinal_32", "Left_Corticospinal_55", "Left_Corticospinal_80"))


length(which(ageeffect_dfs_ageMat0.5$HCPD_ageeffects$smooth.decrease.offset == 0))

length(which(ageeffect_dfs_ageMat0$HCPD_ageeffects$smooth.decrease.offset == 0)) # 995 immature

 
cbind(which(ageeffect_dfs_ageMat0$HCPD_ageeffects == 0), which(ageeffect_dfs$HCPD_ageeffects == max(ageeffect_dfs$HCPD_ageeffects$smooth.decrease.offset, na.rm=T)))
```



work for double checking why seeing differneces 
```{r make cortical endpoint maps for age of maturation}
threshold=0.3

HCPD_deveffects_10_agemat <- ageeffect.fdr_dfs$HCPD_ageeffects %>% filter((nodeID < 15 & nodeID > 4) | (nodeID < 95 & nodeID > 84)) %>% mutate(node_position = case_when((nodeID < 15 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 84) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, smooth.peak.change, smooth.decrease.offset, smooth.last.change, smooth.slowing.onset) %>%
  group_by(tractID, node_position, hemi) %>% summarise(mean_peak_change = mean(smooth.peak.change, na.rm = T),
                              mean_ageeffect = mean(smooth.decrease.offset, na.rm = T), # mean_ageeffect = mean_age_mat
                              mean_last_change = mean(smooth.last.change, na.rm = T),
                              mean_dev_slowing = mean(smooth.slowing.onset, na.rm = T))

HBN_deveffects_10_agemat <- ageeffect.fdr_dfs$HBN_ageeffects %>% filter((nodeID < 15 & nodeID > 4) | (nodeID < 95 & nodeID > 84)) %>% mutate(node_position = case_when((nodeID < 15 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 84) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, smooth.peak.change, smooth.decrease.offset, smooth.last.change, smooth.slowing.onset) %>%
  group_by(tractID, node_position, hemi) %>% summarise(mean_peak_change = mean(smooth.peak.change, na.rm = T),
                              mean_ageeffect = mean(smooth.decrease.offset, na.rm = T),
                              mean_last_change = mean(smooth.last.change, na.rm = T),
                              mean_dev_slowing = mean(smooth.slowing.onset, na.rm = T))
       
 
PNC_deveffects_10_agemat <- ageeffect.fdr_dfs$PNC_ageeffects %>% filter((nodeID < 15 & nodeID > 4) | (nodeID < 95 & nodeID > 84)) %>% mutate(node_position = case_when((nodeID < 15 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 84) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, smooth.peak.change, smooth.decrease.offset, smooth.last.change, smooth.slowing.onset) %>%
  group_by(tractID, node_position, hemi) %>% summarise(mean_peak_change = mean(smooth.peak.change, na.rm = T),
                              mean_ageeffect = mean(smooth.decrease.offset, na.rm = T),
                              mean_last_change = mean(smooth.last.change, na.rm = T),
                              mean_dev_slowing = mean(smooth.slowing.onset, na.rm = T))
  

make_maps("HCPD", "10_agemat") # makes [bundle_name]_deveffect_[dataset] for each dataset and bundle. e.g. IFOL_deveffect_HCPD
make_maps("HBN", "10_agemat")
make_maps("PNC", "10_agemat")

```



may delete
```{r make cortical endpoint maps for age of peak}
HCPD_deveffects_5_agemat <- ageeffect.fdr_dfs$HCPD_ageeffects %>% filter((nodeID < 11 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% mutate(node_position = case_when((nodeID < 11 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, smooth.peak.change, smooth.decrease.offset, smooth.last.change, smooth.slowing.onset) %>%
  group_by(tractID, node_position, hemi) %>% summarise(mean_agepeak = mean(smooth.peak.change, na.rm = T),
                              mean_agemat = mean(smooth.decrease.offset, na.rm = T),                         
                              mean_last_change = mean(smooth.last.change, na.rm = T),
                              mean_ageeffect = mean(smooth.slowing.onset, na.rm = T))

HBN_deveffects_5_agemat <- ageeffect.fdr_dfs$HBN_ageeffects %>% filter((nodeID < 11 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% mutate(node_position = case_when((nodeID < 11 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, smooth.peak.change, smooth.decrease.offset, smooth.last.change, smooth.slowing.onset) %>%
  group_by(tractID, node_position, hemi) %>% summarise(mean_agepeak = mean(smooth.peak.change, na.rm = T),
                                                       mean_agemat = mean(smooth.decrease.offset, na.rm = T),     
                              mean_last_change = mean(smooth.last.change, na.rm = T),
                              mean_ageeffect = mean(smooth.slowing.onset, na.rm = T))
       
 
PNC_deveffects_5_agemat <- ageeffect.fdr_dfs$PNC_ageeffects %>% filter((nodeID < 11 & nodeID > 4) | (nodeID < 95 & nodeID > 89)) %>% mutate(node_position = case_when((nodeID < 11 & nodeID > 4) ~ "end1", (nodeID < 95 & nodeID > 89) ~ "end2")) %>%
  select(tract_label, tractID, nodeID, node_position, hemi, smooth.peak.change, smooth.decrease.offset, smooth.last.change, smooth.slowing.onset) %>%
  group_by(tractID, node_position, hemi) %>% summarise(mean_agepeak = mean(smooth.peak.change, na.rm = T),
                                                       mean_agemat = mean(smooth.decrease.offset, na.rm = T),     
                              mean_last_change = mean(smooth.last.change, na.rm = T),
                              mean_ageeffect = mean(smooth.slowing.onset, na.rm = T))
  
 
make_maps("HCPD", "5_agemat") # makes [bundle_name]_deveffect_[dataset] for each dataset and bundle. e.g. IFOL_deveffect_HCPD
make_maps("HBN", "5_agemat")
make_maps("PNC", "5_agemat")

```



# plot CV
```{r run dti md cv plotting}
variance_measure = "cv"
dti_md_cv_plots <- lapply(unique(HCPD$tract_label), plot_cv, scalar = "dti_md", variance_measure = variance_measure, 
                                color1 = color1, color2 = color2, color3 = color3, ylim1 = 2, ylim2 = 23, ylim3 = 2, ylim4 = 23, clipEnds = 5)
names(dti_md_cv_plots) <- unique(HCPD$tract_label)
```

```{r dti md tracts cv callosum, fig.height = 10, fig.width = 20}
dti_md_callosum_final <- arrange_callosum_var_plots(dti_md_cv_plots)
title.grob <- textGrob("Coefficient of Variance for Mean Diffusivity Along Tracts", 
                   gp=gpar(col="black", fontsize=20, face = "italic"), hjust = 0.5)
y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(dti_md_callosum_final, left = y.grob, top = title.grob))
ggsave(paste0(png_dir, "supp_callosum_cv.png"), grid.arrange(arrangeGrob(dti_md_callosum_final, left = y.grob, top = title.grob)), height = 10, width = 20, units = "in")
```
 
```{r dti md tracts cv association, fig.height = 10, fig.width = 20}
dti_md_association_final <- arrange_all_association_var_plots(dti_md_cv_plots)
title.grob <- textGrob("Coefficient of Variance for Mean Diffusivity Along Tracts", 
                   gp=gpar(col="black", fontsize=20, face = "italic"), hjust = 0.5)
y.grob <- textGrob("Mean Diffusivity", 
                   gp=gpar(col="black", fontsize=20), rot=90)
grid.arrange(arrangeGrob(dti_md_association_final, left = y.grob, top = title.grob))
ggsave(paste0(png_dir, "supp_association_cv.png"), grid.arrange(arrangeGrob(dti_md_association_final, left = y.grob, top = title.grob)), height = 10, width = 20, units = "in")
```
  
  
  
  
# Threshold testing to tract-to-cortex maps (10%, 30%, 50%)
```{r function for plotting maps}
# load my colormap :)
colormap_file <- sprintf("%1$s/code/tract_profiles/colormaps/aquamarine.json", proj_root)
colormap <- fromJSON(paste(readLines(colormap_file), collapse=""))
aquamarine <- colorRampPalette(colormap)(15)
 
plot_maps <- function(map, hemi, threshold) {
  map <- map %>% mutate(thresh_probability = ifelse(probability < threshold, NA, probability)) 
  
  if(hemi == "left") {
    cortical_pos <- c("left lateral", "left medial")
  } else {
    cortical_pos <- c("right lateral", "right medial")
  } 
  if(all(is.na(map$thresh_probability))) {
     plot <- ggplot() + 
      geom_brain(data = map, atlas = glasser, 
                 mapping = aes(fill = "grey92"),  
                 show.legend = FALSE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos)) +
      scale_fill_manual(values = "grey92") +  
      theme_void() +
      theme(legend.position = "none",
            legend.key.height = unit(1, 'cm'),
            legend.key.width = unit(2.3, 'cm'),
            legend.margin=margin(0,0,0,0),
            legend.text = element_text(size=24),
            legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
            plot.title = element_text(size = 20, hjust = 0.5)) 
     
  } else { 
    plot <- ggplot() + 
      geom_brain(data = map, atlas= glasser, 
                 mapping=aes(fill=thresh_probability), 
                 show.legend=TRUE, 
                 hemi = hemi,
                 position = position_brain(cortical_pos)) + 
      scale_fill_gradientn(colors = aquamarine, na.value = "grey92", limits = c(threshold, 1)) +  
      theme_void() +
      theme(legend.position = "none",
            legend.key.height = unit(1, 'cm'),
            legend.key.width = unit(2.3, 'cm'),
            legend.margin=margin(0,0,0,0),
            legend.text = element_text(size=24),
            legend.title = element_blank(),
            plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
            plot.title = element_text(size=20, hjust = 0.5)) 
  }
  
  
  return(plot)
}


wrapper_plot_maps <- function(threshold, lh_map_list, rh_map_list) {
  # plot individual maps
  lh_plots <- lapply(lh_map_list, plot_maps, hemi = "left", threshold = threshold)
  rh_plots <- lapply(rh_map_list, plot_maps, hemi = "right", threshold = threshold)
  # arrange maps together  
  ARC_plots <- ggarrange(lh_plots$LeftArcuate, rh_plots$RightArcuate, ncol=1, nrow = 2)
  ARC_final <- annotate_figure(ARC_plots, top = text_grob("Arcuate Fasciculus", 
                 color = "black", size = 20))
  
  CST_plots <- ggarrange(lh_plots$LeftCorticospinal, rh_plots$RightCorticospinal, ncol=1, nrow = 2)
  CST_final <- annotate_figure(CST_plots, top = text_grob("Corticospinal Tract", 
                 color = "black", size = 20))
  
  IFO_plots <- ggarrange(lh_plots$LeftInferiorFrontooccipital, rh_plots$RightInferiorFrontooccipital, ncol=1, nrow = 2)
  IFO_final <- annotate_figure(IFO_plots, top = text_grob("Inferior Fronto-occipital Fasciculus", 
                 color = "black", size = 20))
  
  ILF_plots <- ggarrange(lh_plots$LeftInferiorLongitudinal, rh_plots$RightInferiorLongitudinal, ncol=1, nrow = 2)
  ILF_final <- annotate_figure(ILF_plots, top = text_grob("Inferior Longitudinal Fasciculus", 
                 color = "black", size = 20))
  
  pARC_plots <- ggarrange(lh_plots$pARCL, rh_plots$pARCR, ncol=1, nrow = 2)
  pARC_final <- annotate_figure(pARC_plots, top = text_grob("Posterior Arcuate Fasciculus", 
                 color = "black", size = 20))
  
  SLF_plots <- ggarrange(lh_plots$LeftSuperiorLongitudinal, rh_plots$RightSuperiorLongitudinal, ncol=1, nrow = 2)
  SLF_final <- annotate_figure(SLF_plots, top = text_grob("Superior Longitudinal Fasciculus", 
                 color = "black", size = 20))
  
  UNC_plots <- ggarrange(lh_plots$LeftUncinate, rh_plots$RightUncinate, ncol=1, nrow = 2)
  UNC_final <- annotate_figure(UNC_plots, top = text_grob("Uncinate Fasciculus", 
                 color = "black", size = 20))
  
  VOF_plots <- ggarrange(lh_plots$LeftVerticalOccipital, rh_plots$RightVerticalOccipital, ncol=1, nrow = 2)
  VOF_final <- annotate_figure(VOF_plots, top = text_grob("Vertical Occipital Fasciculus", 
                 color = "black", size = 20))
  # stitch it all together
  legend.plot <- ggplot() + 
        geom_brain(data = lh_map_list$LeftArcuate  %>% mutate(thresh_probability = ifelse(probability < threshold, NA, probability)) , atlas= glasser, 
                   mapping=aes(fill=thresh_probability), 
                   show.legend=TRUE, 
                   hemi = "left") + 
        scale_fill_gradientn(colors = aquamarine, na.value = "grey92", limits = c(threshold, 1)) +  
        theme_void() +
        theme(legend.position = "bottom",
              legend.key.height = unit(1, 'cm'),
              legend.key.width = unit(2.3, 'cm'),
              legend.margin=margin(20,0,10,0),
              legend.text = element_text(size=20),
              legend.title = element_blank(),
              plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"),
              plot.title = element_text(size=20, hjust = 0.5)) 
  legend <- get_legend(legend.plot)
  maps_plot <- ggarrange(ARC_final, CST_final, IFO_final, ILF_final, pARC_final, SLF_final, UNC_final, VOF_final, ncol= 4, nrow = 2, legend.grob = legend, legend = "bottom")
  percent <- paste0(threshold * 100, "%")
  x.grob <- textGrob(sprintf("Population Probability (Threshold = %1$s)", percent), 
                       gp=gpar(col="black", fontfontsize=20))
  # save out
  #ggsave(sprintf("/Users/audluo/PennLINC/luowm_local/output/tract_profiles_testing/HCPD/tract_to_region_maps_%1$s.png", threshold),
        # grid.arrange(arrangeGrob(maps_plot, bottom = x.grob)), height = 14, width = 14, units = "in")
  return(grid.arrange(arrangeGrob(maps_plot, bottom = x.grob)))
}


```

 

```{r display thresholded maps, fig.height = 14, fig.width = 14}
thresholded_plots <- lapply(c(0.1, 0.3, 0.5), wrapper_plot_maps, lh_map_list = lh_maps_HBN, rh_map_list = rh_maps_HBN) # glasser in ggseg is missing 10pp_L so there will always be some errors -_-
 
grid.newpage()       
grid.draw(thresholded_plots[[1]])
grid.newpage()       
grid.draw(thresholded_plots[[2]])
grid.newpage()       
grid.draw(thresholded_plots[[3]])
 
```